<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>SOSã‚¢ãƒ©ãƒ¼ãƒˆ | å—ä¿¡ãƒ»é€šçŸ¥ãƒ»è©³ç´°</title>
<style>
  :root{
    --gap:6px; --radius:10px; --bg:#f7f7f8; --panel:#ffffff; --text:#222;
    --muted:#667085; --line:#e5e7eb; --accent:#2563eb; --danger:#ef4444; --danger-2:#dc2626; --ok:#16a34a;
    --sidebar:#0f172a; --sidebarText:#e2e8f0;
    --sidebarW:160px; --wrapW:1160px; --shadow:0 8px 24px rgba(16,24,40,.08);
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:13px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue","Noto Sans JP","Yu Gothic UI",Meiryo,sans-serif;overflow:hidden;}

  /* Sidebarï¼ˆå…±é€šï¼‰ */
  .sidebar{position:fixed; inset:0 auto 0 0; width:var(--sidebarW); background:var(--sidebar); color:var(--sidebarText); display:flex; flex-direction:column; padding:14px 10px; gap:12px;}
  .side-logo{display:flex; align-items:center; justify-content:center; padding:8px 6px;}
  .side-logo img{width:86%; height:auto; object-fit:contain}
  .side-group{margin-bottom:8px;}
  .side-sec{padding:4px 6px 0; font-weight:700; font-size:12px; opacity:.9;}
  .side-list{list-style:none;margin:0;padding:4px}
  .side-list a{display:flex; align-items:center; gap:6px; padding:6px 8px; border-radius:8px; cursor:pointer; font-size:12px; color:var(--sidebarText); text-decoration:none}
  .side-list a:hover{background:rgba(255,255,255,.06)}
  .side-list a.active{background:rgba(255,255,255,.12)}

  /* Main */
  .main{margin-left:var(--sidebarW); height:100vh; display:flex; flex-direction:column;}
  header{flex:0 0 auto; background:rgba(247,247,248,0.9); backdrop-filter:saturate(1.2) blur(6px); border-bottom:1px solid var(--line);}
  .wrap{max-width:var(--wrapW); margin:0 auto; padding:6px 10px;}
  .head-top{display:grid; grid-template-columns: 1fr auto auto; align-items:center; column-gap:12px; row-gap:6px;}
  .title{font-size:16px; font-weight:700; margin:0;}
  .head-right{display:flex; align-items:center; gap:8px; flex-wrap:wrap; justify-self:end;}
  .badge{display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; background:#fff; border:1px solid var(--line); font-size:12px}
  .role{font-weight:700}
  .login{display:flex; align-items:center; gap:6px;}
  .login select{border:1px solid var(--line); border-radius:8px; padding:6px 8px; background:#fff; font-size:12px}
  .print-btn{background:var(--accent); color:#fff; border:1px solid var(--accent); border-radius:8px; padding:6px 10px; font-size:12px}
  .logout-btn{background:#fff; color:#111; border:1px solid var(--line); border-radius:8px; padding:6px 10px; font-size:12px; cursor:pointer}
  .logout-btn:hover{background:#f8fafc}

  /* Toolbar */
  .toolbar{display:flex; gap:8px; align-items:center; flex-wrap:wrap; padding:6px 0 2px 0; font-size:12px}
  .toolbar input,.toolbar select{border:1px solid var(--line); border-radius:8px; padding:6px 8px; background:#fff;}
  .toolbar .spacer{flex:1 1 auto}
  .btn{border:1px solid var(--line); background:#fff; border-radius:8px; padding:8px 12px; font-size:12px; cursor:pointer}
  .btn.primary{background:var(--accent); color:#fff; border-color:var(--accent)}
  .btn.danger{background:var(--danger); color:#fff; border-color:var(--danger-2)}
  .pill{border-radius:999px; border:1px solid var(--line); padding:2px 6px; font-size:11px; background:#fff;}
  .link{color:#1d4ed8; text-decoration:underline; cursor:pointer; background:none; border:none; padding:0; font:inherit;}

  /* Layout content */
  .content{flex:1 1 auto; display:flex; flex-direction:column;}
  .panel{flex:1 1 auto; background:#fff; border:1px solid var(--line); border-radius:0; margin:0; width:100%; max-width:none; display:flex; overflow:hidden;}
  .split{display:grid; grid-template-columns: 360px 1fr; gap:0; width:100%; height:100%;}
  .left{border-right:1px solid var(--line); display:flex; flex-direction:column; min-width:280px;}
  .right{display:flex; flex-direction:column; min-width:0;}

  /* SOS list */
  .list-head{padding:10px; border-bottom:1px solid var(--line); display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
  .list{flex:1 1 auto; overflow:auto;}
  .srow{display:grid; grid-template-columns: 36px 1fr auto; gap:10px; padding:10px; border-bottom:1px solid #f1f5f9; cursor:pointer;}
  .srow:hover{background:#f8fafc}
  .srow.active{background:#fef2f2}
  .icon{width:36px; height:36px; border-radius:999px; background:#fee2e2; color:#b91c1c; display:flex; align-items:center; justify-content:center; font-weight:900;}
  .sname{font-weight:800}
  .smeta{font-size:12px; color:#475569}
  .sstatus{font-size:12px; white-space:nowrap;}
  .status-open{color:#b91c1c; font-weight:800}
  .status-handling{color:#b45309; font-weight:800}
  .status-closed{color:#16a34a; font-weight:800}

  /* Detail */
  .detail-head{padding:12px; border-bottom:1px solid var(--line); display:flex; align-items:center; justify-content:space-between;}
  .detail-body{flex:1 1 auto; overflow:auto; padding:12px; background:#f8fafc;}
  .box{border:1px solid var(--line); border-radius:12px; background:#fff; padding:12px; margin-bottom:10px;}
  .grid{display:grid; grid-template-columns:140px 1fr 140px 1fr; gap:10px 12px; align-items:center;}
  .ilabel{color:#475569; font-size:12px;}
  .ivalue{font-size:13px;}
  .map{height:280px; border-radius:12px; background:
      repeating-linear-gradient(45deg,#e5e7eb,#e5e7eb 10px,#f8fafc 10px,#f8fafc 20px);
      border:1px solid var(--line); display:flex; align-items:center; justify-content:center; color:#64748b; font-size:12px;}
  .ops{display:flex; gap:8px; flex-wrap:wrap;}

  /* ===== Global SOS Notifier (å…±é€šãƒãƒŠãƒ¼) ===== */
  .sos-banner{position:fixed; inset:0 0 auto 0; height:64px; display:none; align-items:center; justify-content:center;
    background:linear-gradient(90deg,#7f1d1d,#dc2626,#b91c1c); color:#fff; z-index:999999; box-shadow:0 4px 20px rgba(0,0,0,.35);}
  .sos-banner .inner{display:flex; align-items:center; gap:12px; font-weight:900; letter-spacing:.05em;}
  .sos-banner .msg{font-size:16px;}
  .sos-banner .btn{padding:6px 10px; border-radius:8px; border:1px solid rgba(255,255,255,.6); background:rgba(255,255,255,.12); color:#fff; cursor:pointer;}
  .flash{animation:flash 1s infinite alternate ease-in-out;}
  @keyframes flash { from {opacity:1; transform:scale(1);} to {opacity:.6; transform:scale(1.02);} }
  .shake{animation:shake .5s infinite;}
  @keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-3px)} 75%{transform:translateX(3px)} }

  /* ===== Cast Profile Modal ===== */
  .modal{position:fixed; inset:0; background:rgba(15,23,42,.45); display:none; align-items:center; justify-content:center; z-index:9999}
  .modal-content{background:#fff; border:1px solid #eef2f7; box-shadow:var(--shadow); width:96%; max-width:880px; max-height:92vh; border-radius:16px; display:flex; flex-direction:column; overflow:hidden;}
  .modal-header{display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid var(--line);}
  .modal-title{font-weight:800; font-size:16px;}
  .m-body{flex:1 1 auto; overflow:auto; padding:12px; background:#fafafa;}
  .cast-grid{display:grid; grid-template-columns: 220px 1fr; gap:12px;}
  .cast-card{border:1px solid var(--line); border-radius:12px; background:#fff; padding:10px;}
  .avatar{width:100%; aspect-ratio:3/4; border-radius:10px; background:#e5e7eb; display:flex; align-items:center; justify-content:center; color:#64748b;}
  .cast-info{display:grid; grid-template-columns:140px 1fr 140px 1fr; gap:10px 12px; align-items:center;}
</style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="side-logo"><a href="dashboard.html" aria-label="Dashboard Top"><img src="img/logo4.png" alt="LOGO"/></a></div>

    <div class="side-group">
      <div class="side-sec">é‹ç”¨æ©Ÿèƒ½</div>
      <ul class="side-list">
        <li><a href="dashboard.html">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a></li>
        <li><a href="schedule.html">ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</a></li>
      </ul>
    </div>

    <div class="side-group">
      <div class="side-sec">ç®¡ç†æ©Ÿèƒ½</div>
      <ul class="side-list">
        <li><a href="cast.html">ã‚­ãƒ£ã‚¹ãƒˆç®¡ç†</a></li>
        <li><a href="shops.html">åº—èˆ—ç®¡ç†</a></li>
      </ul>
    </div>

    <div class="side-group">
      <div class="side-sec">é€šä¿¡æ©Ÿèƒ½</div>
      <ul class="side-list">
        <li><a href="chat.html">ãƒãƒ£ãƒƒãƒˆï¼ˆLINEï¼‰</a></li>
        <li><a class="active" href="sos.html">SOSã‚¢ãƒ©ãƒ¼ãƒˆ</a></li>
      </ul>
    </div>

    <div class="side-group">
      <div class="side-sec">è¨­å®šæ©Ÿèƒ½</div>
      <ul class="side-list">
        <li><a href="request.html">ç”³è«‹ãƒ»æ‰¿èª</a></li>
        <li><a href="setting.html">è¨­å®š</a></li>
      </ul>
    </div>
  </aside>

  <!-- ===== Global SOS Notifierï¼ˆå…¨ãƒšãƒ¼ã‚¸å…±é€šãƒãƒŠãƒ¼ï¼‰ ===== -->
  <div id="sosBanner" class="sos-banner flash shake" role="alert" aria-live="assertive">
    <div class="inner">
      <span style="font-size:20px;">ğŸš¨ SOS</span>
      <span class="msg" id="sosBannerMsg">ã‚­ãƒ£ã‚¹ãƒˆã‹ã‚‰SOSã‚’å—ä¿¡ï¼è‡³æ€¥ç¢ºèªã—ã¦ãã ã•ã„ï¼</span>
      <button class="btn" id="sosOpenBtn">é–‹ã</button>
      <button class="btn" id="sosMuteBtn">åœæ­¢</button>
    </div>
  </div>

  <!-- Main -->
  <div class="main">
    <header>
      <div class="wrap">
        <div class="head-top">
          <h1 class="title">SOSã‚¢ãƒ©ãƒ¼ãƒˆ</h1>
          <div></div>
          <div class="head-right">
            <span class="badge"><span class="label">ãƒ­ãƒ¼ãƒ«</span> <span class="role" id="roleBadge">ç®¡ç†è€…</span></span>
            <div class="login">
              <label for="loginSelect" class="label">ãƒ­ã‚°ã‚¤ãƒ³:</label>
              <select id="loginSelect">
                <option value="ADMIN:admin">ç®¡ç†è€…ï¼ˆadminï¼‰</option>
                <option value="STAFF:tanaka">æ‹…å½“è€…ï¼ˆç”°ä¸­ï¼‰</option>
                <option value="STAFF:sato">æ‹…å½“è€…ï¼ˆä½è—¤ï¼‰</option>
                <option value="STAFF:suzuki">æ‹…å½“è€…ï¼ˆéˆ´æœ¨ï¼‰</option>
              </select>
            </div>
            <button class="logout-btn" onclick="location.href='index.html'">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            <button class="print-btn" onclick="window.print()">å°åˆ·</button>
          </div>
        </div>

        <div class="toolbar">
          <input id="q" type="text" placeholder="ã‚­ãƒ£ã‚¹ãƒˆåãƒ»ãƒ¡ãƒ¢ã§æ¤œç´¢" style="min-width:240px">
          <select id="ownerFilter">
            <option value="">æ‹…å½“è€…ï¼ˆã™ã¹ã¦ï¼‰</option>
            <option value="tanaka">ç”°ä¸­</option>
            <option value="sato">ä½è—¤</option>
            <option value="suzuki">éˆ´æœ¨</option>
          </select>
          <select id="statusFilter">
            <option value="">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆã™ã¹ã¦ï¼‰</option>
            <option value="OPEN">æœªå¯¾å¿œ</option>
            <option value="HANDLING">å¯¾å¿œä¸­</option>
            <option value="CLOSED">ã‚¯ãƒ­ãƒ¼ã‚º</option>
          </select>
          <div class="spacer"></div>
          <button class="btn danger" id="testSOS">ãƒ†ã‚¹ãƒˆSOSç™ºå ±</button>
        </div>
      </div>
    </header>

    <div class="content">
      <div class="panel">
        <div class="split">
          <!-- å·¦ï¼šSOSä¸€è¦§ -->
          <aside class="left">
            <div class="list-head">
              <span class="pill">ç·ä»¶æ•° <b id="totalCnt">0</b></span>
              <span class="pill" style="border-color:#fecaca;background:#fff5f5;">æœªå¯¾å¿œ <b id="openCnt">0</b></span>
              <span class="pill">å¯¾å¿œä¸­ <b id="handlingCnt">0</b></span>
              <span class="pill" style="border-color:#bbf7d0;background:#f0fdf4;">ã‚¯ãƒ­ãƒ¼ã‚º <b id="closedCnt">0</b></span>
            </div>
            <div id="sosList" class="list"></div>
          </aside>

          <!-- å³ï¼šè©³ç´° -->
          <section class="right">
            <div class="detail-head">
              <div>
                <div class="sname" id="detailName">æœªé¸æŠ</div>
                <div class="smeta" id="detailMeta">å·¦ã®ä¸€è¦§ã‹ã‚‰é¸æŠã—ã¦ãã ã•ã„</div>
              </div>
              <div class="ops">
                <button class="btn" id="btnHandling">å¯¾å¿œä¸­ã«ã™ã‚‹</button>
                <button class="btn" id="btnClose">ã‚¯ãƒ­ãƒ¼ã‚º</button>
                <a id="btnMap" class="btn primary" href="#" target="_blank" rel="noopener">Googleãƒãƒƒãƒ—</a>
              </div>
            </div>
            <div class="detail-body">
              <div class="box">
                <div class="grid">
                  <div class="ilabel">ã‚­ãƒ£ã‚¹ãƒˆå</div><div class="ivalue" id="dCast"></div>
                  <div class="ilabel">æ‹…å½“è€…</div><div class="ivalue" id="dOwner"></div>
                  <div class="ilabel">ç™ºå ±æ™‚åˆ»</div><div class="ivalue" id="dTime"></div>
                  <div class="ilabel">çŠ¶æ…‹</div><div class="ivalue" id="dStatus"></div>
                </div>
              </div>
              <div class="box">
                <div class="ilabel" style="font-weight:700">ãƒ†ã‚­ã‚¹ãƒˆ</div>
                <div class="ivalue" id="dText" style="white-space:pre-wrap; margin-top:6px;"></div>
              </div>
              <div class="box">
                <div class="ilabel" style="font-weight:700">ä½ç½®æƒ…å ±</div>
                <div class="map" id="dMap">Map Placeholderï¼ˆå®Ÿè£…æ™‚ã¯åœ°å›³SDKã‚’è¡¨ç¤ºï¼‰</div>
                <div class="smeta" id="dLatLng" style="margin-top:6px;"></div>
              </div>
            </div>
          </section>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== Cast Profile Modal ===== -->
  <div id="castModal" class="modal" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="castTitle">
      <div class="modal-header">
        <div class="modal-title" id="castTitle">ã‚­ãƒ£ã‚¹ãƒˆè©³ç´°</div>
        <div class="modal-actions">
          <button class="btn" onclick="closeCastModal()">é–‰ã˜ã‚‹</button>
        </div>
      </div>
      <div class="m-body">
        <div class="cast-grid">
          <div class="cast-card">
            <div id="castAvatar" class="avatar">No Image</div>
          </div>
          <div class="cast-card">
            <div class="cast-info">
              <div class="ilabel">åå‰</div><div class="ivalue" id="cName"></div>
              <div class="ilabel">å¹´é½¢</div><div class="ivalue" id="cAge"></div>
              <div class="ilabel">é›»è©±</div><div class="ivalue" id="cPhone"></div>
              <div class="ilabel">LINE</div><div class="ivalue" id="cLine"></div>
              <div class="ilabel">æ‹…å½“è€…</div><div class="ivalue" id="cOwner"></div>
              <div class="ilabel">ã‚¿ã‚°</div><div class="ivalue" id="cTags"></div>
              <div class="ilabel">ãƒ¡ãƒ¢</div><div class="ivalue" id="cMemo" style="white-space:pre-wrap;"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/* ===== ãƒ‡ãƒ¢ç”¨ãƒ‡ãƒ¼ã‚¿ ===== */
const STAFFS = { tanaka:{id:'tanaka',name:'ç”°ä¸­'}, sato:{id:'sato',name:'ä½è—¤'}, suzuki:{id:'suzuki',name:'éˆ´æœ¨'} };
const CAST_NAMES  = ["ã‚ã„","ã•ãã‚‰","ã¿ã‚†","ãˆã‚Šã‹","ã‚ŠãŠ","ã²ã‹ã‚Š","ã‚†ã„","ãªãª","ã“ã“","ã‚Œã„","ã—ãŠã‚Š","ã‚Šã‹","ã¿ãŠ","ã‚†ã‹","ãªã¤","ã—ãšã","ã¿ã","ã‚ã‚„","ã‚†ã†","ã¾ã“"];
function pad2(n){return String(n).padStart(2,'0')}
function fmtDT(d){return `${d.getFullYear()}/${pad2(d.getMonth()+1)}/${pad2(d.getDate())} ${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`}
function rand(min,max){return Math.floor(Math.random()*(max-min+1))+min}
function pick(arr){return arr[Math.floor(Math.random()*arr.length)]}

/* ãƒ€ãƒŸãƒ¼ã®ã‚­ãƒ£ã‚¹ãƒˆè©³ç´°ãƒã‚¹ã‚¿ */
const CAST_MASTER = {};
for(const name of CAST_NAMES){
  const age = rand(18,32);
  const phone = `080-${rand(1000,9999)}-${rand(1000,9999)}`;
  const line = `${name}_line`;
  const owner = pick(Object.keys(STAFFS));
  const tags = pick([["é£²é…’OK","é€è¿ã‚ã‚Š"],["é£²é…’NG","é€è¿ãªã—"],["é£²é…’OK","é€è¿ãªã—"],["é£²é…’NG","é€è¿ã‚ã‚Š"]]);
  const memo = pick(["","","",""]);
  const img = null; // ç”»åƒãƒ‘ã‚¹ãŒã‚ã‚Œã°æŒ‡å®šï¼ˆä¾‹: `img/cast1.jpg`ï¼‰
  CAST_MASTER[name] = {name, age, phone, line, owner, tags, memo, img};
}

/* ===== çŠ¶æ…‹ ===== */
let state = {
  login:{role:"ADMIN", user:"admin"},
  filter:{q:"", owner:"", status:""},
  activeId:null,
  list:[] // {id, cast, owner, text, lat, lng, at, status}
};

/* ===== ãƒ­ã‚°ã‚¤ãƒ³åˆ‡æ›¿ ===== */
const loginSelect = document.getElementById('loginSelect');
loginSelect.addEventListener('change', ()=>{
  const [role,user]=loginSelect.value.split(':');
  state.login={role,user};
  document.getElementById('roleBadge').textContent=(role==="ADMIN"?"ç®¡ç†è€…":"æ‹…å½“è€…");
  renderList();
  applyDetailPermission();
});

/* ===== ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ ãƒ•ã‚£ãƒ«ã‚¿ ===== */
q.addEventListener('input', ()=>{ state.filter.q=q.value.trim(); renderList(); });
ownerFilter.addEventListener('change', ()=>{ state.filter.owner=ownerFilter.value; renderList(); });
statusFilter.addEventListener('change', ()=>{ state.filter.status=statusFilter.value; renderList(); });

/* ===== ãƒªã‚¹ãƒˆæç”» ===== */
function filtered(){
  let arr = state.list.slice().sort((a,b)=> b.at-a.at);
  if(state.login.role==="STAFF") arr = arr.filter(x=>x.owner===state.login.user);
  if(state.filter.owner) arr = arr.filter(x=>x.owner===state.filter.owner);
  if(state.filter.status) arr = arr.filter(x=>x.status===state.filter.status);
  const qk=(state.filter.q||"").toLowerCase().normalize("NFKC");
  if(qk) arr = arr.filter(x=> (x.cast + " " + x.text).toLowerCase().normalize("NFKC").includes(qk));
  return arr;
}
function renderList(){
  const list = filtered();
  document.getElementById('totalCnt').textContent = list.length;
  document.getElementById('openCnt').textContent = list.filter(x=>x.status==='OPEN').length;
  document.getElementById('handlingCnt').textContent = list.filter(x=>x.status==='HANDLING').length;
  document.getElementById('closedCnt').textContent = list.filter(x=>x.status==='CLOSED').length;

  const el = document.getElementById('sosList');
  if(list.length===0){ el.innerHTML='<div style="padding:18px; color:#94a3b8;">è©²å½“ã‚¢ãƒ©ãƒ¼ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</div>'; clearDetail(); return; }
  el.innerHTML = list.map(x=>`
    <div class="srow ${state.activeId===x.id?'active':''}" data-id="${x.id}">
      <div class="icon">SOS</div>
      <div>
        <div class="sname"><button class="link cast-link" data-cast="${x.cast}" onclick="event.stopPropagation(); openCastModal('${x.cast}')">${x.cast} ã•ã‚“</button></div>
        <div class="smeta">æ‹…å½“: ${STAFFS[x.owner].name} / ${fmtDT(x.at)} / ${x.text.slice(0,40)}</div>
      </div>
      <div class="sstatus ${x.status==='OPEN'?'status-open':x.status==='HANDLING'?'status-handling':'status-closed'}">${x.status}</div>
    </div>
  `).join('');
}
sosList.addEventListener('click', (e)=>{
  const row=e.target.closest('.srow'); if(!row) return;
  openDetail(row.getAttribute('data-id'));
});

/* ===== è©³ç´°è¡¨ç¤ºãƒ»æ“ä½œ ===== */
function openDetail(id){
  state.activeId=id;
  const x=state.list.find(a=>a.id===id); if(!x) return;
  document.getElementById('detailName').innerHTML = `<button class="link" onclick="openCastModal('${x.cast}')">${x.cast} ã•ã‚“</button>ã®SOS`;
  document.getElementById('detailMeta').textContent = `${fmtDT(x.at)} / ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${x.status}`;
  dCast.innerHTML = `<button class="link" onclick="openCastModal('${x.cast}')">${x.cast}</button>`;
  dOwner.textContent = STAFFS[x.owner].name;
  dTime.textContent = fmtDT(x.at);
  dStatus.textContent = x.status;
  dText.textContent = x.text || "(æœ¬æ–‡ãªã—)";
  dLatLng.textContent = `lat: ${x.lat.toFixed(6)} / lng: ${x.lng.toFixed(6)}`;
  btnMap.href = `https://www.google.com/maps?q=${x.lat},${x.lng}`;
  applyDetailPermission();
  renderList();
}
function clearDetail(){
  state.activeId=null;
  detailName.textContent="æœªé¸æŠ";
  detailMeta.textContent="å·¦ã®ä¸€è¦§ã‹ã‚‰é¸æŠã—ã¦ãã ã•ã„";
  dCast.textContent=dOwner.textContent=dTime.textContent=dStatus.textContent=dText.textContent=dLatLng.textContent="";
  btnMap.href="#";
}
function applyDetailPermission(){
  const x = state.list.find(a=>a.id===state.activeId);
  const canOp = x && (state.login.role==="ADMIN" || state.login.user===x.owner);
  btnHandling.disabled = !canOp; btnClose.disabled = !canOp;
  btnHandling.title = btnClose.title = canOp ? "" : "æ‹…å½“å¤–ã¯æ“ä½œã§ãã¾ã›ã‚“";
}
btnHandling.addEventListener('click', ()=>{
  const x=state.list.find(a=>a.id===state.activeId); if(!x) return;
  x.status='HANDLING'; openDetail(x.id);
});
btnClose.addEventListener('click', ()=>{
  const x=state.list.find(a=>a.id===state.activeId); if(!x) return;
  x.status='CLOSED'; openDetail(x.id);
});

/* ===== Global SOS Notifierï¼ˆå…¨ãƒšãƒ¼ã‚¸å…±é€šï¼‰ ===== */
(() => {
  const sosBanner    = document.getElementById('sosBanner');
  const sosBannerMsg = document.getElementById('sosBannerMsg');
  const sosOpenBtn   = document.getElementById('sosOpenBtn');
  const sosMuteBtn   = document.getElementById('sosMuteBtn');

  // --- è¿½åŠ : ãƒŸãƒ¥ãƒ¼ãƒˆã®æ’ä¹…åŒ–ã‚­ãƒ¼ï¼†åˆ¶å¾¡ã‚­ãƒ¼
  const MUTE_KEY = 'sos_muted_v1';
  const CTRL_KEY = 'sos_ctrl_v1';       // {t, cmd:'mute'|'unmute'}
  const CAST_KEY = 'sos_broadcast';     // æ—¢å­˜: SOSå†…å®¹ã®ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆ

  let sosOsc=null, sosCtx=null;

  const isMuted = () => localStorage.getItem(MUTE_KEY) === '1';

  function playSosTone(){
    if (isMuted()) return; // ãƒŸãƒ¥ãƒ¼ãƒˆæ™‚ã¯é³´ã‚‰ã•ãªã„
    try{
      sosCtx = sosCtx || new (window.AudioContext||window.webkitAudioContext)();
      const osc = sosCtx.createOscillator();
      const gain = sosCtx.createGain();
      osc.frequency.value = 880;
      osc.type = "square";
      gain.gain.value = 0.05;
      osc.connect(gain).connect(sosCtx.destination);
      osc.start();
      sosOsc = osc;
    }catch(e){}
  }
  function stopSosTone(){
    try{ if(sosOsc){ sosOsc.stop(); sosOsc.disconnect(); sosOsc=null; } }catch(e){}
  }

  function showSosBanner(payload){
    if (isMuted()) return; // ãƒŸãƒ¥ãƒ¼ãƒˆä¸­ã¯å‡ºã•ãªã„
    const ownerName = payload?.ownerName || payload?.owner || '';
    const castName  = payload?.cast || 'ã‚­ãƒ£ã‚¹ãƒˆ';
    sosBannerMsg.textContent = `ğŸš¨ ${castName} ã•ã‚“ãŒSOSç™ºå ±ï¼ˆæ‹…å½“: ${ownerName}ï¼‰`;
    sosBanner.style.display='flex';
    playSosTone();
  }
  function hideSosBanner(){
    sosBanner.style.display='none';
    stopSosTone();
  }

  // ---- ãƒŸãƒ¥ãƒ¼ãƒˆï¼ã‚¢ãƒ³ãƒŸãƒ¥ãƒ¼ãƒˆï¼ˆå…¨ãƒšãƒ¼ã‚¸å³æ™‚åŒæœŸï¼‰
  function muteSOS(){
    localStorage.setItem(MUTE_KEY, '1');   // æ°¸ç¶šãƒŸãƒ¥ãƒ¼ãƒˆ
    hideSosBanner();
    // ä»–ã‚¿ãƒ–ãƒ»ä»–ãƒšãƒ¼ã‚¸ã¸åˆ¶å¾¡ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆ
    localStorage.setItem(CTRL_KEY, JSON.stringify({ t: Date.now(), cmd:'mute' }));
  }
  function unmuteSOS(){
    localStorage.removeItem(MUTE_KEY);
    localStorage.setItem(CTRL_KEY, JSON.stringify({ t: Date.now(), cmd:'unmute' }));
  }

  // ãƒœã‚¿ãƒ³
  sosOpenBtn?.addEventListener('click', () => {
    hideSosBanner();
    try{ window.location.href = 'sos.html'; }catch(e){}
  });
  sosMuteBtn?.addEventListener('click', muteSOS);

  // ä»–ã‚¿ãƒ–ã‹ã‚‰ã®é€šçŸ¥ï¼†åˆ¶å¾¡ã‚’å—ä¿¡
  window.addEventListener('storage', (e)=>{
    if (e.key === CAST_KEY && e.newValue){
      // SOSå—ä¿¡ï¼ˆãŸã ã—ãƒŸãƒ¥ãƒ¼ãƒˆä¸­ã¯ç„¡è¦–ï¼‰
      if (isMuted()) return;
      try{ showSosBanner(JSON.parse(e.newValue)); }catch(_) {}
    }
    if (e.key === CTRL_KEY && e.newValue){
      // ãƒŸãƒ¥ãƒ¼ãƒˆåˆ¶å¾¡åŒæœŸ
      try{
        const msg = JSON.parse(e.newValue);
        if (msg.cmd === 'mute'){ hideSosBanner(); }
        // 'unmute' ã¯ãƒãƒŠãƒ¼ã‚’å³è¡¨ç¤ºã—ãªã„ï¼ˆæ¬¡ã® SOS ã‚’å¾…ã¤æƒ³å®šï¼‰
      }catch(_){}
    }
  });

  // å…¬é–‹API
  /** å…¨ã‚¿ãƒ–ã¸SOSé…ä¿¡ï¼ˆåŒã‚¿ãƒ–ã‚‚å³æ™‚è¡¨ç¤ºï¼‰ */
  window.broadcastSOS = function(payload){
    localStorage.setItem(CAST_KEY, JSON.stringify(payload || {}));
    if (!isMuted()) showSosBanner(payload || {});
  };
  /** æ˜ç¤ºçš„ã«è¡¨ç¤ºï¼ˆãƒŸãƒ¥ãƒ¼ãƒˆä¸­ã¯å‡ºãªã„ï¼‰ */
  window.showSosBanner = showSosBanner;
  /** ãƒŸãƒ¥ãƒ¼ãƒˆ/è§£é™¤APIï¼ˆä»»æ„ãƒšãƒ¼ã‚¸ã§åˆ©ç”¨å¯ï¼‰ */
  window.muteSOS = muteSOS;
  window.unmuteSOS = unmuteSOS;

  // åˆæœŸçŠ¶æ…‹ï¼šãƒŸãƒ¥ãƒ¼ãƒˆãªã‚‰ç¢ºå®Ÿã«éè¡¨ç¤ºåŒ–
  if (isMuted()) hideSosBanner();
})();
</script>
</body>
</html>
