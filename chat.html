<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ãƒãƒ£ãƒƒãƒˆï¼ˆLINEï¼‰ | ãƒˆãƒ¼ã‚¯ç®¡ç†</title>
<style>
  :root{
    --gap:6px; --radius:10px; --bg:#f7f7f8; --panel:#ffffff; --text:#222;
    --muted:#667085; --line:#e5e7eb; --accent:#2563eb; --accent-2:#0ea5e9;
    --sidebar:#0f172a; --sidebarText:#e2e8f0;
    --sidebarW:160px; --wrapW:1160px; --shadow:0 8px 24px rgba(16,24,40,.08);
    --me:#dbeafe; --you:#f1f5f9;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:13px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue","Noto Sans JP","Yu Gothic UI",Meiryo,sans-serif;overflow:hidden;}

  /* Sidebarï¼ˆå…±é€šï¼‰ */
  .sidebar{position:fixed; inset:0 auto 0 0; width:var(--sidebarW); background:var(--sidebar); color:var(--sidebarText); display:flex; flex-direction:column; padding:14px 10px; gap:12px;}
  .side-logo{display:flex; align-items:center; justify-content:center; padding:8px 6px;}
  .side-logo img{width:86%; height:auto; object-fit:contain}
  .side-group{margin-bottom:8px;}
  .side-sec{padding:4px 6px 0; font-weight:700; font-size:12px; opacity:.9;}
  .side-list{list-style:none;margin:0;padding:4px}
  .side-list a{display:flex; align-items:center; gap:6px; padding:6px 8px; border-radius:8px; cursor:pointer; font-size:12px; color:var(--sidebarText); text-decoration:none}
  .side-list a:hover{background:rgba(255,255,255,.06)}
  .side-list a.active{background:rgba(255,255,255,.12)}

  /* Main */
  .main{margin-left:var(--sidebarW); height:100vh; display:flex; flex-direction:column;}
  header{flex:0 0 auto; background:rgba(247,247,248,0.9); backdrop-filter:saturate(1.2) blur(6px); border-bottom:1px solid var(--line);}
  .wrap{max-width:var(--wrapW); margin:0 auto; padding:6px 10px;}
  .head-top{display:grid; grid-template-columns: 1fr auto auto; align-items:center; column-gap:12px; row-gap:6px;}
  .title{font-size:16px; font-weight:700; margin:0;}
  .head-right{display:flex; align-items:center; gap:8px; flex-wrap:wrap; justify-self:end;}
  .badge{display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; background:#fff; border:1px solid var(--line); font-size:12px}
  .role{font-weight:700}
  .login{display:flex; align-items:center; gap:6px;}
  .login select{border:1px solid var(--line); border-radius:8px; padding:6px 8px; background:#fff; font-size:12px}
  .print-btn{background:var(--accent); color:#fff; border:1px solid var(--accent); border-radius:8px; padding:6px 10px; font-size:12px}
  .logout-btn{background:#fff; color:#111; border:1px solid var(--line); border-radius:8px; padding:6px 10px; font-size:12px; cursor:pointer}
  .logout-btn:hover{background:#f8fafc}

  .toolbar{display:flex; gap:8px; align-items:center; flex-wrap:wrap; padding:6px 0 2px 0; font-size:12px}
  .toolbar input,.toolbar select{border:1px solid var(--line); border-radius:8px; padding:6px 8px; background:#fff; font-size:12px}
  .toolbar .spacer{flex:1 1 auto}

  /* Layout */
  .content{flex:1 1 auto; display:flex;}
  .panel{flex:1 1 auto; background:#fff; border:1px solid var(--line); border-radius:0; margin:0; width:100%; max-width:none; display:flex;}
  .threads{flex:0 0 360px; border-right:1px solid var(--line); display:flex; flex-direction:column; min-width:280px;}
  .chat{flex:1 1 auto; display:flex; flex-direction:column; min-width:0;}

  /* Thread list */
  .thread-head{padding:10px; border-bottom:1px solid var(--line); display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
  .thread-head input,.thread-head select{border:1px solid var(--line); border-radius:8px; padding:6px 8px; background:#fff; font-size:12px}
  .thread-list{flex:1 1 auto; overflow:auto;}
  .item{display:grid; grid-template-columns: 40px 1fr auto; gap:8px; padding:10px; border-bottom:1px solid #f1f5f9; cursor:pointer;}
  .item:hover{background:#f8fafc}
  .item.active{background:#eff6ff}
  .avatar{width:40px; height:40px; border-radius:999px; background:#f1f5f9; display:flex; align-items:center; justify-content:center; font-weight:800; color:#475569;}
  .meta{display:flex; align-items:center; gap:6px;}
  .name{font-weight:800;}
  .sub{color:#64748b; font-size:12px;}
  .owner{border-radius:999px; padding:2px 6px; border:1px solid var(--line); font-size:11px; background:#fff;}
  .unread{background:#ef4444; color:#fff; font-size:11px; border-radius:999px; padding:2px 6px;}
  .time{color:#64748b; font-size:12px; white-space:nowrap;}

  /* Chat view */
  .chat-head{padding:10px; border-bottom:1px solid var(--line); display:flex; align-items:center; justify-content:space-between;}
  .chat-title{font-weight:800;}
  .chat-sub{color:#64748b; font-size:12px;}
  .messages{flex:1 1 auto; overflow:auto; padding:12px; background:#f8fafc;}
  .bubble{max-width:70%; padding:8px 10px; border-radius:12px; margin:6px 0; box-shadow:0 1px 0 rgba(0,0,0,.04);}
  .me{background:var(--me); margin-left:auto; border:1px solid #bfdbfe;}
  .you{background:var(--you); margin-right:auto; border:1px solid #e2e8f0;}
  .stamp{font-size:11px; color:#64748b; margin-top:2px; text-align:right;}
  .composer{display:flex; gap:8px; padding:10px; border-top:1px solid var(--line); background:#fff;}
  .composer textarea{flex:1 1 auto; min-height:38px; max-height:120px; resize:vertical; border:1px solid var(--line); border-radius:10px; padding:8px;}
  .composer .btn{border:1px solid var(--line); background:var(--accent); color:#fff; border-radius:10px; padding:8px 12px; font-size:12px; cursor:pointer}
  .composer.disabled textarea{background:#f8fafc; color:#94a3b8}
  .composer.disabled .btn{background:#e5e7eb; color:#94a3b8; cursor:not-allowed}
  .empty{display:flex; align-items:center; justify-content:center; color:#94a3b8; height:100%;}
/* ===== Global SOS Notifier ===== */
.sos-banner{
  position:fixed; inset:0 0 auto 0; height:64px;
  display:flex; align-items:center; justify-content:center;
  background:linear-gradient(90deg,#7f1d1d,#dc2626,#b91c1c);
  color:#fff; z-index:999999; box-shadow:0 4px 20px rgba(0,0,0,.35);
}
.sos-banner .inner{display:flex; align-items:center; gap:12px; font-weight:900; letter-spacing:.05em;}
.sos-banner .msg{font-size:16px;}
/* æ—¢å­˜ã® .btn ãŒç„¡ã„ãƒšãƒ¼ã‚¸å‘ã‘ã®è»½ã„ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ */
.sos-banner .btn{padding:6px 10px; border-radius:8px; border:1px solid rgba(255,255,255,.6); background:rgba(255,255,255,.12); color:#fff; cursor:pointer;}
.flash{animation:flash 1s infinite alternate ease-in-out;}
@keyframes flash { from {opacity:1; transform:scale(1);} to {opacity:.6; transform:scale(1.02);} }
.shake{animation:shake .5s infinite;}
@keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-3px)} 75%{transform:translateX(3px)} }

</style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="side-logo"><a href="dashboard.html"><img src="img/logo4.png" alt="LOGO"/></a></div>

    <div class="side-group">
      <div class="side-sec">é‹ç”¨æ©Ÿèƒ½</div>
      <ul class="side-list">
        <li><a href="dashboard.html">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a></li>
        <li><a href="schedule.html">ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</a></li>
      </ul>
    </div>

    <div class="side-group">
      <div class="side-sec">ç®¡ç†æ©Ÿèƒ½</div>
      <ul class="side-list">
        <li><a href="cast.html">ã‚­ãƒ£ã‚¹ãƒˆç®¡ç†</a></li>
        <li><a href="shops.html">åº—èˆ—ç®¡ç†</a></li>
      </ul>
    </div>

    <div class="side-group">
      <div class="side-sec">é€šä¿¡æ©Ÿèƒ½</div>
      <ul class="side-list">
        <li><a class="active" href="chat.html">ãƒãƒ£ãƒƒãƒˆï¼ˆLINEï¼‰</a></li>
        <li><a href="sos.html">SOSã‚¢ãƒ©ãƒ¼ãƒˆ</a></li>
      </ul>
    </div>

    <div class="side-group">
      <div class="side-sec">è¨­å®šæ©Ÿèƒ½</div>
      <ul class="side-list">
        <li><a href="request.html">ç”³è«‹ãƒ»æ‰¿èª</a></li>
        <li><a href="setting.html">è¨­å®š</a></li>
      </ul>
    </div>
  </aside>

  <!-- ===== Global SOS Notifierï¼ˆå…¨ãƒšãƒ¼ã‚¸å…±é€šãƒãƒŠãƒ¼ï¼‰ ===== -->
  <div id="sosBanner" class="sos-banner flash shake" role="alert" aria-live="assertive">
    <div class="inner">
      <span style="font-size:20px;">ğŸš¨ SOS</span>
      <span class="msg" id="sosBannerMsg">ã‚­ãƒ£ã‚¹ãƒˆã‹ã‚‰SOSã‚’å—ä¿¡ï¼è‡³æ€¥ç¢ºèªã—ã¦ãã ã•ã„ï¼</span>
      <button class="btn" id="sosOpenBtn">é–‹ã</button>
      <button class="btn" id="sosMuteBtn">åœæ­¢</button>
    </div>
  </div>

  <!-- Main -->
  <div class="main">
    <header>
      <div class="wrap">
        <div class="head-top">
          <h1 class="title">ãƒãƒ£ãƒƒãƒˆï¼ˆLINEï¼‰</h1>
          <div></div>
          <div class="head-right">
            <span class="badge"><span class="label">ãƒ­ãƒ¼ãƒ«</span> <span class="role" id="roleBadge">ç®¡ç†è€…</span></span>
            <div class="login">
              <label for="loginSelect" class="label">ãƒ­ã‚°ã‚¤ãƒ³:</label>
              <select id="loginSelect">
                <option value="ADMIN:admin">ç®¡ç†è€…ï¼ˆadminï¼‰</option>
                <option value="STAFF:tanaka">æ‹…å½“è€…ï¼ˆç”°ä¸­ï¼‰</option>
                <option value="STAFF:sato">æ‹…å½“è€…ï¼ˆä½è—¤ï¼‰</option>
                <option value="STAFF:suzuki">æ‹…å½“è€…ï¼ˆéˆ´æœ¨ï¼‰</option>
              </select>
            </div>
            <button class="logout-btn" onclick="location.href='index.html'">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            <button class="print-btn" onclick="window.print()">å°åˆ·</button>
          </div>
        </div>

        <div class="toolbar">
          <input id="q" type="text" placeholder="åå‰ãƒ»LINE IDã§æ¤œç´¢" style="min-width:240px">
          <select id="ownerFilter" style="display:none">
            <option value="">æ‹…å½“è€…ï¼ˆã™ã¹ã¦ï¼‰</option>
            <option value="tanaka">ç”°ä¸­</option>
            <option value="sato">ä½è—¤</option>
            <option value="suzuki">éˆ´æœ¨</option>
          </select>
          <div class="spacer"></div>
          <span class="sub" id="viewHint"></span>
        </div>
      </div>
    </header>

    <div class="content">
      <div class="panel">
        <!-- Left: thread list -->
        <aside class="threads">
          <div class="thread-head">
            <input id="thQuery" type="text" placeholder="ã‚¹ãƒ¬ãƒƒãƒ‰æ¤œç´¢ï¼ˆåå‰ãƒ»IDï¼‰" style="flex:1 1 auto;">
            <select id="thOwner" style="min-width:140px;">
              <option value="">æ‹…å½“è€…ï¼ˆã™ã¹ã¦ï¼‰</option>
              <option value="tanaka">ç”°ä¸­</option>
              <option value="sato">ä½è—¤</option>
              <option value="suzuki">éˆ´æœ¨</option>
            </select>
          </div>
          <div id="threadList" class="thread-list"></div>
        </aside>

        <!-- Right: chat view -->
        <section class="chat">
          <div class="chat-head">
            <div>
              <div class="chat-title" id="chatTitle">ã‚¹ãƒ¬ãƒƒãƒ‰æœªé¸æŠ</div>
              <div class="chat-sub" id="chatSub">å·¦ã®ä¸€è¦§ã‹ã‚‰é¸æŠã—ã¦ãã ã•ã„</div>
            </div>
            <button class="btn" id="readBtn" style="display:none; border:1px solid var(--line); background:#fff; border-radius:8px; padding:6px 10px; font-size:12px; cursor:pointer">æ—¢èª­ã«ã™ã‚‹</button>
          </div>
          <div id="msgArea" class="messages">
            <div class="empty">ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’é¸æŠã™ã‚‹ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
          </div>
          <div id="composer" class="composer disabled" title="æ‹…å½“è€…ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã®ã¿é€ä¿¡ã§ãã¾ã™">
            <textarea id="msgInput" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." disabled></textarea>
            <button class="btn" id="sendBtn" disabled>é€ä¿¡</button>
          </div>
        </section>
      </div>
    </div>
  </div>

<script>
/* ===== ãƒ‡ãƒ¢ç”¨ãƒ‡ãƒ¼ã‚¿ ===== */
const STAFFS = {
  tanaka:{id:'tanaka', name:'ç”°ä¸­'},
  sato:{id:'sato', name:'ä½è—¤'},
  suzuki:{id:'suzuki', name:'éˆ´æœ¨'}
};
function rand(arr){return arr[Math.floor(Math.random()*arr.length)]}
function fmtHM(d){return String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0')}
function fmtDateTime(d){return `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')} ${fmtHM(d)}`}
function initials(s){return s.slice(0,2)}

const NAMES = ["å±±ç”°èŠ±å­","ä½ã€…æœ¨çœŸå¤®","é«˜æ©‹ã•ãã‚‰","å·¥è—¤ã‚Šãª","ç”°æ‘ã†ãŸ","æ¡œäº•ã‚†ã‚","ç›¸æ²¢ã“ã“","ç™½çŸ³ã‚Œã„","ä¸€ãƒç€¬ã¾ã“","äºŒéšå ‚ã¿ãŠ",
"ä¼Šè—¤ã‚ã„","ç¯ åŸã¿ã•ã","è¥¿é‡ã‚‚ã‚‚","å¿—æ‘ã»ã®ã‹","æ¾å°¾ãªã¤","ä¸­æ‘ã—ãšã","ç¶¾ç€¬ã‚ã‚„","æ—©å·ã¿ã","ç¥å´ã—ãŠã‚Š","ç›¸åŸã‚ŠãŠ"];
const owners = ["tanaka","sato","suzuki"];

const THREADS = Array.from({length:36}, (_,i)=>{
  const name = NAMES[i%NAMES.length];
  const owner = owners[i%owners.length];
  const lineId = "U" + (100000+i);
  const now = new Date(); now.setMinutes(now.getMinutes()-i*7);
  const unread = (i%5===0)?Math.floor(Math.random()*4)+1:0;
  return {id:"t"+(i+1), name, lineId, owner, last: "ã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ï¼", lastAt: now, unread};
});

// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆè»½ãç”Ÿæˆï¼‰
const MSGDB = {};
THREADS.forEach(t=>{
  const arr=[];
  for(let i=0;i<rand([6,8,10,12]);i++){
    const from = (i%2===0)?'client':'staff';
    const text = from==='client' ? rand(["æ˜æ—¥ç©ºã„ã¦ã¾ã™ã‹ï¼Ÿ","è©³ç´°ã‚’æ•™ãˆã¦ãã ã•ã„","ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼","ã„ã¤é ƒã«ãªã‚Šã¾ã™ã‹ï¼Ÿ","ã¾ãŸé€£çµ¡ã—ã¾ã™ã€‚"]) :
                                   rand(["æ‰¿çŸ¥ã—ã¾ã—ãŸã€‚","ç¢ºèªã„ãŸã—ã¾ã™ã€‚","ã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ã€‚","ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼","ã¯ã„ã€å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚"]);
    const ts = new Date(t.lastAt); ts.setMinutes(ts.getMinutes() - (rand([2,3,4,5])*i));
    arr.push({from, text, ts});
  }
  MSGDB[t.id]=arr;
});

/* ===== çŠ¶æ…‹ ===== */
let state={
  login:{role:"ADMIN", user:"admin"}, // or STAFF:tanaka/sato/suzuki
  filter:{q:"", owner:""},
  activeThreadId:null
};

/* ===== ãƒ­ã‚°ã‚¤ãƒ³UI ===== */
const loginSelect = document.getElementById('loginSelect');
const roleBadge = document.getElementById('roleBadge');
const ownerFilter = document.getElementById('ownerFilter');
const viewHint = document.getElementById('viewHint');

loginSelect.addEventListener('change', ()=>{
  const [role,user]=loginSelect.value.split(':');
  state.login={role,user};
  roleBadge.textContent=(role==="ADMIN"?"ç®¡ç†è€…":"æ‹…å½“è€…");
  // ç®¡ç†è€…ã¯å…¨ä»¶ãƒ»æ‹…å½“è€…ã¯è‡ªåˆ†ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã®ã¿è¡¨ç¤º
  document.getElementById('thOwner').style.display = (role==="ADMIN") ? "inline-block" : "none";
  state.filter.owner = (role==="ADMIN") ? document.getElementById('thOwner').value : user;
  // é€ä¿¡æ¨©é™ã®åˆ‡æ›¿
  applyComposerPermission();
  renderThreads();
  // ã‚¢ã‚¯ã‚»ã‚¹ãƒ’ãƒ³ãƒˆ
  if(role==="ADMIN"){
    viewHint.textContent = "ç®¡ç†è€…ï¼šå…¨æ‹…å½“è€…ã®ãƒˆãƒ¼ã‚¯ã‚’é–²è¦§ã§ãã¾ã™ï¼ˆé€ä¿¡ã¯ç„¡åŠ¹ï¼‰";
  }else{
    viewHint.textContent = `æ‹…å½“è€…ï¼š${STAFFS[user].name} ã®ãƒˆãƒ¼ã‚¯ã®ã¿é–²è¦§ãƒ»é€ä¿¡ã§ãã¾ã™`;
  }
});

/* ===== ã‚¹ãƒ¬ãƒƒãƒ‰ä¸€è¦§ ===== */
const thQuery = document.getElementById('thQuery');
const thOwner = document.getElementById('thOwner');
thQuery.addEventListener('input', ()=>{ state.filter.q = thQuery.value.trim(); renderThreads(); });
thOwner.addEventListener('change', ()=>{ state.filter.owner = thOwner.value; renderThreads(); });

function filteredThreads(){
  let arr = THREADS.slice();
  // æ¨©é™åˆ¶å¾¡
  if(state.login.role==="STAFF"){ arr = arr.filter(t=>t.owner===state.login.user); }
  // ç®¡ç†è€…ã®ã‚ªãƒ¼ãƒŠãƒ¼ãƒ•ã‚£ãƒ«ã‚¿
  if(state.login.role==="ADMIN" && state.filter.owner){ arr = arr.filter(t=>t.owner===state.filter.owner); }
  // æ¤œç´¢
  const q=(state.filter.q||"").toLowerCase().normalize("NFKC");
  if(q){
    arr = arr.filter(t=>{
      const key=(t.name+" "+t.lineId).toLowerCase().normalize("NFKC");
      return key.includes(q);
    });
  }
  // ä¸¦ã³ï¼šæœªèª­é™é †â†’æœ€çµ‚æ™‚åˆ»é™é †
  arr.sort((a,b)=>{
    if((b.unread||0)!==(a.unread||0)) return (b.unread||0)-(a.unread||0);
    return b.lastAt - a.lastAt;
  });
  return arr;
}

function renderThreads(){
  const list = filteredThreads();
  const el=document.getElementById('threadList');
  if(list.length===0){ el.innerHTML='<div class="empty" style="padding:24px;">è©²å½“ã‚¹ãƒ¬ãƒƒãƒ‰ã¯ã‚ã‚Šã¾ã›ã‚“</div>'; return; }
  el.innerHTML = list.map(t=>`
    <div class="item ${state.activeThreadId===t.id?'active':''}" data-id="${t.id}">
      <div class="avatar">${initials(t.name)}</div>
      <div>
        <div class="meta">
          <span class="name">${t.name}</span>
          <span class="owner">${STAFFS[t.owner].name}</span>
          ${t.unread?`<span class="unread">${t.unread}</span>`:''}
        </div>
        <div class="sub">ID: ${t.lineId} / ${t.last}</div>
      </div>
      <div class="time">${fmtHM(t.lastAt)}</div>
    </div>
  `).join('');
}

document.getElementById('threadList').addEventListener('click', (e)=>{
  const item = e.target.closest('.item'); if(!item) return;
  const id=item.getAttribute('data-id');
  openThread(id);
});

function openThread(id){
  state.activeThreadId=id;
  const t=THREADS.find(x=>x.id===id); if(!t) return;
  // æ—¢èª­ãƒœã‚¿ãƒ³å¯è¦–åŒ–
  document.getElementById('readBtn').style.display = t.unread? 'inline-block':'none';
  // ãƒ˜ãƒƒãƒ€ãƒ¼
  document.getElementById('chatTitle').textContent = t.name;
  document.getElementById('chatSub').textContent = `LINE ID: ${t.lineId} / æ‹…å½“: ${STAFFS[t.owner].name}`;
  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  renderMessages(id);
  // æ¨©é™ã«å¿œã˜ã¦é€ä¿¡å¯å¦
  applyComposerPermission();
  // ãƒªã‚¹ãƒˆå†æç”»ï¼ˆé¸æŠãƒã‚¤ãƒ©ã‚¤ãƒˆ/æœªèª­è¡¨ç¤ºã®ãŸã‚ï¼‰
  renderThreads();
}

/* ===== ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æç”»ãƒ»é€ä¿¡ ===== */
function renderMessages(id){
  const box=document.getElementById('msgArea');
  const msgs=MSGDB[id]||[];
  if(msgs.length===0){ box.innerHTML='<div class="empty">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>'; return; }
  box.innerHTML = msgs.map(m=>`
    <div class="bubble ${m.from==='staff'?'me':'you'}">
      <div>${escapeHtml(m.text)}</div>
      <div class="stamp">${fmtDateTime(m.ts)}</div>
    </div>
  `).join('');
  box.scrollTop = box.scrollHeight;
}
function applyComposerPermission(){
  const comp = document.getElementById('composer');
  const input = document.getElementById('msgInput');
  const btn = document.getElementById('sendBtn');
  const th = THREADS.find(x=>x.id===state.activeThreadId);
  const canSend = (state.login.role==="STAFF") && th && (th.owner===state.login.user);
  if(canSend){
    comp.classList.remove('disabled');
    input.disabled=false; btn.disabled=false; comp.removeAttribute('title');
  }else{
    comp.classList.add('disabled');
    input.disabled=true; btn.disabled=true;
    comp.title = (state.login.role==="ADMIN") ? "ç®¡ç†è€…ã¯é–²è¦§å°‚ç”¨ã§ã™" : "æ‹…å½“å¤–ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã¯é€ä¿¡ã§ãã¾ã›ã‚“";
  }
}
document.getElementById('sendBtn').addEventListener('click', sendMessage);
document.getElementById('msgInput').addEventListener('keydown', (e)=>{
  if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); }
});
function sendMessage(){
  const th = THREADS.find(x=>x.id===state.activeThreadId);
  if(!th) return;
  const text = document.getElementById('msgInput').value.trim();
  if(!text) return;
  // æ¨©é™ãƒã‚§ãƒƒã‚¯
  if(!(state.login.role==="STAFF" && th.owner===state.login.user)) return;

  const now=new Date();
  MSGDB[th.id]=MSGDB[th.id]||[];
  MSGDB[th.id].push({from:'staff', text, ts:now});
  th.last = text; th.lastAt = now;

  // è‡ªåˆ†ãŒé€ä¿¡â†’æœªèª­ã¯ç›¸æ‰‹å´ãªã®ã§ list æœªèª­ã¯å¤‰ãˆãªã„æƒ³å®šã€‚ã“ã“ã§ã¯ 0 ã®ã¾ã¾ã«ã€‚
  document.getElementById('msgInput').value="";
  renderMessages(th.id);
  renderThreads();
}

/* ===== æ—¢èª­å‡¦ç† ===== */
document.getElementById('readBtn').addEventListener('click', ()=>{
  const th = THREADS.find(x=>x.id===state.activeThreadId); if(!th) return;
  th.unread = 0;
  document.getElementById('readBtn').style.display='none';
  renderThreads();
});

/* ===== å°ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ===== */
function escapeHtml(s){return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]))}

/* ===== åˆæœŸåŒ– ===== */
(function init(){
  // ãƒ­ã‚°ã‚¤ãƒ³è¡¨ç¤º
  const [role,user]=loginSelect.value.split(':');
  state.login={role,user};
  roleBadge.textContent=(role==="ADMIN"?"ç®¡ç†è€…":"æ‹…å½“è€…");
  // æ‹…å½“è€…ãƒ“ãƒ¥ãƒ¼ã®å ´åˆã¯ä¸€è¦§ã®æ‹…å½“è€…ãƒ•ã‚£ãƒ«ã‚¿ã‚’éš ã—ã€è‡ªåˆ†ã®ã¿ã«å›ºå®š
  document.getElementById('thOwner').style.display = (role==="ADMIN") ? "inline-block" : "none";
  state.filter.owner = (role==="ADMIN") ? "" : user;
  // æ¤œç´¢åˆæœŸ
  thQuery.value=""; state.filter.q="";
  renderThreads();
  viewHint.textContent = "ç®¡ç†è€…ï¼šå…¨æ‹…å½“è€…ã®ãƒˆãƒ¼ã‚¯ã‚’é–²è¦§ã§ãã¾ã™ï¼ˆé€ä¿¡ã¯ç„¡åŠ¹ï¼‰";
})();

/* ===== Global SOS Notifierï¼ˆé–¢æ•°ç¾¤ï¼‰ ===== */
(() => {
  const sosBanner    = document.getElementById('sosBanner');
  const sosBannerMsg = document.getElementById('sosBannerMsg');
  const sosOpenBtn   = document.getElementById('sosOpenBtn');
  const sosMuteBtn   = document.getElementById('sosMuteBtn');

  let sosOsc=null, sosCtx=null, sosMuted=false;

  function playSosTone(){
    try{
      if(sosMuted) return;
      sosCtx = sosCtx || new (window.AudioContext||window.webkitAudioContext)();
      const osc = sosCtx.createOscillator();
      const gain = sosCtx.createGain();
      osc.frequency.value=880;         // è­¦å‘Šã£ã½ã„éŸ³
      osc.type="square";
      gain.gain.value=0.05;            // éŸ³é‡æ§ãˆã‚
      osc.connect(gain).connect(sosCtx.destination);
      osc.start();
      sosOsc = osc;
    }catch(e){}
  }
  function stopSosTone(){
    try{ if(sosOsc){ sosOsc.stop(); sosOsc.disconnect(); sosOsc=null; } }catch(e){}
  }

  /** å—ä¿¡æ™‚ã«å‘¼ã¶ï¼šãƒãƒŠãƒ¼è¡¨ç¤ºï¼‹éŸ³ */
  function showSosBanner(payload){
    const ownerName = payload.ownerName || payload.owner || '';
    sosBannerMsg.textContent = `ğŸš¨ ${payload.cast || 'ã‚­ãƒ£ã‚¹ãƒˆ'} ã•ã‚“ãŒSOSç™ºå ±ï¼ˆæ‹…å½“: ${ownerName}ï¼‰`;
    sosBanner.style.display='flex';
    playSosTone();
  }
  function hideSosBanner(){
    sosBanner.style.display='none';
    stopSosTone();
  }

  // ãƒœã‚¿ãƒ³å‹•ä½œï¼ˆã€Œé–‹ãã€ã§SOSãƒšãƒ¼ã‚¸ã¸ã€ã€Œåœæ­¢ã€ã§ãƒŸãƒ¥ãƒ¼ãƒˆï¼‰
  sosOpenBtn?.addEventListener('click', () => {
    hideSosBanner();
    try{ window.location.href = 'sos.html'; }catch(e){}
  });
  sosMuteBtn?.addEventListener('click', () => {
    sosMuted = true;
    hideSosBanner();
  });

  // ä»–ã‚¿ãƒ–ãƒ»ä»–ãƒšãƒ¼ã‚¸ã‹ã‚‰ã®ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆã‚’å—ä¿¡
  window.addEventListener('storage', (e)=>{
    if(e.key === 'sos_broadcast' && e.newValue){
      try{
        const data = JSON.parse(e.newValue);
        showSosBanner(data);
      }catch(_){}
    }
  });

  // ===== å…¬é–‹APIï¼ˆå…¨ãƒšãƒ¼ã‚¸ã‹ã‚‰ä½¿ãˆã‚‹ã‚ˆã†ã« window ã«éœ²å‡ºï¼‰ =====
  /** ä»»æ„ãƒšãƒ¼ã‚¸ã§å‘¼ã¶ï¼šãƒãƒŠãƒ¼ã‚’ç›´æ¥å‡ºã™ */
  window.showSosBanner = showSosBanner;

  /** ä»»æ„ãƒšãƒ¼ã‚¸ã§å‘¼ã¶ï¼šå…¨ã‚¿ãƒ–ãƒ»å…¨ãƒšãƒ¼ã‚¸ã¸é€šçŸ¥ï¼ˆlocalStorage ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆï¼‰ */
  window.broadcastSOS = function(payload){
    try{ localStorage.setItem('sos_broadcast', JSON.stringify(payload || {})); }catch(e){}
    // åŒã‚¿ãƒ–ã§ã‚‚å³æ™‚è¡¨ç¤º
    showSosBanner(payload || {});
  };
})();
</script>
</body>
</html>
