<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ã‚­ãƒ£ã‚¹ãƒˆç®¡ç†ï¼ˆé¢æ¥æƒ…å ±ã¤ãï¼‰ v1.3-fix</title>
<style>
  :root{
    --gap:6px; --radius:10px; --bg:#f7f7f8; --panel:#ffffff; --text:#222;
    --muted:#667085; --line:#e5e7eb; --accent:#2563eb; --sidebar:#0f172a; --sidebarText:#e2e8f0;
    --sidebarW:160px; --wrapW:1160px; --cardH:165px; --shadow:0 8px 24px rgba(16,24,40,.08);
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:13px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue","Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic UI",Meiryo,sans-serif;overflow:hidden;}

  /* Sidebar */
  .sidebar{position:fixed; inset:0 auto 0 0; width:var(--sidebarW); background:var(--sidebar); color:var(--sidebarText); display:flex; flex-direction:column; padding:14px 10px; gap:12px;}
  .side-logo{display:flex; align-items:center; justify-content:center; padding:8px 6px;}
  .side-logo img{width:86%; height:auto; object-fit:contain}
  .side-head{padding:4px 6px 0; font-weight:700; font-size:12px; opacity:.9}
  .side-list{list-style:none;margin:0;padding:4px}
  .side-list li{margin:0; padding:0;}
  .side-list a{display:flex; align-items:center; gap:6px; padding:6px 8px; border-radius:8px; cursor:pointer; font-size:12px; color:var(--sidebarText); text-decoration:none;}
  .side-list a:hover{background:rgba(255,255,255,.06)}
  .side-list a.active{background:rgba(255,255,255,.12)}
  /* è¿½åŠ : ã‚°ãƒ«ãƒ¼ãƒ—ç”¨ */
  .side-group{margin-bottom:8px;}
  .side-sec{padding:4px 6px 0; font-weight:700; font-size:12px; opacity:.9;}

  /* Main */
  .main{margin-left:var(--sidebarW); height:100vh; display:flex; flex-direction:column;}
  header{flex:0 0 auto; background:rgba(247,247,248,0.9); backdrop-filter:saturate(1.2) blur(6px); border-bottom:1px solid var(--line);}
  .wrap{max-width:var(--wrapW); margin:0 auto; padding:6px 10px;}

  .head-top{display:grid; grid-template-columns: 1fr auto auto; align-items:center; column-gap:12px; row-gap:6px;}
  .title{font-size:16px; font-weight:700; margin:0;}
  .head-center{display:flex; justify-content:center;}
  .head-right{display:flex; align-items:center; gap:8px; flex-wrap:wrap; justify-self:end;}
  .badge{display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; background:#fff; border:1px solid var(--line); font-size:12px}
  .role{font-weight:700}
  .login{display:flex; align-items:center; gap:6px;}
  .login select{border:1px solid var(--line); border-radius:8px; padding:6px 8px; background:#fff; font-size:12px}
  .print-btn{background:var(--accent); color:#fff; border:1px solid var(--accent); border-radius:8px; padding:6px 10px; font-size:12px}

  /* è¿½åŠ : ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³ */
  .logout-btn{background:#fff; color:#111; border:1px solid var(--line); border-radius:8px; padding:6px 10px; font-size:12px; cursor:pointer}
  .logout-btn:hover{background:#f8fafc}

  .counters{display:flex; gap:8px; flex-wrap:wrap;}
  .counter{background:#fff; border:1px solid var(--line); border-radius:999px; padding:6px 10px; font-size:12px; white-space:nowrap;}

  /* Toolbar */
  .toolbar{display:flex; gap:8px; align-items:center; flex-wrap:wrap; padding:6px 0 2px 0; font-size:12px}
  .toolbar input[type="text"], .toolbar select{border:1px solid var(--line); background:#fff; border-radius:8px; padding:6px 8px; font-size:12px;}
  .radios{display:flex; align-items:center; gap:8px;}
  .radios label{display:flex; align-items:center; gap:4px;}
  .spacer{flex:1 1 auto}

  /* Pager */
  .pager{display:flex; align-items:center; gap:6px; margin-left:6px; white-space:nowrap;}
  .pager button{border:1px solid var(--line); background:#fff; border-radius:8px; padding:4px 8px; cursor:pointer}
  .pager .page{min-width:64px; text-align:center;}
  .pager .count{color:var(--muted); margin-left:4px;}

  /* Board */
  .content{flex:1 1 auto; display:flex; flex-direction:column;}
  .panel{flex:1 1 auto; background:#fff; border:1px solid var(--line); border-radius:0; padding:10px 10px 0 10px; margin:0; width:100%; max-width:none; display:flex; flex-direction:column;}
  .grid-wrap{flex:1 1 auto; overflow:hidden; padding:2px 2px 6px;}
  .grid{display:grid; grid-template-columns:repeat(9,1fr); grid-auto-rows:var(--cardH); gap:var(--gap); height:100%;}

  /* Card */
  .card{background:var(--panel); border:1px solid var(--line); border-radius:8px; overflow:hidden; display:flex; flex-direction:column; cursor:pointer; user-select:none; transition:box-shadow .15s ease;}
  .card:hover{box-shadow:var(--shadow)}
  .photo{position:relative; height:60%;}
  .photo-inner{position:absolute; inset:0; display:flex; align-items:center; justify-content:center; background:#ddd;}
  .photo-inner img{width:100%; height:100%; object-fit:cover}
  .mark{position:absolute; top:4px; left:4px; background:rgba(255,255,255,.92); border:1px solid var(--line); padding:2px 6px; border-radius:999px; font-weight:700;}
  .text{height:40%; display:flex; flex-direction:column; padding:4px 6px; gap:2px; border-top:1px solid var(--line)}
  .name{font-weight:700; font-size:12.5px; line-height:1.2; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  .meta{display:flex; flex-direction:column; gap:1px; font-size:11.5px;}
  .label{color:var(--muted)}
  .value{font-variant-numeric:tabular-nums}

  /* ===== Modal ===== */
  .modal{position:fixed; inset:0; background:rgba(15,23,42,.45); display:none; align-items:center; justify-content:center; z-index:50}
  .modal-content{
    background:#fff; border:1px solid #eef2f7; box-shadow:var(--shadow);
    width:96%; max-width:1280px; height:min(92vh, 920px);
    border-radius:16px; display:flex; flex-direction:column; overflow:hidden;
  }
  .modal-header{
    display:flex; align-items:center; justify-content:space-between;
    padding:12px 14px; border-bottom:1px solid var(--line);
    position:sticky; top:0; background:#fff; z-index:1;
  }
  .modal-title{font-weight:800; font-size:16px; letter-spacing:.02em}
  .modal-actions{display:flex; gap:10px; align-items:center;}
  .btn{border:1px solid var(--line); background:#fff; border-radius:8px; padding:8px 12px; font-size:12px; cursor:pointer}
  .btn.primary{background:var(--accent); color:#fff; border-color:var(--accent)}

  .iv-scroll{flex:1 1 auto; overflow:auto; padding:14px; background:#fafafa;}
  .iv-wrap{display:grid; grid-template-columns: 0.85fr 1.15fr; gap:14px; align-items:start; min-height:0;}

  /* Boxes */
  .box{border:1px solid var(--line); border-radius:12px; background:#fff; min-height:0; display:flex; flex-direction:column;}
  .box .box-h{display:flex; align-items:center; justify-content:space-between; padding:8px 12px; border-bottom:1px solid var(--line); font-weight:800; background:#fff;}
  .box .box-b{padding:10px 12px; min-height:0;}

  /* Profile preview row */
  .profile-top{display:grid; grid-template-columns:140px 1fr; gap:10px; align-items:center; margin-bottom:10px;}
  .avatar{width:100%; aspect-ratio:3/4; border:1px solid #e5e7eb; border-radius:10px; overflow:hidden; background:#f3f4f6; display:flex; align-items:center; justify-content:center;}
  .avatar img{width:100%; height:100%; object-fit:cover}

  /* Form-like grid */
  .grid-info{display:grid; grid-template-columns:152px 1fr; row-gap:6px; column-gap:10px; align-items:start;}
  .ilabel{color:#475569; font-size:12px; letter-spacing:.02em; padding-top:5px;}
  .ivalue{font-size:13px; padding:6px 8px; background:#f8fafc; border:1px solid #eef2f7; border-radius:8px; word-break:break-word;}
  .ivalue.scroll{max-height:9.5em; overflow:auto;}
  .pill{display:inline-flex; gap:6px; align-items:center; padding:3px 8px; border-radius:999px; border:1px solid #e5e7eb; background:#fff; font-size:12px; writing-mode:horizontal-tb;}
  .pill.ok{background:#ecfdf5; border-color:#a7f3d0;}
  .pill.warn{background:#fef9c3; border-color:#fde68a;}
  .pill.no{background:#fef2f2; border-color:#fecaca;}
  .nowrap{white-space:nowrap}

  .subgrid{display:grid; grid-template-columns:repeat(3,1fr); gap:8px; min-height:0;}
  .subcol{border:1px solid #e5e7eb; border-radius:10px; padding:8px 10px; background:#fafafa; min-height:0;}
  .subcol .cap{font-size:12px; color:#475569; margin-bottom:6px; font-weight:700;}

  table.clean{width:100%; border-collapse:collapse; font-size:12.5px;}
  table.clean th, table.clean td{border:1px solid #e5e7eb; padding:6px 8px; text-align:left; vertical-align:top;}
  table.clean th{background:#f8fafc; color:#334155; font-weight:700;}
  .table-wrap{max-height:160px; overflow:auto; border:1px solid #e5e7eb; border-radius:10px; background:#fff;}

  .mini{font-size:12px; color:#64748b}
  .mt8{margin-top:8px}
  .mt12{margin-top:12px}
  .compact{ grid-template-columns:128px 1fr; row-gap:4px; }
  .compact .ilabel{ font-size:11px; padding-top:3px; }
  .compact .ivalue{ font-size:12px; padding:4px 6px; }
  .mono{ font-variant-numeric:tabular-nums; letter-spacing:.02em; }

  /* ===== Photo manager modal ===== */
  .modal-content.photo{max-width:980px; height:min(86vh, 820px);}
  .pm-head{display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-bottom:1px solid var(--line)}
  .pm-body{flex:1 1 auto; padding:12px; display:flex; flex-direction:column; gap:10px; overflow:auto; background:#fafafa;}
  .album{display:grid; grid-template-columns:repeat(6, 1fr); gap:10px;}
  .thumb{position:relative; border:1px solid #e5e7eb; border-radius:10px; overflow:hidden; aspect-ratio:1/1; background:#f3f4f6; cursor:move;}
  .thumb img{position:absolute; inset:0; width:100%; height:100%; object-fit:cover;}
  .thumb .del{position:absolute; top:6px; right:6px; background:rgba(255,255,255,.95); border:1px solid #e5e7eb; border-radius:8px; font-size:12px; padding:2px 6px; cursor:pointer;}
  .thumb.dragging{opacity:.6; outline:2px dashed #94a3b8;}
  .drop-hint{border:2px dashed #94a3b8; background:#f8fafc;}
  .pm-actions{display:flex; gap:8px; justify-content:flex-end; padding:10px 12px; border-top:1px solid var(--line); background:#fff;}
  .pm-toolbar{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
  .pm-drop{border:2px dashed #cbd5e1; border-radius:10px; padding:14px; background:#fff; text-align:center; color:#64748b; cursor:pointer;}
  .pm-drop b{color:#334155}

  @media (max-width: 1100px){ .iv-wrap{grid-template-columns:1fr;} }
  @media (max-width: 900px){ .album{grid-template-columns:repeat(4,1fr);} }
  @media (max-width: 600px){ .album{grid-template-columns:repeat(3,1fr);} }
/* ===== Global SOS Notifier ===== */
.sos-banner{
  position:fixed; inset:0 0 auto 0; height:64px;
  display:flex; align-items:center; justify-content:center;
  background:linear-gradient(90deg,#7f1d1d,#dc2626,#b91c1c);
  color:#fff; z-index:999999; box-shadow:0 4px 20px rgba(0,0,0,.35);
}
.sos-banner .inner{display:flex; align-items:center; gap:12px; font-weight:900; letter-spacing:.05em;}
.sos-banner .msg{font-size:16px;}
/* æ—¢å­˜ã® .btn ãŒç„¡ã„ãƒšãƒ¼ã‚¸å‘ã‘ã®è»½ã„ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ */
.sos-banner .btn{padding:6px 10px; border-radius:8px; border:1px solid rgba(255,255,255,.6); background:rgba(255,255,255,.12); color:#fff; cursor:pointer;}
.flash{animation:flash 1s infinite alternate ease-in-out;}
@keyframes flash { from {opacity:1; transform:scale(1);} to {opacity:.6; transform:scale(1.02);} }
.shake{animation:shake .5s infinite;}
@keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-3px)} 75%{transform:translateX(3px)} }

</style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="side-logo"><a href="dashboard.html" aria-label="Dashboard Top"><img src="img/logo4.png" alt="LOGO"/></a></div>

    <div class="side-group">
      <div class="side-sec">é‹ç”¨æ©Ÿèƒ½</div>
      <ul class="side-list">
        <li><a href="dashboard.html">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a></li>
        <li><a href="schedule.html">ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</a></li>
      </ul>
    </div>

    <div class="side-group">
      <div class="side-sec">ç®¡ç†æ©Ÿèƒ½</div>
      <ul class="side-list">
        <li><a href="cast.html">ã‚­ãƒ£ã‚¹ãƒˆç®¡ç†</a></li>
        <!-- å›ºå®š active ã‚’å‰Šé™¤ -->
        <li><a href="shops.html">åº—èˆ—ç®¡ç†</a></li>
      </ul>
    </div>

    <div class="side-group">
      <div class="side-sec">é€šä¿¡æ©Ÿèƒ½</div>
      <ul class="side-list">
        <li><a href="chat.html">ãƒãƒ£ãƒƒãƒˆï¼ˆLINEï¼‰</a></li>
        <li><a href="sos.html">SOSã‚¢ãƒ©ãƒ¼ãƒˆ</a></li>
      </ul>
    </div>

    <div class="side-group">
      <div class="side-sec">è¨­å®šæ©Ÿèƒ½</div>
      <ul class="side-list">
        <li><a href="request.html">ç”³è«‹ãƒ»æ‰¿èª</a></li>
        <li><a href="setting.html">è¨­å®š</a></li>
      </ul>
    </div>
  </aside>

  <!-- ===== Global SOS Notifierï¼ˆå…¨ãƒšãƒ¼ã‚¸å…±é€šãƒãƒŠãƒ¼ï¼‰ ===== -->
  <div id="sosBanner" class="sos-banner flash shake" role="alert" aria-live="assertive">
    <div class="inner">
      <span style="font-size:20px;">ğŸš¨ SOS</span>
      <span class="msg" id="sosBannerMsg">ã‚­ãƒ£ã‚¹ãƒˆã‹ã‚‰SOSã‚’å—ä¿¡ï¼è‡³æ€¥ç¢ºèªã—ã¦ãã ã•ã„ï¼</span>
      <button class="btn" id="sosOpenBtn">é–‹ã</button>
      <button class="btn" id="sosMuteBtn">åœæ­¢</button>
    </div>
  </div>

  <!-- Main -->
  <div class="main">
    <header>
      <div class="wrap">
        <div class="head-top">
          <h1 class="title">ã‚­ãƒ£ã‚¹ãƒˆç®¡ç†</h1>
          <div class="head-center">
            <div class="counters">
              <div class="counter">ç™»éŒ²ã‚­ãƒ£ã‚¹ãƒˆï¼š<b id="cntAll">0</b> å</div>
              <div class="counter">æ‹…å½“ï¼š<b id="meBadge">â€”</b></div>
            </div>
          </div>
          <div class="head-right">
            <span class="badge"><span class="label">ãƒ­ãƒ¼ãƒ«</span><span class="role" id="roleBadge">ç®¡ç†è€…</span></span>
            <div class="login">
              <label for="loginSelect" class="label">ãƒ­ã‚°ã‚¤ãƒ³:</label>
              <select id="loginSelect">
                <option value="ADMIN:admin">ç®¡ç†è€…ï¼ˆadminï¼‰</option>
                <option value="STAFF:tanaka">æ‹…å½“è€…ï¼ˆç”°ä¸­ï¼‰</option>
                <option value="STAFF:sato">æ‹…å½“è€…ï¼ˆä½è—¤ï¼‰</option>
                <option value="STAFF:suzuki">æ‹…å½“è€…ï¼ˆéˆ´æœ¨ï¼‰</option>
              </select>
            </div>
            <!-- è¿½åŠ : ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³ -->
            <button class="logout-btn" onclick="location.href='index.html'">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            <button class="print-btn" onclick="window.print()">å°åˆ·</button>
          </div>
        </div>

        <div class="toolbar">
          <input id="q" type="text" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆåå‰ãƒ»ãµã‚ŠãŒãªãƒ»ä½æ‰€ãƒ»åº—åãªã©ï¼‰" style="min-width:260px"/>
          <select id="owner"><option value="">æ‹…å½“è€…ï¼ˆã™ã¹ã¦ï¼‰</option><option>ç”°ä¸­</option><option>ä½è—¤</option><option>éˆ´æœ¨</option></select>
          <div class="radios" id="sortRadios">
            <label><input type="radio" name="sortBy" value="kana" checked /> 50éŸ³é †</label>
            <label><input type="radio" name="sortBy" value="wage" /> å¸Œæœ›æ™‚çµ¦é †</label>
            <label><input type="radio" name="sortBy" value="age" /> å¹´é½¢é †</label>
          </div>
          <div class="pager">
            <button onclick="prevPage()">&lt;</button>
            <span class="page" id="pageTop">1 / 1</span>
            <button onclick="nextPage()">&gt;</button>
            <span class="count" id="countTop">å…¨ 0 å</span>
          </div>
          <div class="spacer"></div>
        </div>
      </div>
    </header>

    <!-- Board -->
    <div class="content">
      <div class="panel">
        <div class="grid-wrap">
          <div id="board" class="grid"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Detail Modal -->
  <div id="modal" class="modal" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal-header">
        <div class="modal-title" id="modalTitle">ã‚­ãƒ£ã‚¹ãƒˆè©³ç´°ï¼ˆé¢æ¥æƒ…å ±ï¼‰</div>
        <div class="modal-actions">
          <button class="btn" onclick="openPhotoModal()">å†™çœŸç™»éŒ²/ç·¨é›†</button>
          <button class="btn">ç·¨é›†</button>
          <button class="btn primary">ä¿å­˜</button>
          <button class="btn" onclick="closeModal()">Ã— é–‰ã˜ã‚‹</button>
        </div>
      </div>

      <div class="iv-scroll">
        <div class="iv-wrap">
          <!-- å·¦ã‚«ãƒ©ãƒ  -->
          <div class="box">
            <div class="box-h">
              <span>ç™»éŒ²ç”¨ç´™â‘ ï¼ˆãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ»å¸Œæœ›ãƒ»ç¢ºèªï¼‰</span>
              <button class="btn" onclick="contactByLINE()">LINEã§é€£çµ¡</button>
            </div>
            <div class="box-b">
              <div class="profile-top">
                <div class="avatar" id="avatarPrev"><span class="mini">NO PHOTO</span></div>
                <div class="grid-info" id="sheet1_basic"></div>
              </div>

              <div class="subgrid mt12">
                <div class="subcol">
                  <div class="cap">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</div>
                  <div class="grid-info compact" id="sheet1_profile"></div>
                </div>
                <div class="subcol">
                  <div class="cap">å¸Œæœ›å¾…é‡</div>
                  <div class="grid-info compact" id="sheet1_desire"></div>
                </div>
                <div class="subcol">
                  <div class="cap">è³ªå•é …ç›®</div>
                  <div class="grid-info compact" id="sheet1_questions"></div>
                </div>
              </div>

              <div class="mt12">
                <div class="cap" style="margin:6px 0;">æ°´å•†å£²ã®çµŒé¨“ / NGåº—èˆ—</div>
                <div class="table-wrap">
                  <table class="clean" id="sheet1_exps">
                    <thead><tr><th>åº—å</th><th>æ™‚çµ¦</th><th>NGåº—èˆ—</th></tr></thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>

              <div class="mt12">
                <div class="cap" style="margin:6px 0;">å‚™è€ƒ</div>
                <div class="ivalue scroll" id="sheet1_note">â€”</div>
              </div>

              <div class="mt12">
                <div class="cap" style="margin:6px 0;">èº«åˆ†è¨¼æ˜æ›¸ç¢ºèª / ç”³å‘Š</div>
                <div class="grid-info" id="sheet1_idchecks"></div>
              </div>
            </div>
          </div>

          <!-- å³ã‚«ãƒ©ãƒ  -->
          <div class="box">
            <div class="box-h">ç™»éŒ²ç”¨ç´™â‘¡ï¼ˆå‹•æ©Ÿãƒ»æ¯”è¼ƒãƒ»é¸å®šç†ç”±ï¼‰</div>
            <div class="box-b">
              <div class="grid-info" id="sheet2_sources"></div>
              <div class="mt12">
                <div class="cap" style="margin:6px 0;">ãŠä»•äº‹ã‚’å§‹ã‚ã‚‹ãã£ã‹ã‘</div>
                <div class="ivalue scroll" id="sheet2_motivation">â€”</div>
              </div>
              <div class="mt12">
                <div class="cap" style="margin:6px 0;">ä»–ã®æ´¾é£ä¼šç¤¾ã¨ã®æ¯”è¼ƒ</div>
                <div class="grid-info" id="sheet2_compare"></div>
              </div>
              <div class="mt12">
                <div class="cap" style="margin:6px 0;">ãƒ†ã‚£ã‚¢ãƒ©ã‚’é¸ã‚“ã ç†ç”±</div>
                <div class="ivalue scroll" id="sheet2_reason">â€”</div>
              </div>
              <div class="mt12">
                <div class="cap" style="margin:6px 0;">æ´¾é£å…ˆã®ãŠåº—é¸ã³ã§é‡è¦ãªãƒã‚¤ãƒ³ãƒˆ</div>
                <div class="ivalue scroll" id="sheet2_points">â€”</div>
                <div class="mini mt8">ï¼ˆä¾‹ï¼šæ™‚çµ¦ / æ™‚é–“ / å ´æ‰€ / åºƒã• / å¹´é½¢ / ã‚­ãƒ£ãƒªã‚¢ / ä»–ï¼‰</div>
              </div>
              <div class="mt12">
                <div class="cap" style="margin:6px 0;">ãã®ä»–ï¼ˆå‚™è€ƒï¼‰</div>
                <div class="ivalue scroll" id="sheet2_other">â€”</div>
              </div>
              <div class="mt12">
                <div class="cap" style="margin:6px 0;">30,000å††åˆ¶åº¦ã¸ã®æ‰€æ„Ÿ</div>
                <div class="ivalue scroll" id="sheet2_bonus">â€”</div>
              </div>
            </div>
          </div>
        </div><!-- /.iv-wrap -->
      </div><!-- /.iv-scroll -->
    </div>
  </div>

  <!-- Photo Manager Modal -->
  <div id="photoModal" class="modal" aria-hidden="true">
    <div class="modal-content photo" role="dialog" aria-modal="true" aria-labelledby="photoModalTitle">
      <div class="pm-head">
        <div class="modal-title" id="photoModalTitle">å†™çœŸç®¡ç†</div>
        <div class="pm-toolbar">
          <input id="photoInput" type="file" accept="image/*" multiple style="display:none" />
          <button class="btn" onclick="document.getElementById('photoInput').click()">å†™çœŸã‚’è¿½åŠ </button>
          <button class="btn" onclick="closePhotoModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button class="btn primary" onclick="savePhotos()">ä¿å­˜</button>
        </div>
      </div>
      <div class="pm-body">
        <div class="pm-drop" id="albumDrop"><b>ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ</b> ã¾ãŸã¯ ç”»åƒã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</div>
        <div class="album" id="albumGrid"></div>
      </div>
      <div class="pm-actions">
        <span class="mini">ãƒ‰ãƒ©ãƒƒã‚°ã§ä¸¦ã³æ›¿ãˆï¼Ã—ã§å‰Šé™¤ï¼ä¿å­˜ã§åæ˜ </span>
      </div>
    </div>
  </div>

<script>
/* ===== ç”»åƒãƒ»å®šæ•° ===== */
const CAST_IMAGES = Array.from({length: 10}, (_, i) => `img/cast${i+1}.jpg`);
const OWNERS=["ç”°ä¸­","ä½è—¤","éˆ´æœ¨"];

/* ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ===== */
function loginUserToName(user){ return user==="tanaka" ? "ç”°ä¸­" : user==="sato" ? "ä½è—¤" : "éˆ´æœ¨"; }
function kanaKey(s){ return (s||"").normalize('NFKC'); }
function fmtYen(n){ return "Â¥"+Number(n||0).toLocaleString(); }
function ageFromDOB(dob){
  if(!dob) return "â€”";
  const d = new Date(dob), t=new Date();
  let age = t.getFullYear()-d.getFullYear();
  const m = t.getMonth()-d.getMonth();
  if(m<0 || (m===0 && t.getDate()<d.getDate())) age--;
  return age+"æ­³";
}

/* ===== ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ ===== */
const SAMPLE_EXPS = [
  {shop:"â—‹â—‹ãƒ©ã‚¦ãƒ³ã‚¸", wage:3800, ng:false},
  {shop:"â–³â–³ã‚¯ãƒ©ãƒ–",   wage:4200, ng:true}
];
const ALL = Array.from({length:120}).map((_,i)=>{
  const id = i+1;
  const first = ["ã‚ã„","ã•ãã‚‰","ã¿ã‚†","ãˆã‚Šã‹","ã‚ŠãŠ","ã²ã‹ã‚Š","ã‚†ã„","ãªãª","ã“ã¨ã­","ã¾ã“"][i%10];
  const name = first + (i%7===0?"â˜†":"");
  const furigana = name;
  const owner = OWNERS[i%3];
  const dob = `200${i%10}-0${(i%8)+1}-1${i%9}`;
  const addr = `æ±äº¬éƒ½ã‚µãƒ³ãƒ—ãƒ«åŒº${(i%20)+1}ä¸ç›® ${i%10+1}-${(i%5)+1}-${(i%3)+1}`;
  const tel = `090-${String(1000+i).padStart(4,"0")}-${String(2000+i).padStart(4,"0")}`;
  const email = `cast${id}@example.com`;

  const profile = { height:155 + (i%15), cloth: ["S","M","L"][i%3], shoes: 22 + (i%7) };
  const desire  = {
    daysPerWeek: 3 + (i%3),
    days: ["æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ","æ—¥"].filter((_,d)=> (i+d)%2===0),
    time: { from:"19:00", to: (20+(i%5))+":30" },
    wageMin: 3500 + (i%6)*200,
    monthMin: 30 + (i%5)*2
  };
  const questions = { tattoo: i%5===0 ? "æœ‰" : "ç„¡", pickup: i%4<2 ? "æœ‰" : "ç„¡", alcohol: ["å¼·ã„","æ™®é€š","å¼±ã„"][i%3] };
  const exps = (i%3===0) ? SAMPLE_EXPS : [{shop:"â€”",wage:"â€”",ng:false}];
  const note1 = i%4===0 ? "åœŸæ—¥ç¥ã¯åŸå‰‡ä¸å¯ï¼çµ‚é›»å³å®ˆ" : "â€”";
  const idchecks = { idtype: ["ä½æ°‘ç¥¨+é¡”å†™çœŸä»˜","ãƒ‘ã‚¹ãƒãƒ¼ãƒˆ"][i%2], pledge_drunk: true, pledge_idtruth: true };

  const source = { route: ["å¥³ã®å­ç´¹ä»‹","å‹äººç´¹ä»‹","ã‚¹ã‚«ã‚¦ãƒˆ","ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸","ãã®ä»–ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆ"][i%5], introducer: (i%5<=2) ? ("ç´¹ä»‹è€…A"+(i%3)) : (i%5===4 ? "ã‚µã‚¤ãƒˆX" : "â€”") };
  const motivation = "å­¦è²»ãƒ»ç”Ÿæ´»è²»ã®ãŸã‚ã€‚æ¥å®¢çµŒé¨“ã‚’æ´»ã‹ã—ãŸã„ã€‚";
  const compare = { pattern: ["å½“ç¤¾ã®ã¿","1ã€œ3ç¤¾","3ç¤¾ä»¥ä¸Š"][i%3], agencies: (i%3===0)?"â€”": (i%3===1?"æ´¾é£A / æ´¾é£B":"æ´¾é£A / æ´¾é£B / æ´¾é£C") };
  const reason = "å¯¾å¿œãŒæ—©ãã€æ¡ä»¶ã®äº¤æ¸‰åŠ›ãŒé«˜ã„ã¨æ„Ÿã˜ãŸãŸã‚ã€‚";
  const points = "æ™‚çµ¦ã¨çµ‚é›»è€ƒæ…®ã€ã‚¨ãƒªã‚¢ã€åœ¨ç±å¹´é½¢å±¤ã€å®¢å±¤ã€‚";
  const other = (i%6===0) ? "å®Ÿå®¶ã®éƒ½åˆã§é•·æœŸä¼‘æš‡ã‚ã‚Š" : "â€”";
  const bonusOpinion = "åˆ¶åº¦ãŒã‚ã‹ã‚Šã‚„ã™ããƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ã«ãªã‚‹ã€‚";

  return {
    id,name,furigana,owner,photos:[CAST_IMAGES[i%10]], dob, addr, tel, email,
    sheet1:{ profile, desire, questions, exps, note:note1, idchecks },
    sheet2:{ source, motivation, compare, reason, points, other, bonusOpinion },
    desiredWage: desire.wageMin
  };
});

/* ===== çŠ¶æ…‹ ===== */
let state={ page:1, sortBy:"kana", q:"", owner:"", login:{role:"ADMIN",user:"admin"} };
let currentCastId = null;

/* ===== ãƒ­ãƒ¼ãƒ«åˆ¥ï¼šæ‹…å½“è€…ãƒ‰ãƒ­ãƒƒãƒ—æ´»æ€§åˆ¶å¾¡ ===== */
function updateOwnerOptionsByRole(){
  const ownerSel = document.getElementById('owner'); if(!ownerSel) return;
  const { role, user } = state.login; const myName = loginUserToName(user);
  Array.from(ownerSel.options).forEach(opt=>{
    if(role==="ADMIN"){ opt.disabled=false; }
    else{ opt.disabled = (opt.value!==myName); }
  });
  if(role==="STAFF"){ ownerSel.value=myName; state.owner=myName; }
}

/* ===== ã‚¤ãƒ™ãƒ³ãƒˆ ===== */
loginSelect.addEventListener('change', ()=>{
  const [role,user]=loginSelect.value.split(':');
  state.login={role,user};
  document.getElementById('roleBadge').textContent=(role==="ADMIN"?"ç®¡ç†è€…":"æ‹…å½“è€…");
  document.getElementById('meBadge').textContent = loginUserToName(user);
  document.getElementById('owner').parentElement.style.display="flex";
  updateOwnerOptionsByRole();
  state.page=1; render();
});
document.getElementById('q').addEventListener('input',(e)=>{ state.q=e.target.value.trim(); state.page=1; render(); });
document.getElementById('sortRadios').addEventListener('change',(e)=>{ if(e.target.name==="sortBy"){ state.sortBy=e.target.value; state.page=1; render(); }});
document.getElementById('owner').addEventListener('change',(e)=>{
  if(state.login.role==="STAFF"){
    const myName=loginUserToName(state.login.user);
    if(e.target.value!==myName){ e.target.value=myName; }
    state.owner=myName;
  }else{
    state.owner=e.target.value;
  }
  state.page=1; render();
});

/* ===== çµã‚Šè¾¼ã¿ãƒ»ä¸¦ã³æ›¿ãˆ ===== */
function filtered(){
  const q=state.q.toLowerCase();
  const list = ALL.filter(c=>{
    if(state.login.role==="STAFF" && c.owner!==loginUserToName(state.login.user)) return false;
    if(state.login.role==="ADMIN" && state.owner && c.owner!==state.owner) return false;
    if(!q) return true;
    const s=[c.name,c.furigana,c.addr,c.email,c.owner, ...(c.sheet1?.exps||[]).map(x=>x.shop)].join(" ").toLowerCase();
    return s.includes(q);
  });
  if(state.sortBy==="kana") list.sort((a,b)=>kanaKey(a.name).localeCompare(kanaKey(b.name)));
  else if(state.sortBy==="wage") list.sort((a,b)=> (b.desiredWage||0)-(a.desiredWage||0));
  else if(state.sortBy==="age") list.sort((a,b)=> {
    const aa=(a.dob?new Date().getFullYear()-new Date(a.dob).getFullYear():0);
    const bb=(b.dob?new Date().getFullYear()-new Date(b.dob).getFullYear():0);
    return aa-bb;
  });
  return list;
}

/* ===== ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° ===== */
function render(){
  const list=filtered();
  const per=32; const max=Math.max(1, Math.ceil(list.length/per));
  if(state.page>max) state.page=max;
  const start=(state.page-1)*per; const pageCards=list.slice(start,start+per);

  document.getElementById('board').innerHTML = pageCards.map(cardHtml).join('');
  document.getElementById('cntAll').textContent = ALL.length;
  document.getElementById('countTop').textContent=`å…¨ ${list.length} å`;
  document.getElementById('pageTop').textContent=`${state.page} / ${max}`;
}

/* ===== ãƒšãƒ¼ã‚¸ãƒ£ ===== */
function prevPage(){ if(state.page>1){ state.page--; render(); } }
function nextPage(){ const max=Math.max(1, Math.ceil(filtered().length / 32)); if(state.page<max){ state.page++; render(); } }

/* ===== ã‚«ãƒ¼ãƒ‰HTML ===== */
function cardHtml(d){
  const img=d.photos?.[0]?`<img src="${d.photos[0]}" alt="">`:'';
  return `
  <div class="card" onclick="openModal(${d.id})">
    <div class="photo">
      <span class="mark">${d.sheet1?.questions?.alcohol||"â€”"}</span>
      <div class="photo-inner">${img || "PHOTO"}</div>
    </div>
    <div class="text">
      <div class="name" title="${d.name}">${d.name}</div>
      <div class="meta">
        <div class="line"><span class="label">æ‹…å½“</span><span class="value">${d.owner}</span></div>
        <div class="line"><span class="label">å¸Œæœ›æ™‚çµ¦</span><span class="value">${fmtYen(d.desiredWage)}ã€œ</span></div>
      </div>
    </div>
  </div>`;
}

/* ===== ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆè©³ç´°ï¼‰ ===== */
function openModal(id){
  currentCastId = id;
  const c=ALL.find(x=>x.id===id); if(!c) return;

  const basic = [
    ["ãµã‚ŠãŒãª", c.furigana||"â€”"],
    ["æ°å", c.name||"â€”"],
    ["ç”Ÿå¹´æœˆæ—¥", (c.dob||"â€”")+"ï¼ˆ"+ageFromDOB(c.dob)+"ï¼‰"],
    ["ç¾ä½æ‰€", c.addr||"â€”"],
    ["TEL", c.tel||"â€”"],
    ["ã‚¢ãƒ‰ãƒ¬ã‚¹", c.email||"â€”"]
  ];
  document.getElementById('sheet1_basic').innerHTML = basic.map(row).join('');

  const p = c.sheet1.profile||{};
  document.getElementById('sheet1_profile').innerHTML = [
    ["èº«é•·", p.height?`<span class="mono">${p.height}</span> cm`:"â€”"],
    ["æœã®ã‚µã‚¤ã‚º", p.cloth? `${p.cloth} ã‚µã‚¤ã‚º`:"â€”"],
    ["é´ã®ã‚µã‚¤ã‚º", p.shoes?`<span class="mono">${p.shoes}</span> cm`:"â€”"],
  ].map(([k,v])=>`<div class="ilabel">${k}</div><div class="ivalue nowrap">${v}</div>`).join('');

  const d = c.sheet1.desire||{};
  const daysTxt = (d.days||[]).join("ãƒ»") || "â€”";
  const timeTxt = (d.time?`<span class="mono">${d.time.from}</span> ã€œ <span class="mono">${d.time.to}</span>`:"â€”");
  const wageTxt = `${d.wageMin?`<span class="mono">${fmtYen(d.wageMin)}</span> ä»¥ä¸Š`:"â€”"}ã€€/ã€€${d.monthMin?`<span class="mono">${d.monthMin}</span> ä¸‡å††ä»¥ä¸Š`:"â€”"}`;
  document.getElementById('sheet1_desire').innerHTML = [
    ["å‡ºå‹¤æ—¥æ•°", d.daysPerWeek?`é€± <span class="mono">${d.daysPerWeek}</span> æ—¥ï¼ˆ${daysTxt}ï¼‰`:"â€”"],
    ["å‹¤å‹™æ™‚é–“", timeTxt],
    ["æ™‚çµ¦ãƒ»æœˆçµ¦", wageTxt],
  ].map(([k,v])=>`<div class="ilabel">${k}</div><div class="ivalue nowrap">${v}</div>`).join('');

  const q = c.sheet1.questions||{};
  document.getElementById('sheet1_questions').innerHTML = [
    ["ã‚¿ãƒˆã‚¥ãƒ¼", tag(q.tattoo==="æœ‰"?"æœ‰":"ç„¡", q.tattoo==="æœ‰"?"warn":"ok")],
    ["é€è¿ã®è¦å¦", tag(q.pickup||"â€”", q.pickup==="æœ‰"?"ok":"")],
    ["ãŠé…’ã®å¼·ã•", tag(q.alcohol||"â€”","")],
  ].map(row).join('');

  const tb = document.querySelector('#sheet1_exps tbody');
  tb.innerHTML = (c.sheet1.exps||[]).map(e=>`
    <tr>
      <td>${e.shop||"â€”"}</td>
      <td>${e.wage==="â€”"?"â€”":fmtYen(e.wage)}</td>
      <td>${e.ng?tag("NG","no"):tag("â€”","")}</td>
    </tr>
  `).join('') || `<tr><td colspan="3">â€”</td></tr>`;

  document.getElementById('sheet1_note').textContent = c.sheet1.note||"â€”";
  const idc = c.sheet1.idchecks||{};
  document.getElementById('sheet1_idchecks').innerHTML = [
    ["èº«åˆ†è¨¼æ˜æ›¸ç¢ºèª", idc.idtype||"â€”"],
    ["å®£èª“ï¼ˆé£²é…’é‹è»¢ã—ãªã„ï¼‰", tag(idc.pledge_drunk?"â–¡ æ¸ˆ":"â–¡ æœª","")],
    ["å®£èª“ï¼ˆèº«åˆ†è¨¼å½ã‚Šãªã—ãƒ»æºå¸¯ï¼‰", tag(idc.pledge_idtruth?"â–¡ æ¸ˆ":"â–¡ æœª","")],
  ].map(row).join('');

  const s = c.sheet2.source||{};
  document.getElementById('sheet2_sources').innerHTML = [
    ["çŸ¥ã£ãŸçµŒè·¯", s.route||"â€”"],
    ["ç´¹ä»‹è€…å / ã‚µã‚¤ãƒˆå", s.introducer||"â€”"]
  ].map(row).join('');

  const cmp = c.sheet2.compare||{};
  document.getElementById('sheet2_motivation').textContent = c.sheet2.motivation||"â€”";
  document.getElementById('sheet2_compare').innerHTML = [
    ["æ¯”è¼ƒçŠ¶æ³", cmp.pattern||"â€”"],
    ["æ´¾é£ä¼šç¤¾å", cmp.agencies||"â€”"],
  ].map(row).join('');
  document.getElementById('sheet2_reason').textContent = c.sheet2.reason||"â€”";
  document.getElementById('sheet2_points').textContent = c.sheet2.points||"â€”";
  document.getElementById('sheet2_other').textContent = c.sheet2.other||"â€”";
  document.getElementById('sheet2_bonus').textContent = c.sheet2.bonusOpinion||"â€”";

  applyAvatar(c.photos);

  document.getElementById('modal').style.display='flex';
  document.getElementById('modalTitle').textContent = `ã‚­ãƒ£ã‚¹ãƒˆè©³ç´°ï¼ˆ${c.name}ï¼‰`;
}
function closeModal(){ document.getElementById('modal').style.display='none'; }
function contactByLINE(){
  const c = ALL.find(x=>x.id===currentCastId);
  if(!c) return;
  alert(`LINEã§ ${c.name} ã•ã‚“ã«é€£çµ¡ï¼ˆãƒ‡ãƒ¢ï¼‰`);
}

function row([k,v]){ return `<div class="ilabel">${k}</div><div class="ivalue">${v??"â€”"}</div>`; }
function tag(txt,klass){ return `<span class="pill ${klass||""}">${txt}</span>`; }
function applyAvatar(photos){
  const box = document.getElementById('avatarPrev');
  if(!box) return;
  box.innerHTML = photos && photos[0] ? `<img src="${photos[0]}" alt="profile">` : `<span class="mini">NO PHOTO</span>`;
}

/* ===== Photo manager ===== */
let photoBuf = [];
let dragFrom = -1;

function openPhotoModal(){
  if(currentCastId==null) return;
  const c = ALL.find(x=>x.id===currentCastId);
  photoBuf = [...(c.photos||[])];
  renderAlbum();
  document.getElementById('photoModal').style.display='flex';
}
function closePhotoModal(){ dragFrom=-1; document.getElementById('photoModal').style.display='none'; }
function savePhotos(){
  const c = ALL.find(x=>x.id===currentCastId);
  c.photos = [...photoBuf];
  applyAvatar(c.photos);
  render();
  closePhotoModal();
}
function renderAlbum(){
  const grid = document.getElementById('albumGrid');
  grid.innerHTML = photoBuf.map((src,i)=>`
    <div class="thumb" draggable="true"
         ondragstart="pmDragStart(event,${i})"
         ondragover="pmDragOver(event,${i})"
         ondragleave="pmDragLeave(event,${i})"
         ondrop="pmDrop(event,${i})">
      <img src="${src}" alt="p${i}">
      <button class="del" onclick="removePhoto(${i})">Ã—</button>
    </div>
  `).join('') || `<div class="mini">ç”»åƒãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã€Œå†™çœŸã‚’è¿½åŠ ã€ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ï¼ãƒ‰ãƒ­ãƒƒãƒ—ã§ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚</div>`;
}
function removePhoto(i){ photoBuf.splice(i,1); renderAlbum(); }

/* ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠï¼ˆã‚¯ãƒªãƒƒã‚¯ or ãƒœã‚¿ãƒ³ï¼‰ */
document.getElementById('photoInput').addEventListener('change', (e)=>{
  addFiles(e.target.files); e.target.value="";
});
const albumDrop = document.getElementById('albumDrop');
albumDrop.addEventListener('click', ()=> document.getElementById('photoInput').click());

/* ãƒ‰ãƒ­ãƒƒãƒ—ã§è¿½åŠ  */
albumDrop.addEventListener('dragover', e=>{ e.preventDefault(); albumDrop.style.background='#f0f6ff'; });
albumDrop.addEventListener('dragleave', ()=>{ albumDrop.style.background='#fff'; });
albumDrop.addEventListener('drop', e=>{
  e.preventDefault(); albumDrop.style.background='#fff';
  if(e.dataTransfer?.files?.length) addFiles(e.dataTransfer.files);
});

/* ç”»åƒèª­ã¿è¾¼ã¿ */
function addFiles(files){
  Array.from(files).forEach(file=>{
    if(!file.type.startsWith('image/')) return;
    const reader = new FileReader();
    reader.onload = e => { photoBuf.push(e.target.result); renderAlbum(); };
    reader.readAsDataURL(file);
  });
}

/* ä¸¦ã³æ›¿ãˆ DnD */
function pmDragStart(e,i){ dragFrom=i; e.dataTransfer.effectAllowed='move'; e.currentTarget.classList.add('dragging'); }
function pmDragOver(e,i){ e.preventDefault(); e.currentTarget.classList.add('drop-hint'); }
function pmDragLeave(e,i){ e.currentTarget.classList.remove('drop-hint'); e.currentTarget.classList.remove('dragging'); }
function pmDrop(e,i){
  e.preventDefault();
  const el=e.currentTarget;
  el.classList.remove('drop-hint'); el.classList.remove('dragging');
  if(dragFrom<0 || dragFrom===i) { dragFrom=-1; return; }
  const [m]=photoBuf.splice(dragFrom,1);
  photoBuf.splice(i,0,m);
  dragFrom=-1;
  renderAlbum();
}

/* ===== åˆæœŸåŒ– ===== */
(function init(){
  document.getElementById('owner').parentElement.style.display="flex";
  updateOwnerOptionsByRole();
  document.getElementById('meBadge').textContent = loginUserToName(state.login.user);
  render();
})();
</script>

<!-- è¿½åŠ : ç¾åœ¨URLã«åŸºã¥ã„ã¦ã‚µã‚¤ãƒ‰ãƒãƒ¼ã® active ã‚’è‡ªå‹•ä»˜ä¸ -->
<script>
(function () {
  const links = document.querySelectorAll('.side-list a');
  if (!links.length) return;

  const here = (location.pathname.split('/').pop() || 'index.html').toLowerCase();

  links.forEach(a => a.classList.remove('active'));
  links.forEach(a => {
    const href = (a.getAttribute('href') || '').split('?')[0].split('#')[0].toLowerCase();
    const isDashIndex = (here === 'index.html' && href === 'dashboard.html');
    if (href === here || isDashIndex) {
      a.classList.add('active');
      a.setAttribute('aria-current', 'page');
    } else {
      a.removeAttribute('aria-current');
    }
  });
})();

/* ===== Global SOS Notifierï¼ˆå…¨ãƒšãƒ¼ã‚¸å…±é€šï¼‰ ===== */
(() => {
  const sosBanner    = document.getElementById('sosBanner');
  const sosBannerMsg = document.getElementById('sosBannerMsg');
  const sosOpenBtn   = document.getElementById('sosOpenBtn');
  const sosMuteBtn   = document.getElementById('sosMuteBtn');

  // --- è¿½åŠ : ãƒŸãƒ¥ãƒ¼ãƒˆã®æ’ä¹…åŒ–ã‚­ãƒ¼ï¼†åˆ¶å¾¡ã‚­ãƒ¼
  const MUTE_KEY = 'sos_muted_v1';
  const CTRL_KEY = 'sos_ctrl_v1';       // {t, cmd:'mute'|'unmute'}
  const CAST_KEY = 'sos_broadcast';     // æ—¢å­˜: SOSå†…å®¹ã®ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆ

  let sosOsc=null, sosCtx=null;

  const isMuted = () => localStorage.getItem(MUTE_KEY) === '1';

  function playSosTone(){
    if (isMuted()) return; // ãƒŸãƒ¥ãƒ¼ãƒˆæ™‚ã¯é³´ã‚‰ã•ãªã„
    try{
      sosCtx = sosCtx || new (window.AudioContext||window.webkitAudioContext)();
      const osc = sosCtx.createOscillator();
      const gain = sosCtx.createGain();
      osc.frequency.value = 880;
      osc.type = "square";
      gain.gain.value = 0.05;
      osc.connect(gain).connect(sosCtx.destination);
      osc.start();
      sosOsc = osc;
    }catch(e){}
  }
  function stopSosTone(){
    try{ if(sosOsc){ sosOsc.stop(); sosOsc.disconnect(); sosOsc=null; } }catch(e){}
  }

  function showSosBanner(payload){
    if (isMuted()) return; // ãƒŸãƒ¥ãƒ¼ãƒˆä¸­ã¯å‡ºã•ãªã„
    const ownerName = payload?.ownerName || payload?.owner || '';
    const castName  = payload?.cast || 'ã‚­ãƒ£ã‚¹ãƒˆ';
    sosBannerMsg.textContent = `ğŸš¨ ${castName} ã•ã‚“ãŒSOSç™ºå ±ï¼ˆæ‹…å½“: ${ownerName}ï¼‰`;
    sosBanner.style.display='flex';
    playSosTone();
  }
  function hideSosBanner(){
    sosBanner.style.display='none';
    stopSosTone();
  }

  // ---- ãƒŸãƒ¥ãƒ¼ãƒˆï¼ã‚¢ãƒ³ãƒŸãƒ¥ãƒ¼ãƒˆï¼ˆå…¨ãƒšãƒ¼ã‚¸å³æ™‚åŒæœŸï¼‰
  function muteSOS(){
    localStorage.setItem(MUTE_KEY, '1');   // æ°¸ç¶šãƒŸãƒ¥ãƒ¼ãƒˆ
    hideSosBanner();
    // ä»–ã‚¿ãƒ–ãƒ»ä»–ãƒšãƒ¼ã‚¸ã¸åˆ¶å¾¡ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆ
    localStorage.setItem(CTRL_KEY, JSON.stringify({ t: Date.now(), cmd:'mute' }));
  }
  function unmuteSOS(){
    localStorage.removeItem(MUTE_KEY);
    localStorage.setItem(CTRL_KEY, JSON.stringify({ t: Date.now(), cmd:'unmute' }));
  }

  // ãƒœã‚¿ãƒ³
  sosOpenBtn?.addEventListener('click', () => {
    hideSosBanner();
    try{ window.location.href = 'sos.html'; }catch(e){}
  });
  sosMuteBtn?.addEventListener('click', muteSOS);

  // ä»–ã‚¿ãƒ–ã‹ã‚‰ã®é€šçŸ¥ï¼†åˆ¶å¾¡ã‚’å—ä¿¡
  window.addEventListener('storage', (e)=>{
    if (e.key === CAST_KEY && e.newValue){
      // SOSå—ä¿¡ï¼ˆãŸã ã—ãƒŸãƒ¥ãƒ¼ãƒˆä¸­ã¯ç„¡è¦–ï¼‰
      if (isMuted()) return;
      try{ showSosBanner(JSON.parse(e.newValue)); }catch(_) {}
    }
    if (e.key === CTRL_KEY && e.newValue){
      // ãƒŸãƒ¥ãƒ¼ãƒˆåˆ¶å¾¡åŒæœŸ
      try{
        const msg = JSON.parse(e.newValue);
        if (msg.cmd === 'mute'){ hideSosBanner(); }
        // 'unmute' ã¯ãƒãƒŠãƒ¼ã‚’å³è¡¨ç¤ºã—ãªã„ï¼ˆæ¬¡ã® SOS ã‚’å¾…ã¤æƒ³å®šï¼‰
      }catch(_){}
    }
  });

  // å…¬é–‹API
  /** å…¨ã‚¿ãƒ–ã¸SOSé…ä¿¡ï¼ˆåŒã‚¿ãƒ–ã‚‚å³æ™‚è¡¨ç¤ºï¼‰ */
  window.broadcastSOS = function(payload){
    localStorage.setItem(CAST_KEY, JSON.stringify(payload || {}));
    if (!isMuted()) showSosBanner(payload || {});
  };
  /** æ˜ç¤ºçš„ã«è¡¨ç¤ºï¼ˆãƒŸãƒ¥ãƒ¼ãƒˆä¸­ã¯å‡ºãªã„ï¼‰ */
  window.showSosBanner = showSosBanner;
  /** ãƒŸãƒ¥ãƒ¼ãƒˆ/è§£é™¤APIï¼ˆä»»æ„ãƒšãƒ¼ã‚¸ã§åˆ©ç”¨å¯ï¼‰ */
  window.muteSOS = muteSOS;
  window.unmuteSOS = unmuteSOS;

  // åˆæœŸçŠ¶æ…‹ï¼šãƒŸãƒ¥ãƒ¼ãƒˆãªã‚‰ç¢ºå®Ÿã«éè¡¨ç¤ºåŒ–
  if (isMuted()) hideSosBanner();
})();
</script>
</body>
</html>
