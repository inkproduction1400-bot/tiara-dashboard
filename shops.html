<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>åº—èˆ—ç®¡ç† v1.4-compact-rect-cards + nominates</title>
<style>
  :root{
    --gap:6px; --radius:10px; --bg:#f7f7f8; --panel:#ffffff; --text:#222;
    --muted:#667085; --line:#e5e7eb; --accent:#2563eb; --sidebar:#0f172a; --sidebarText:#e2e8f0;
    --sidebarW:160px; --wrapW:1160px; --cardH:110px; --shadow:0 8px 24px rgba(16,24,40,.08);
    --cat-lounge:#f0f7ff; --cat-club:#f7f0ff; --cat-gbar:#f0fff7;
    --rankS:#1e40af; --rankS-bg:#dbeafe; --rankA:#065f46; --rankA-bg:#d1fae5;
    --rankB:#92400e; --rankB-bg:#ffedd5; --rankC:#7c2d12; --rankC-bg:#fee2e2;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:13px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue","Noto Sans JP","Yu Gothic UI",Meiryo,sans-serif;overflow:hidden;}

  /* ===== Sidebarï¼ˆå…±é€šï¼‰ ===== */
  .sidebar{position:fixed; inset:0 auto 0 0; width:var(--sidebarW); background:var(--sidebar); color:var(--sidebarText); display:flex; flex-direction:column; padding:14px 10px; gap:12px;}
  .side-logo{display:flex; align-items:center; justify-content:center; padding:8px 6px;}
  .side-logo img{width:86%; height:auto; object-fit:contain}
  .side-group{margin-bottom:8px;}
  .side-sec{padding:4px 6px 0; font-weight:700; font-size:12px; opacity:.9;}
  .side-list{list-style:none;margin:0;padding:4px}
  .side-list li{margin:0; padding:0}
  .side-list a{display:flex; align-items:center; gap:6px; padding:6px 8px; border-radius:8px; cursor:pointer; font-size:12px; color:var(--sidebarText); text-decoration:none}
  .side-list a:hover{background:rgba(255,255,255,.06)}
  .side-list a.active{background:rgba(255,255,255,.12)}

  /* ===== Main ===== */
  .main{margin-left:var(--sidebarW); height:100vh; display:flex; flex-direction:column;}
  header{flex:0 0 auto; background:rgba(247,247,248,0.9); backdrop-filter:saturate(1.2) blur(6px); border-bottom:1px solid var(--line);}
  .wrap{max-width:var(--wrapW); margin:0 auto; padding:6px 10px;}

  .head-top{display:grid; grid-template-columns: 1fr auto auto; align-items:center; column-gap:12px; row-gap:6px;}
  .title{font-size:16px; font-weight:700; margin:0;}
  .head-center{display:flex; justify-content:center;}
  .head-right{display:flex; align-items:center; gap:8px; flex-wrap:wrap; justify-self:end;}
  .badge{display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; background:#fff; border:1px solid var(--line); font-size:12px}
  .role{font-weight:700}
  .login{display:flex; align-items:center; gap:6px;}
  .login select{border:1px solid var(--line); border-radius:8px; padding:6px 8px; background:#fff; font-size:12px}
  .print-btn{background:var(--accent); color:#fff; border:1px solid var(--accent); border-radius:8px; padding:6px 10px; font-size:12px}
  .logout-btn{background:#fff; color:#111; border:1px solid var(--line); border-radius:8px; padding:6px 10px; font-size:12px; cursor:pointer}
  .logout-btn:hover{background:#f8fafc}

  .counters{display:flex; gap:8px; flex-wrap:wrap;}
  .counter{background:#fff; border:1px solid var(--line); border-radius:999px; padding:6px 10px; font-size:12px; white-space:nowrap;}

  /* ===== Toolbar ===== */
  .toolbar{display:flex; gap:8px; align-items:center; flex-wrap:wrap; padding:6px 0 2px 0; font-size:12px}
  .toolbar input[type="text"], .toolbar select{border:1px solid var(--line); background:#fff; border-radius:8px; padding:6px 8px; font-size:12px;}
  .radios{display:flex; align-items:center; gap:8px;}
  .radios label{display:flex; align-items:center; gap:4px;}
  .spacer{flex:1 1 auto}

  /* ===== Pager ===== */
  .pager{display:flex; align-items:center; gap:6px; margin-left:6px; white-space:nowrap;}
  .pager button{border:1px solid var(--line); background:#fff; border-radius:8px; padding:4px 8px; cursor:pointer}
  .pager .page{min-width:64px; text-align:center;}
  .pager .count{color:var(--muted); margin-left:4px;}

  /* ===== Board ===== */
  .content{flex:1 1 auto; display:flex; flex-direction:column;}
  .panel{flex:1 1 auto; background:#fff; border:1px solid var(--line); border-radius:0; padding:10px 10px 0 10px; margin:0; width:100%; max-width:none; display:flex; flex-direction:column;}
  .grid-wrap{flex:1 1 auto; overflow:hidden; padding:2px 2px 8px;}
  .grid{display:grid; grid-template-columns:repeat(10,1fr); grid-auto-rows:var(--cardH); gap:var(--gap); height:100%;}
  @media (min-width:1440px){ .grid{grid-template-columns:repeat(12,1fr);} }
  @media (max-width:1200px){ .grid{grid-template-columns:repeat(10,1fr);} }
  @media (max-width:900px) { .grid{grid-template-columns:repeat(8,1fr);} }
  @media (max-width:700px) { .grid{grid-template-columns:repeat(6,1fr);} }
  @media (max-width:520px) { .grid{grid-template-columns:repeat(3,1fr);} }

  /* ===== Slim Rect Shop Card ===== */
  .card{
    position:relative; background:var(--panel); border:1px solid var(--line); border-radius:10px;
    overflow:hidden; cursor:pointer; user-select:none; transition:box-shadow .15s ease, transform .04s ease;
    padding:10px 12px 12px 12px; display:flex; flex-direction:column; gap:6px;
  }
  .card:hover{box-shadow:var(--shadow)}
  .card:active{transform:scale(0.998)}
  .cat-lounge{ background:var(--cat-lounge); } .cat-club{ background:var(--cat-club); } .cat-gbar{ background:var(--cat-gbar); }

  .rank{position:absolute; top:8px; left:8px; padding:2px 8px; border-radius:999px; font-weight:900; font-size:11px; line-height:1; display:inline-flex; align-items:center; gap:4px; border:1px solid transparent; box-shadow:0 1px 0 rgba(0,0,0,.04); background:#fff;}
  .rank.S{ color:var(--rankS); background:var(--rankS-bg); border-color:#bfdbfe; }
  .rank.A{ color:var(--rankA); background:var(--rankA-bg); border-color:#a7f3d0; }
  .rank.B{ color:var(--rankB); background:var(--rankB-bg); border-color:#fed7aa; }
  .rank.C{ color:var(--rankC); background:var(--rankC-bg); border-color:#fecaca; }

  .name{ margin-top:18px; font-weight:800; font-size:13.5px; line-height:1.35; display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical; overflow:hidden; word-break:break-word;}
  .building{ color:#475569; font-size:12px; line-height:1.35; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}

  /* ===== Modal ===== */
  .modal{position:fixed; inset:0; background:rgba(15,23,42,.45); display:none; align-items:center; justify-content:center; z-index:9999}
  .modal-content{background:#fff; border:1px solid #eef2f7; box-shadow:var(--shadow); width:96%; max-width:1080px; max-height:92vh; border-radius:16px; display:flex; flex-direction:column; overflow:hidden;}
  .modal-header{display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid var(--line);}
  .modal-title{font-weight:800; font-size:16px; letter-spacing:.02em}
  .modal-actions{display:flex; gap:8px; align-items:center;}
  .btn{border:1px solid var(--line); background:#fff; border-radius:8px; padding:8px 12px; font-size:12px; cursor:pointer}
  .btn.primary{background:var(--accent); color:#fff; border-color:var(--accent)}
  .m-body{flex:1 1 auto; overflow:auto; padding:12px; background:#fafafa;}
  .box{border:1px solid var(--line); border-radius:12px; background:#fff; padding:12px; margin-bottom:10px;}

  .grid-info{display:grid; grid-template-columns:152px 1fr 152px 1fr; gap:8px 10px; align-items:center;}
  .grid-info .ilabel{color:#475569; font-size:12px;}
  .grid-info .ivalue input, .grid-info .ivalue select, .grid-info .ivalue textarea{width:100%; padding:8px; border:1px solid #e5e7eb; border-radius:8px; font-size:12px; background:#fff;}
  .grid-info .ivalue.read{padding:6px 8px; background:#f8fafc; border:1px solid #eef2f7; border-radius:8px; }

  .two-cols{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
  .two-cols .ilabel{display:block; margin-bottom:6px; color:#334155; font-weight:700; letter-spacing:.02em;}
  .ta{height:140px; min-height:140px; max-height:140px; resize:none; overflow:auto; border-radius:12px; border:1px solid rgba(99,102,241,.25);
      background:linear-gradient(180deg, #ffffff, #fbfdff 60%, #f8fbff); box-shadow:inset 0 1px 0 rgba(255,255,255,.7), 0 1px 1px rgba(15,23,42,.04);
      padding:10px 12px; line-height:1.5; font-size:12.5px; color:#0f172a; transition:border .2s ease, box-shadow .25s ease, background .25s ease;}
  .ta::placeholder{ color:#9aa5b1; }
  .ta:focus{ outline:none; border-color:rgba(37,99,235,.55); box-shadow:0 0 0 3px rgba(37,99,235,.18), inset 0 1px 0 rgba(255,255,255,.8); background:linear-gradient(180deg, #ffffff, #f9fbff 60%, #f6faff); }
  .two-cols > div{background:#fff; border:1px solid var(--line); border-radius:12px; padding:10px; box-shadow:0 6px 18px rgba(16,24,40,.06);}
  .two-cols textarea{min-height:auto; resize:none;}

  /* ===== æŒ‡åã‚­ãƒ£ã‚¹ãƒˆï¼ˆå³ã‚«ãƒ©ãƒ ã®ä¸­ï¼‰ ===== */
  .nomi-head{display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:6px;}
  .chip{display:inline-flex; align-items:center; gap:6px; border:1px solid var(--line); border-radius:999px; padding:4px 8px; font-size:12px; background:#fff; margin:4px 6px 0 0;}
  .chip .x{cursor:pointer; background:#fee2e2; border:1px solid #fecaca; border-radius:6px; padding:0 6px;}

  /* ===== ã‚­ãƒ£ã‚¹ãƒˆé¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« ===== */
  #castModal .modal-content{max-width:1200px;}
  .picker-toolbar{display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:10px;}
  .picker-toolbar input,.picker-toolbar select{border:1px solid var(--line); border-radius:8px; padding:6px 8px; font-size:12px; background:#fff;}
  .picker-grid{display:grid; grid-template-columns:repeat(6,1fr); gap:10px; max-height:62vh; overflow:auto;}
  @media (max-width: 1100px){ .picker-grid{grid-template-columns:repeat(4,1fr);} }
  @media (max-width: 720px){ .picker-grid{grid-template-columns:repeat(2,1fr);} }
  .cast-card{border:1px solid #e5e7eb; border-radius:12px; overflow:hidden; background:#fff; cursor:pointer; transition:box-shadow .15s ease, transform .04s ease;}
  .cast-card:hover{box-shadow:var(--shadow)}
  .cast-card:active{transform:scale(0.996)}
  .cast-photo{position:relative; aspect-ratio:3/4; background:#f3f4f6;}
  .cast-photo img{position:absolute; inset:0; width:100%; height:100%; object-fit:cover;}
  .cast-body{padding:8px;}
  .cast-name{font-weight:800; font-size:13px; line-height:1.2; margin-bottom:2px;}
  .cast-meta{font-size:12px; color:#475569;}
  .picked{outline:3px solid #2563eb; outline-offset:-3px;}
  .mini-muted{font-size:12px; color:#64748b;}
  /* ===== Global SOS Notifier ===== */
.sos-banner{
  position:fixed; inset:0 0 auto 0; height:64px;
  display:flex; align-items:center; justify-content:center;
  background:linear-gradient(90deg,#7f1d1d,#dc2626,#b91c1c);
  color:#fff; z-index:999999; box-shadow:0 4px 20px rgba(0,0,0,.35);
}
.sos-banner .inner{display:flex; align-items:center; gap:12px; font-weight:900; letter-spacing:.05em;}
.sos-banner .msg{font-size:16px;}
/* æ—¢å­˜ã® .btn ãŒç„¡ã„ãƒšãƒ¼ã‚¸å‘ã‘ã®è»½ã„ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ */
.sos-banner .btn{padding:6px 10px; border-radius:8px; border:1px solid rgba(255,255,255,.6); background:rgba(255,255,255,.12); color:#fff; cursor:pointer;}
.flash{animation:flash 1s infinite alternate ease-in-out;}
@keyframes flash { from {opacity:1; transform:scale(1);} to {opacity:.6; transform:scale(1.02);} }
.shake{animation:shake .5s infinite;}
@keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-3px)} 75%{transform:translateX(3px)} }

</style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="side-logo"><a href="dashboard.html" aria-label="Dashboard Top"><img src="img/logo4.png" alt="LOGO"/></a></div>

    <div class="side-group">
      <div class="side-sec">é‹ç”¨æ©Ÿèƒ½</div>
      <ul class="side-list">
        <li><a href="dashboard.html">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a></li>
        <li><a href="schedule.html">ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</a></li>
      </ul>
    </div>

    <div class="side-group">
      <div class="side-sec">ç®¡ç†æ©Ÿèƒ½</div>
      <ul class="side-list">
        <li><a href="cast.html">ã‚­ãƒ£ã‚¹ãƒˆç®¡ç†</a></li>
        <li><a class="active" href="shops.html">åº—èˆ—ç®¡ç†</a></li>
      </ul>
    </div>

    <div class="side-group">
      <div class="side-sec">é€šä¿¡æ©Ÿèƒ½</div>
      <ul class="side-list">
        <li><a href="chat.html">ãƒãƒ£ãƒƒãƒˆï¼ˆLINEï¼‰</a></li>
        <li><a href="sos.html">SOSã‚¢ãƒ©ãƒ¼ãƒˆ</a></li>
      </ul>
    </div>

    <div class="side-group">
      <div class="side-sec">è¨­å®šæ©Ÿèƒ½</div>
      <ul class="side-list">
        <li><a href="request.html">ç”³è«‹ãƒ»æ‰¿èª</a></li>
        <li><a href="setting.html">è¨­å®š</a></li>
      </ul>
    </div>
  </aside>

  <!-- ===== Global SOS Notifierï¼ˆå…¨ãƒšãƒ¼ã‚¸å…±é€šãƒãƒŠãƒ¼ï¼‰ ===== -->
  <div id="sosBanner" class="sos-banner flash shake" role="alert" aria-live="assertive">
    <div class="inner">
      <span style="font-size:20px;">ğŸš¨ SOS</span>
      <span class="msg" id="sosBannerMsg">ã‚­ãƒ£ã‚¹ãƒˆã‹ã‚‰SOSã‚’å—ä¿¡ï¼è‡³æ€¥ç¢ºèªã—ã¦ãã ã•ã„ï¼</span>
      <button class="btn" id="sosOpenBtn">é–‹ã</button>
      <button class="btn" id="sosMuteBtn">åœæ­¢</button>
    </div>
  </div>

  <!-- Main -->
  <div class="main">
    <header>
      <div class="wrap">
        <div class="head-top">
          <h1 class="title">åº—èˆ—ç®¡ç†</h1>
          <div class="head-center">
            <div class="counters">
              <div class="counter">ç™»éŒ²åº—èˆ—ï¼š<b id="cntAll">0</b> ä»¶</div>
              <div class="counter">è¡¨ç¤ºä¸­ï¼š<b id="cntView">0</b> ä»¶</div>
            </div>
          </div>
          <div class="head-right">
            <span class="badge"><span class="label">ãƒ­ãƒ¼ãƒ«</span><span class="role" id="roleBadge">ç®¡ç†è€…</span></span>
            <div class="login">
              <label for="loginSelect" class="label">ãƒ­ã‚°ã‚¤ãƒ³:</label>
              <select id="loginSelect">
                <option value="ADMIN:admin">ç®¡ç†è€…ï¼ˆadminï¼‰</option>
                <option value="STAFF:tanaka">æ‹…å½“è€…ï¼ˆç”°ä¸­ï¼‰</option>
                <option value="STAFF:sato">æ‹…å½“è€…ï¼ˆä½è—¤ï¼‰</option>
                <option value="STAFF:suzuki">æ‹…å½“è€…ï¼ˆéˆ´æœ¨ï¼‰</option>
              </select>
            </div>
            <button class="logout-btn" onclick="location.href='index.html'">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            <button class="print-btn" onclick="window.print()">å°åˆ·</button>
          </div>
        </div>

        <div class="toolbar">
          <input id="q" type="text" placeholder="åº—åãƒ»IDï¼ˆshop-001ï¼‰ãƒ»ç•ªå·ï¼ˆ001ï¼‰ã§æ¤œç´¢" style="min-width:280px"/>
          <div class="radios" id="sortRadios">
            <label><input type="radio" name="sortBy" value="kana" checked /> äº”åéŸ³é †</label>
            <label><input type="radio" name="sortBy" value="rank" /> ãƒ©ãƒ³ã‚¯é †</label>
          </div>
          <label class="label" for="catFilter" style="margin-left:6px;">ã‚«ãƒ†ã‚´ãƒª:</label>
          <select id="catFilter">
            <option value="">ï¼ˆã™ã¹ã¦ï¼‰</option>
            <option>ãƒ©ã‚¦ãƒ³ã‚¸</option>
            <option>ã‚¯ãƒ©ãƒ–</option>
            <option>ã‚¬ãƒ¼ãƒ«ã‚ºãƒãƒ¼</option>
          </select>
          <div class="spacer"></div>
          <div class="pager">
            <button onclick="prevPage()">&lt;</button>
            <span class="page" id="pageTop">1 / 1</span>
            <button onclick="nextPage()">&gt;</button>
            <span class="count" id="countTop">å…¨ 0 ä»¶</span>
          </div>
        </div>
      </div>
    </header>

    <!-- Board -->
    <div class="content">
      <div class="panel">
        <div class="grid-wrap">
          <div id="board" class="grid"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Detail Modal -->
  <div id="modal" class="modal" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal-header">
        <div class="modal-title" id="modalTitle">åº—èˆ—è©³ç´°</div>
        <div class="modal-actions">
          <button class="btn" onclick="closeModal()">Ã— é–‰ã˜ã‚‹</button>
          <button class="btn primary" onclick="saveShop()">ä¿å­˜</button>
        </div>
      </div>
      <div class="m-body">
        <div class="box">
          <div class="grid-info" id="infoGridTop"></div>
        </div>
        <div class="box">
          <div class="two-cols">
            <div>
              <label class="ilabel">ãƒªã‚¯ã‚¨ã‚¹ãƒˆè¦æœ›</label>
              <textarea class="ta" id="reqInput" placeholder="ä¾‹ï¼‰ãŠé…’â—‹ã€é»’æœæŒ‡åãƒ»ç§æœOKã€çµ‚é›»è€ƒæ…®ãªã©"></textarea>
            </div>
            <div>
              <div class="nomi-head">
                <label class="ilabel" style="margin:0">æŒ‡åã‚­ãƒ£ã‚¹ãƒˆ</label>
                <button class="btn primary" onclick="openCastModal()">æŒ‡åã‚’ç™»éŒ²</button>
              </div>
              <div id="nominateList" class="mini-muted">æœªç™»éŒ²ã§ã™ã€‚ã€ŒæŒ‡åã‚’ç™»éŒ²ã€ã‚’æŠ¼ã—ã¦é¸æŠã—ã¦ãã ã•ã„ã€‚</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Cast Picker Modal -->
  <div id="castModal" class="modal" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="castModalTitle">
      <div class="modal-header">
        <div class="modal-title" id="castModalTitle">æŒ‡åã‚­ãƒ£ã‚¹ãƒˆã‚’é¸æŠ</div>
        <div class="modal-actions">
          <button class="btn" onclick="closeCastModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button class="btn primary" onclick="saveCastSelection()">ç™»éŒ²ã—ã¦é–‰ã˜ã‚‹</button>
        </div>
      </div>
      <div class="m-body" style="background:#fff;">
        <div class="picker-toolbar">
          <input id="castQuery" type="text" placeholder="åå‰ãƒ»èª­ã¿ã§æ¤œç´¢" style="min-width:220px">
          <select id="castOwner">
            <option value="">æ‹…å½“è€…ï¼ˆã™ã¹ã¦ï¼‰</option>
            <option>ç”°ä¸­</option><option>ä½è—¤</option><option>éˆ´æœ¨</option>
          </select>
          <div class="radios" id="castSortRadios">
            <label><input type="radio" name="castSortBy" value="kana" checked> 50éŸ³é †</label>
            <label><input type="radio" name="castSortBy" value="wage"> æ™‚çµ¦é †</label>
            <label><input type="radio" name="castSortBy" value="age"> å¹´é½¢é †</label>
          </div>
          <div class="spacer"></div>
          <div class="mini-muted">é¸æŠä¸­: <b id="pickedCount">0</b> å</div>
        </div>
        <div id="pickerGrid" class="picker-grid"></div>
      </div>
    </div>
  </div>

<script>
/* ===== å®šæ•°ãƒ»ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ===== */
const CATS = ["ãƒ©ã‚¦ãƒ³ã‚¸","ã‚¯ãƒ©ãƒ–","ã‚¬ãƒ¼ãƒ«ã‚ºãƒãƒ¼"];
const RANKS = ["S","A","B","C"];
const OWNERS = ["ç”°ä¸­","ä½è—¤","éˆ´æœ¨"];
const CAST_IMAGES = Array.from({length:10},(_,i)=>`img/cast${i+1}.jpg`);
const STAFF_NAME_MAP = { tanaka:"ç”°ä¸­", sato:"ä½è—¤", suzuki:"éˆ´æœ¨" }; // ãƒ­ã‚°ã‚¤ãƒ³å€¤â†’æ—¥æœ¬èªå

function pad3(n){ return String(n).padStart(3,"0"); }
function yen(n){ return "Â¥"+Number(n||0).toLocaleString(); }
function kanaKey(s){ return (s||"").toLowerCase().normalize("NFKC"); }

/* ===== ãƒ€ãƒŸãƒ¼åº—èˆ— 1ã€œ500 åº— ===== */
const SHOPS = Array.from({length:500}, (_,i)=>{
  const idx = i+1, code = pad3(idx), id = "shop-" + code;
  const cat = CATS[i % CATS.length], rank = RANKS[i % RANKS.length];
  const name = `${cat} ãƒ‡ãƒ¢åº—èˆ— ${code}`, yomi = `ã§ã‚‚ã¦ã‚“ã½ ${code}`;
  const addr = `æ±äº¬éƒ½ã‚µãƒ³ãƒ—ãƒ«åŒº${Math.ceil(idx/10)}ä¸ç›® ${idx%10+1}-${(idx%5)+1}-${(idx%3)+1}`;
  const building = ["ã‚¢ãƒ«ã‚«ãƒ‡ã‚£ã‚¢ãƒ“ãƒ«","ç¬¬2é’å±±ãƒ“ãƒ«","ã‚¯ãƒ­ã‚¹ã‚µã‚¤ãƒ‰BLD","è™ãƒé–€ã‚¿ãƒ¯ãƒ¼","æ¾å³¶ä¼šé¤¨"][i%5];
  const wage = 3500 + (i%8)*300;
  const tel = `03-${(600+ (i%300)).toString().padStart(4,'0')}-${(1000+i).toString().padStart(4,'0')}`;
  const req = (i%7===0) ? "ãŠé…’â—‹/â–³ã€20ä»£ä¸­å¿ƒã€é»’æœã‚ã‚Š" : (i%5===0 ? "çµ‚é›»è€ƒæ…®ã€é«ªè‰²è‡ªç”±" : "â€”");
  const note = (i%9===0) ? "é€±æœ«ã«æ··é›‘ã€‚å¢—å“¡ç›¸è«‡ã‚ã‚Š" : "â€”";
  return {id, code, name, yomi, rank, addr, building, wage, tel, cat, req, note, nominees:[]};
});

/* ===== ãƒ€ãƒŸãƒ¼ã‚­ãƒ£ã‚¹ãƒˆ ===== */
const NAMES=["ã‚ã„","ã•ãã‚‰","ã¿ã‚†","ãˆã‚Šã‹","ã‚ŠãŠ","ã²ã‹ã‚Š","ã‚†ã„","ãªãª","ã“ã¨ã­","ã¾ã“","ã¯ã‚‹","ã¾ã„","ã‚ã„","ã‚†ã‚","ã“ã“","ã‚Œã„","ã—ãŠã‚Š","ã‚Šã‚“","ã‚Šã‹","ã¿ãŠ","ã‚†ã‹","ãªã¤","ã—ãšã","ã¤ã°ã•","ã¿ã","ã‚ã‚„","ã‚†ã†","ã‹ã®ã‚“","ã‚ã‚“ãª","ã¾ã©ã‹","ã¿ã•","ã®ã®ã‹","ã¯ãª","ã‚†ãª","ã¿ã“","ã‚‚ã‚‚","ã‹ãˆã§","ã»ã®ã‹","ã‚ã‹ã­","ã¿ã•ã"];
function rnd(min,max){return Math.floor(Math.random()*(max-min+1))+min}
const CASTS = Array.from({length:400},(_,i)=>{
  const id=i+1, name=NAMES[i%NAMES.length]+(i%9===0?"â˜†":"");
  const owner=OWNERS[i%OWNERS.length], age=rnd(18,32);
  const wage=[3200,3500,3800,4200,4800,5200,6000][i%7];
  const photos=[CAST_IMAGES[i%10]];
  return {id,name,owner,age,wage,photos};
});

/* ===== çŠ¶æ…‹ ===== */
let state = { page:1, per:72, sortBy:"kana", q:"", cat:"", login:{role:"ADMIN",user:"admin"}, currentId:null };
let pick = { q:"", owner:"", sortBy:"kana", buf:[] };

/* ===== ãƒ­ã‚°ã‚¤ãƒ³é–¢é€£ãƒ˜ãƒ«ãƒ‘ ===== */
function getLoginOwnerName(){
  if(state.login.role !== "STAFF") return ""; // ç®¡ç†è€…ãªã©
  const key = state.login.user; // tanaka/sato/suzuki
  return STAFF_NAME_MAP[key] || "";
}
function enforceCastOwnerUI(){
  const select = document.getElementById('castOwner');
  if(!select) return;
  const isStaff = state.login.role === "STAFF";
  const myOwner = getLoginOwnerName();

  // ã‚ªãƒ—ã‚·ãƒ§ãƒ³æœ‰åŠ¹/ç„¡åŠ¹
  Array.from(select.options).forEach(opt=>{
    if(!isStaff){
      opt.disabled = false; // ç®¡ç†è€…ã¯å…¨ã¦é¸æŠå¯
    }else{
      // STAFFã¯è‡ªåˆ†ä»¥å¤–ã‚’ç„¡åŠ¹åŒ–ï¼ˆç©ºï¼ã™ã¹ã¦ ã‚‚ç„¡åŠ¹åŒ–ï¼‰
      opt.disabled = (opt.value !== myOwner);
    }
  });

  // å€¤ã®å¼·åˆ¶ & pick.owner é€£å‹•
  if(isStaff){
    select.value = myOwner;
    pick.owner = myOwner;
  }else{
    // ç®¡ç†è€…ã¯ä¿æŒï¼ˆç©ºï¼ã™ã¹ã¦ ã‚‚å¯ï¼‰
    // ã‚‚ã—ç¾åœ¨å€¤ãŒ disabled ã ã£ãŸã‚‰ç©ºã«æˆ»ã™
    if(select.selectedOptions[0]?.disabled){
      select.value = "";
    }
    pick.owner = select.value;
  }
}

/* ===== ç”»é¢ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆä¸€è¦§ï¼‰ ===== */
document.getElementById('q').addEventListener('input', (e)=>{ state.q = e.target.value.trim(); state.page=1; render(); });
document.getElementById('sortRadios').addEventListener('change', (e)=>{ if(e.target.name==="sortBy"){ state.sortBy=e.target.value; state.page=1; render(); }});
document.getElementById('catFilter').addEventListener('change', (e)=>{ state.cat = e.target.value; state.page=1; render(); });

loginSelect.addEventListener('change', ()=>{
  const [role,user]=loginSelect.value.split(':');
  state.login={role,user};
  document.getElementById('roleBadge').textContent=(role==="ADMIN"?"ç®¡ç†è€…":"æ‹…å½“è€…");

  // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®æ‹…å½“è€…ã‚»ãƒ¬ã‚¯ãƒˆåˆ¶å¾¡ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ã„ã¦ãªãã¦ã‚‚OKï¼‰
  enforceCastOwnerUI();
  // å†æç”»ï¼ˆä¸€è¦§ã¯æ‹…å½“è€…ã§ã®è¡¨ç¤ºåˆ¶é™ã¯ç„¡ã—ã ãŒã€å°†æ¥ã®æ‹¡å¼µã«å‚™ãˆã¦ï¼‰
  render();
});

/* ===== ãƒ•ã‚£ãƒ«ã‚¿ & ã‚½ãƒ¼ãƒˆï¼ˆåº—èˆ—ï¼‰ ===== */
function filtered(){
  const q = kanaKey(state.q);
  let arr = SHOPS.filter(s=>{
    if(state.cat && s.cat !== state.cat) return false;
    if(!q) return true;
    const key = kanaKey(s.name + " " + s.id + " " + s.code);
    return key.includes(q);
  });

  if(state.sortBy==="kana"){
    arr.sort((a,b)=> kanaKey(a.yomi||a.name).localeCompare(kanaKey(b.yomi||b.name)) || a.code.localeCompare(b.code));
  } else if(state.sortBy==="rank"){
    const order = {"S":0,"A":1,"B":2,"C":3};
    arr.sort((a,b)=> (order[a.rank]-order[b.rank]) || kanaKey(a.yomi||a.name).localeCompare(kanaKey(b.yomi||b.name)));
  }
  return arr;
}

/* ===== ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆåº—èˆ—ï¼‰ ===== */
function render(){
  const list = filtered();
  const max = Math.max(1, Math.ceil(list.length / state.per));
  if(state.page>max) state.page=max;
  const start=(state.page-1)*state.per;
  const page=list.slice(start,start+state.per);

  document.getElementById('board').innerHTML = page.map(cardHtml).join('');
  document.getElementById('cntAll').textContent = SHOPS.length;
  document.getElementById('cntView').textContent = list.length;
  document.getElementById('pageTop').textContent = `${state.page} / ${max}`;
  document.getElementById('countTop').textContent = `å…¨ ${list.length} ä»¶`;
}
function prevPage(){ if(state.page>1){ state.page--; render(); } }
function nextPage(){ const max=Math.max(1, Math.ceil(filtered().length/state.per)); if(state.page<max){ state.page++; render(); } }

/* ===== åº—èˆ—ã‚«ãƒ¼ãƒ‰ ===== */
function catClass(cat){ return cat==="ãƒ©ã‚¦ãƒ³ã‚¸"?"cat-lounge":cat==="ã‚¯ãƒ©ãƒ–"?"cat-club":"cat-gbar"; }
function rankClass(r){ return (r==="S"||r==="A"||r==="B"||r==="C")?r:"C"; }
function cardHtml(s){
  return `
  <div class="card ${catClass(s.cat)}" data-id="${s.id}" title="${s.name}">
    <div class="rank ${rankClass(s.rank)}">${s.rank}</div>
    <div class="name">${s.name}</div>
    <div class="building">${s.building}</div>
  </div>`;
}

/* ===== åº—èˆ—ã‚«ãƒ¼ãƒ‰ã‚¯ãƒªãƒƒã‚¯ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆå§”è­²ï¼‰ ===== */
document.getElementById('board').addEventListener('click', (e)=>{
  const card = e.target.closest('.card');
  if(!card) return;
  const id = card.getAttribute('data-id');
  if(id) openModal(id);
});

/* ===== åº—èˆ—ãƒ¢ãƒ¼ãƒ€ãƒ« ===== */
function openModal(id){
  const s = SHOPS.find(x=>x.id===id); if(!s) return;
  state.currentId = id;
  document.getElementById('modalTitle').textContent = `åº—èˆ—è©³ç´°ï¼ˆ${s.name}ï¼‰`;

  const top = [
    ["åº—èˆ—ID", `<div class="ivalue read">${s.id}</div>`],
    ["åº—èˆ—ç•ªå·", `<div class="ivalue read">${s.code}</div>`],
    ["ã‚«ãƒ†ã‚´ãƒª", `<div class="ivalue"><select id="catInput">${CATS.map(c=>`<option ${c===s.cat?'selected':''}>${c}</option>`).join('')}</select></div>`],
    ["ãƒ©ãƒ³ã‚¯", `<div class="ivalue"><select id="rankInput">${RANKS.map(r=>`<option ${r===s.rank?'selected':''}>${r}</option>`).join('')}</select></div>`],
    ["åº—å", `<div class="ivalue read">${s.name}</div>`],
    ["ã‚ˆã¿", `<div class="ivalue read">${s.yomi}</div>`],
    ["æ™‚çµ¦", `<div class="ivalue"><input id="wageInput" type="number" step="100" value="${s.wage}"/></div>`],
    ["é›»è©±ç•ªå·", `<div class="ivalue"><input id="telInput" type="tel" value="${s.tel}"/></div>`],
    ["ä½æ‰€", `<div class="ivalue"><input id="addrInput" type="text" value="${s.addr}"/></div>`],
    ["ãƒ“ãƒ«å", `<div class="ivalue"><input id="bldInput" type="text" value="${s.building}"/></div>`],
  ];
  document.getElementById('infoGridTop').innerHTML = top.map(([k,v])=>`<div class="ilabel">${k}</div>${v}`).join('');

  const reqEl  = document.getElementById('reqInput');
  const noteEl = document.getElementById('noteInput');
  if (reqEl)  reqEl.value  = (s.req  === "â€”" ? "" : s.req);
  if (noteEl) noteEl.value = (s.note === "â€”" ? "" : s.note);

  renderNomineesChips(s.nominees);
  document.getElementById('modal').style.display='flex';
}
function closeModal(){ document.getElementById('modal').style.display='none'; state.currentId=null; }

function renderNomineesChips(arr){
  const box = document.getElementById('nominateList');
  if(!arr || arr.length===0){
    box.innerHTML = `<span class="mini-muted">æœªç™»éŒ²ã§ã™ã€‚ã€ŒæŒ‡åã‚’ç™»éŒ²ã€ã‚’æŠ¼ã—ã¦é¸æŠã—ã¦ãã ã•ã„ã€‚ã€</span>`;
    return;
  }
  box.innerHTML = arr.map(id=>{
    const c=CASTS.find(x=>x.id===id);
    const name=c?c.name:`ID:${id}`;
    return `<span class="chip">${name}<button class="x" onclick="removeNominee(${id})">Ã—</button></span>`;
  }).join('');
}
function removeNominee(id){
  const s = SHOPS.find(x=>x.id===state.currentId); if(!s) return;
  s.nominees = (s.nominees||[]).filter(x=>x!==id);
  renderNomineesChips(s.nominees);
}

function saveShop(){
  const id = state.currentId; if(!id) return;
  const s = SHOPS.find(x=>x.id===id); if(!s) return;

  s.cat = document.getElementById('catInput').value;
  s.rank = document.getElementById('rankInput').value;
  s.wage = Number(document.getElementById('wageInput').value)||s.wage;
  s.tel = document.getElementById('telInput').value.trim();
  s.addr = document.getElementById('addrInput').value.trim();
  s.building = document.getElementById('bldInput').value.trim();

  const reqElSave  = document.getElementById('reqInput');
  const noteElSave = document.getElementById('noteInput');
  s.req  = reqElSave  ? (reqElSave.value.trim()  || "â€”") : s.req;
  s.note = noteElSave ? (noteElSave.value.trim() || "â€”") : s.note;

  render();
  closeModal();
  alert("åº—èˆ—æƒ…å ±ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼ˆãƒ‡ãƒ¢ï¼‰");
}

/* ===== ã‚­ãƒ£ã‚¹ãƒˆé¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« ===== */
function openCastModal(){
  const s = SHOPS.find(x=>x.id===state.currentId); if(!s) return;
  pick.buf = [...(s.nominees||[])];

  // ãƒ­ã‚°ã‚¤ãƒ³è€…ã«å¿œã˜ã¦UIåˆ¶å¾¡
  enforceCastOwnerUI();

  // UI ã®å€¤ -> pick
  const ownerSel = document.getElementById('castOwner');
  pick.owner = ownerSel ? ownerSel.value : pick.owner;

  document.getElementById('castQuery').value = pick.q || "";
  document.querySelectorAll('#castSortRadios input[name="castSortBy"]').forEach(r=> r.checked = (r.value===pick.sortBy));
  renderCastGrid();
  document.getElementById('castModal').style.display='flex';
}
function closeCastModal(){ document.getElementById('castModal').style.display='none'; }

document.getElementById('castQuery').addEventListener('input', ()=>{ pick.q = document.getElementById('castQuery').value.trim(); renderCastGrid(); });
document.getElementById('castOwner').addEventListener('change', ()=>{ 
  // ç®¡ç†è€…ã®ã¿è‡ªç”±ã€‚STAFFã¯ enforceCastOwnerUI ãŒå¸¸ã«è‡ªåˆ†ã«æˆ»ã™
  enforceCastOwnerUI();
  renderCastGrid(); 
});
document.getElementById('castSortRadios').addEventListener('change', (e)=>{ if(e.target.name==="castSortBy"){ pick.sortBy=e.target.value; renderCastGrid(); }});

/* å®Ÿéš›ã®ãƒ•ã‚£ãƒ«ã‚¿ã€‚STAFFãƒ­ã‚°ã‚¤ãƒ³æ™‚ã¯å¸¸ã«è‡ªåˆ†æ‹…å½“ã§å¼·åˆ¶ */
function filteredCasts(){
  const q = kanaKey(pick.q||"");
  const effectiveOwner = (state.login.role==="STAFF") ? getLoginOwnerName() : (pick.owner||"");
  let list = CASTS.filter(c=>{
    if(effectiveOwner && c.owner!==effectiveOwner) return false;
    if(q && !kanaKey(c.name).includes(q)) return false;
    return true;
  });
  if(pick.sortBy==="kana") list.sort((a,b)=>kanaKey(a.name).localeCompare(kanaKey(b.name)));
  else if(pick.sortBy==="wage") list.sort((a,b)=>b.wage-a.wage);
  else if(pick.sortBy==="age") list.sort((a,b)=>a.age-b.age);
  return list;
}

function renderCastGrid(){
  const grid=document.getElementById('pickerGrid');
  const list=filteredCasts();
  grid.innerHTML = list.map(c=>castCardHtml(c, pick.buf.includes(c.id))).join('') || `<div class="mini-muted">è©²å½“ã™ã‚‹ã‚­ãƒ£ã‚¹ãƒˆãŒã„ã¾ã›ã‚“</div>`;
  document.getElementById('pickedCount').textContent = pick.buf.length;
}
function castCardHtml(c,selected){
  const img=c.photos?.[0]?`<img src="${c.photos[0]}" alt="">`:'';
  return `
  <div class="cast-card ${selected?'picked':''}" onclick="togglePick(${c.id})" title="${c.name}">
    <div class="cast-photo">${img}</div>
    <div class="cast-body">
      <div class="cast-name">${c.name}</div>
      <div class="cast-meta">æ‹…å½“: ${c.owner} / æ™‚çµ¦ ${yen(c.wage)} / å¹´é½¢ ${c.age}</div>
    </div>
  </div>`;
}
function togglePick(id){
  const i = pick.buf.indexOf(id);
  if(i>=0) pick.buf.splice(i,1); else pick.buf.push(id);
  renderCastGrid();
}
function saveCastSelection(){
  const s = SHOPS.find(x=>x.id===state.currentId); if(!s) return;
  s.nominees = [...pick.buf];
  renderNomineesChips(s.nominees);
  closeCastModal();
}

/* ===== åˆæœŸåŒ– ===== */
(function init(){
  document.getElementById('cntAll').textContent = SHOPS.length;
  // åˆæœŸãƒ­ã‚°ã‚¤ãƒ³è¡¨ç¤ºã¨UIåŒæœŸ
  const [role,user] = document.getElementById('loginSelect').value.split(':');
  state.login = {role,user};
  document.getElementById('roleBadge').textContent=(role==="ADMIN"?"ç®¡ç†è€…":"æ‹…å½“è€…");
  enforceCastOwnerUI();
  render();
})();

/* ===== Global SOS Notifierï¼ˆå…¨ãƒšãƒ¼ã‚¸å…±é€šï¼‰ ===== */
(() => {
  const sosBanner    = document.getElementById('sosBanner');
  const sosBannerMsg = document.getElementById('sosBannerMsg');
  const sosOpenBtn   = document.getElementById('sosOpenBtn');
  const sosMuteBtn   = document.getElementById('sosMuteBtn');

  // --- è¿½åŠ : ãƒŸãƒ¥ãƒ¼ãƒˆã®æ’ä¹…åŒ–ã‚­ãƒ¼ï¼†åˆ¶å¾¡ã‚­ãƒ¼
  const MUTE_KEY = 'sos_muted_v1';
  const CTRL_KEY = 'sos_ctrl_v1';       // {t, cmd:'mute'|'unmute'}
  const CAST_KEY = 'sos_broadcast';     // æ—¢å­˜: SOSå†…å®¹ã®ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆ

  let sosOsc=null, sosCtx=null;

  const isMuted = () => localStorage.getItem(MUTE_KEY) === '1';

  function playSosTone(){
    if (isMuted()) return; // ãƒŸãƒ¥ãƒ¼ãƒˆæ™‚ã¯é³´ã‚‰ã•ãªã„
    try{
      sosCtx = sosCtx || new (window.AudioContext||window.webkitAudioContext)();
      const osc = sosCtx.createOscillator();
      const gain = sosCtx.createGain();
      osc.frequency.value = 880;
      osc.type = "square";
      gain.gain.value = 0.05;
      osc.connect(gain).connect(sosCtx.destination);
      osc.start();
      sosOsc = osc;
    }catch(e){}
  }
  function stopSosTone(){
    try{ if(sosOsc){ sosOsc.stop(); sosOsc.disconnect(); sosOsc=null; } }catch(e){}
  }

  function showSosBanner(payload){
    if (isMuted()) return; // ãƒŸãƒ¥ãƒ¼ãƒˆä¸­ã¯å‡ºã•ãªã„
    const ownerName = payload?.ownerName || payload?.owner || '';
    const castName  = payload?.cast || 'ã‚­ãƒ£ã‚¹ãƒˆ';
    sosBannerMsg.textContent = `ğŸš¨ ${castName} ã•ã‚“ãŒSOSç™ºå ±ï¼ˆæ‹…å½“: ${ownerName}ï¼‰`;
    sosBanner.style.display='flex';
    playSosTone();
  }
  function hideSosBanner(){
    sosBanner.style.display='none';
    stopSosTone();
  }

  // ---- ãƒŸãƒ¥ãƒ¼ãƒˆï¼ã‚¢ãƒ³ãƒŸãƒ¥ãƒ¼ãƒˆï¼ˆå…¨ãƒšãƒ¼ã‚¸å³æ™‚åŒæœŸï¼‰
  function muteSOS(){
    localStorage.setItem(MUTE_KEY, '1');   // æ°¸ç¶šãƒŸãƒ¥ãƒ¼ãƒˆ
    hideSosBanner();
    // ä»–ã‚¿ãƒ–ãƒ»ä»–ãƒšãƒ¼ã‚¸ã¸åˆ¶å¾¡ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆ
    localStorage.setItem(CTRL_KEY, JSON.stringify({ t: Date.now(), cmd:'mute' }));
  }
  function unmuteSOS(){
    localStorage.removeItem(MUTE_KEY);
    localStorage.setItem(CTRL_KEY, JSON.stringify({ t: Date.now(), cmd:'unmute' }));
  }

  // ãƒœã‚¿ãƒ³
  sosOpenBtn?.addEventListener('click', () => {
    hideSosBanner();
    try{ window.location.href = 'sos.html'; }catch(e){}
  });
  sosMuteBtn?.addEventListener('click', muteSOS);

  // ä»–ã‚¿ãƒ–ã‹ã‚‰ã®é€šçŸ¥ï¼†åˆ¶å¾¡ã‚’å—ä¿¡
  window.addEventListener('storage', (e)=>{
    if (e.key === CAST_KEY && e.newValue){
      // SOSå—ä¿¡ï¼ˆãŸã ã—ãƒŸãƒ¥ãƒ¼ãƒˆä¸­ã¯ç„¡è¦–ï¼‰
      if (isMuted()) return;
      try{ showSosBanner(JSON.parse(e.newValue)); }catch(_) {}
    }
    if (e.key === CTRL_KEY && e.newValue){
      // ãƒŸãƒ¥ãƒ¼ãƒˆåˆ¶å¾¡åŒæœŸ
      try{
        const msg = JSON.parse(e.newValue);
        if (msg.cmd === 'mute'){ hideSosBanner(); }
        // 'unmute' ã¯ãƒãƒŠãƒ¼ã‚’å³è¡¨ç¤ºã—ãªã„ï¼ˆæ¬¡ã® SOS ã‚’å¾…ã¤æƒ³å®šï¼‰
      }catch(_){}
    }
  });

  // å…¬é–‹API
  /** å…¨ã‚¿ãƒ–ã¸SOSé…ä¿¡ï¼ˆåŒã‚¿ãƒ–ã‚‚å³æ™‚è¡¨ç¤ºï¼‰ */
  window.broadcastSOS = function(payload){
    localStorage.setItem(CAST_KEY, JSON.stringify(payload || {}));
    if (!isMuted()) showSosBanner(payload || {});
  };
  /** æ˜ç¤ºçš„ã«è¡¨ç¤ºï¼ˆãƒŸãƒ¥ãƒ¼ãƒˆä¸­ã¯å‡ºãªã„ï¼‰ */
  window.showSosBanner = showSosBanner;
  /** ãƒŸãƒ¥ãƒ¼ãƒˆ/è§£é™¤APIï¼ˆä»»æ„ãƒšãƒ¼ã‚¸ã§åˆ©ç”¨å¯ï¼‰ */
  window.muteSOS = muteSOS;
  window.unmuteSOS = unmuteSOS;

  // åˆæœŸçŠ¶æ…‹ï¼šãƒŸãƒ¥ãƒ¼ãƒˆãªã‚‰ç¢ºå®Ÿã«éè¡¨ç¤ºåŒ–
  if (isMuted()) hideSosBanner();
})();
</script>
</body>
</html>
