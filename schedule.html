<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>スケジュール | 月間カレンダー＋派遣リクエスト登録</title>
<style>
  :root{
    --gap:6px; --radius:10px; --bg:#f7f7f8; --panel:#ffffff; --text:#222;
    --muted:#667085; --line:#e5e7eb; --accent:#2563eb; --accent-2:#0ea5e9;
    --sidebar:#0f172a; --sidebarText:#e2e8f0;
    --sidebarW:160px; --wrapW:1160px; --shadow:0 8px 24px rgba(16,24,40,.08);
    --cat-lounge:#f0f7ff; --cat-club:#f7f0ff; --cat-gbar:#f0fff7;
    --rankS:#1e40af; --rankS-bg:#dbeafe; --rankA:#065f46; --rankA-bg:#d1fae5; --rankB:#92400e; --rankB-bg:#ffedd5; --rankC:#7c2d12; --rankC-bg:#fee2e2;
    --cellH:110px; --dowH:calc(var(--cellH) / 2);
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:13px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue","Noto Sans JP","Yu Gothic UI",Meiryo,sans-serif;overflow:hidden;}

  /* Sidebar */
  .sidebar{position:fixed; inset:0 auto 0 0; width:var(--sidebarW); background:var(--sidebar); color:var(--sidebarText); display:flex; flex-direction:column; padding:14px 10px; gap:12px;}
  .side-logo{display:flex; align-items:center; justify-content:center; padding:8px 6px;}
  .side-logo img{width:86%; height:auto; object-fit:contain}
  .side-group{margin-bottom:8px;}
  .side-sec{padding:4px 6px 0; font-weight:700; font-size:12px; opacity:.9;}
  .side-list{list-style:none;margin:0;padding:4px}
  .side-list a{display:flex; align-items:center; gap:6px; padding:6px 8px; border-radius:8px; cursor:pointer; font-size:12px; color:var(--sidebarText); text-decoration:none}
  .side-list a:hover{background:rgba(255,255,255,.06)}
  .side-list a.active{background:rgba(255,255,255,.12)}

  /* Main */
  .main{margin-left:var(--sidebarW); height:100vh; display:flex; flex-direction:column;}
  header{flex:0 0 auto; background:rgba(247,247,248,0.9); backdrop-filter:saturate(1.2) blur(6px); border-bottom:1px solid var(--line);}
  .wrap{max-width:var(--wrapW); margin:0 auto; padding:6px 10px;}
  .head-top{display:grid; grid-template-columns: 1fr auto auto; align-items:center; column-gap:12px; row-gap:6px;}
  .title{font-size:16px; font-weight:700; margin:0;}
  .head-right{display:flex; align-items:center; gap:8px; flex-wrap:wrap; justify-self:end;}
  .badge{display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; background:#fff; border:1px solid var(--line); font-size:12px}
  .role{font-weight:700}
  .login{display:flex; align-items:center; gap:6px;}
  .login select{border:1px solid var(--line); border-radius:8px; padding:6px 8px; background:#fff; font-size:12px}
  .print-btn{background:var(--accent); color:#fff; border:1px solid var(--accent); border-radius:8px; padding:6px 10px; font-size:12px}
  .logout-btn{background:#fff; color:#111; border:1px solid var(--line); border-radius:8px; padding:6px 10px; font-size:12px; cursor:pointer}
  .logout-btn:hover{background:#f8fafc}

  .toolbar{display:flex; gap:8px; align-items:center; flex-wrap:wrap; padding:6px 0 2px 0; font-size:12px}
  .toolbar .spacer{flex:1 1 auto}
  .counters{display:flex; gap:8px; flex-wrap:wrap;}
  .counter{background:#fff; border:1px solid var(--line); border-radius:999px; padding:6px 10px; font-size:12px; white-space:nowrap;}
  .counter .n{font-weight:800;}

  /* Calendar */
  .panel{flex:1 1 auto; background:#fff; border:1px solid var(--line); border-radius:0; padding:10px; margin:0; width:100%; max-width:none; display:flex; flex-direction:column;}
  .cal-head{display:flex; align-items:center; gap:8px; margin-bottom:8px;}
  .cal-head .month{font-weight:800; font-size:15px; margin-right:8px;}
  .cal-grid{display:grid; grid-template-columns:repeat(7,1fr); grid-template-rows: var(--dowH) repeat(6, var(--cellH)); gap:6px; padding:4px 0 6px;}
  .dow{
    font-size:12px; color:#475569; text-align:center;
    display:flex; align-items:center; justify-content:center;
    border:1px solid var(--line); border-radius:10px; background:#fff; font-weight:700;
  }
  .cal-grid .dow:nth-child(1){ color:#b91c1c; background:#fee2e2; border-color:#fecaca; }
  .cal-grid .dow:nth-child(7){ color:#1d4ed8; background:#dbeafe; border-color:#bfdbfe; }

  .cell{border:1px solid var(--line); border-radius:10px; padding:6px; background:#fff; position:relative; cursor:pointer; display:flex; flex-direction:column;}
  .cell.other{background:#fafafa; color:#94a3b8;}
  .date{font-weight:800; font-size:12px; line-height:1;}
  .today .date{color:#0ea5e9;}
  .add{margin-top:auto; align-self:flex-start; border:1px dashed #cbd5e1; background:#f8fafc; padding:4px 8px; border-radius:6px; font-size:12px;}
  .badge-req{position:absolute; top:6px; right:6px; background:var(--accent-2); color:#fff; border-radius:999px; padding:2px 6px; font-size:11px;}
  .list-mini{margin-top:4px; font-size:11.5px; color:#334155; display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical; overflow:hidden;}

  /* Modal (共通) */
  .modal{position:fixed; inset:0; background:rgba(15,23,42,.45); display:none; align-items:center; justify-content:center; z-index:9999}
  .modal-content{background:#fff; border:1px solid #eef2f7; box-shadow:var(--shadow); width:96%; max-width:1080px; max-height:92vh; border-radius:16px; display:flex; flex-direction:column; overflow:hidden;}
  .modal-header{display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid var(--line);}
  .modal-title{font-weight:800; font-size:16px; letter-spacing:.02em}
  .modal-actions{display:flex; gap:8px; align-items:center;}
  .btn{border:1px solid var(--line); background:#fff; border-radius:8px; padding:8px 12px; font-size:12px; cursor:pointer}
  .btn.primary{background:var(--accent); color:#fff; border-color:var(--accent)}
  .m-body{flex:1 1 auto; overflow:auto; padding:12px; background:#fafafa;}
  .box{border:1px solid var(--line); border-radius:12px; background:#fff; padding:12px; margin-bottom:10px;}

  /* Shop picker */
  .picker-toolbar{display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:10px;}
  .picker-toolbar input,.picker-toolbar select{border:1px solid var(--line); border-radius:8px; padding:6px 8px; font-size:12px; background:#fff;}
  .grid-shops{display:grid; grid-template-columns:repeat(4,1fr); gap:8px; max-height:60vh; overflow:auto;}
  @media (max-width: 900px){ .grid-shops{grid-template-columns:repeat(2,1fr);} }
  .s-card{border:1px solid var(--line); border-radius:10px; padding:10px; background:#fff; cursor:pointer; transition:box-shadow .15s ease; position:relative;}
  .s-card:hover{box-shadow:var(--shadow)}
  .s-card.disabled{opacity:.45; pointer-events:none;}
  .tag{position:absolute; top:6px; right:6px; font-size:11px; background:#e2e8f0; color:#0f172a; border-radius:999px; padding:2px 6px;}
  .s-name{font-weight:800; font-size:13px; margin-bottom:4px;}
  .s-meta{font-size:12px; color:#475569; display:flex; align-items:center; gap:6px; flex-wrap:wrap;}
  .pill{border-radius:999px; border:1px solid var(--line); padding:2px 6px; font-size:11px; background:#fff;}
  .rank.S{ color:#1e40af; background:#dbeafe; border-color:#bfdbfe; }
  .rank.A{ color:#065f46; background:#d1fae5; border-color:#a7f3d0; }
  .rank.B{ color:#92400e; background:#ffedd5; border-color:#fed7aa; }
  .rank.C{ color:#7c2d12; background:#fee2e2; border-color:#fecaca; }

  /* Request form */
  .form-grid{display:grid; grid-template-columns:160px 1fr 160px 1fr; gap:10px 12px; align-items:center;}
  .ilabel{color:#475569; font-size:12px;}
  .ivalue input,.ivalue select,.ivalue textarea{width:100%; padding:8px; border:1px solid #e5e7eb; border-radius:8px; font-size:12px; background:#fff;}
  .ivalue textarea{height:100px; resize:none}
  .note{font-size:12px; color:#64748b;}
  .mini-list li{margin:0 0 8px 14px; font-size:12.5px;}
  .mini-actions{display:inline-flex; gap:6px; margin-left:8px;}
  .mini-btn{border:1px solid var(--line); background:#fff; border-radius:6px; padding:2px 6px; font-size:11px; cursor:pointer}
  .mini-btn.danger{border-color:#fecaca; background:#fee2e2; color:#7f1d1d;}
/* ===== Global SOS Notifier ===== */
.sos-banner{
  position:fixed; inset:0 0 auto 0; height:64px;
  display:flex; align-items:center; justify-content:center;
  background:linear-gradient(90deg,#7f1d1d,#dc2626,#b91c1c);
  color:#fff; z-index:999999; box-shadow:0 4px 20px rgba(0,0,0,.35);
}
.sos-banner .inner{display:flex; align-items:center; gap:12px; font-weight:900; letter-spacing:.05em;}
.sos-banner .msg{font-size:16px;}
/* 既存の .btn が無いページ向けの軽いフォールバック */
.sos-banner .btn{padding:6px 10px; border-radius:8px; border:1px solid rgba(255,255,255,.6); background:rgba(255,255,255,.12); color:#fff; cursor:pointer;}
.flash{animation:flash 1s infinite alternate ease-in-out;}
@keyframes flash { from {opacity:1; transform:scale(1);} to {opacity:.6; transform:scale(1.02);} }
.shake{animation:shake .5s infinite;}
@keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-3px)} 75%{transform:translateX(3px)} }
</style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="side-logo"><a href="dashboard.html" aria-label="Dashboard Top"><img src="img/logo4.png" alt="LOGO"/></a></div>

    <div class="side-group">
      <div class="side-sec">運用機能</div>
      <ul class="side-list">
        <li><a href="dashboard.html">ダッシュボード</a></li>
        <li><a class="active" href="schedule.html">スケジュール</a></li>
      </ul>
    </div>

    <div class="side-group">
      <div class="side-sec">管理機能</div>
      <ul class="side-list">
        <li><a href="cast.html">キャスト管理</a></li>
        <li><a href="shops.html">店舗管理</a></li>
      </ul>
    </div>

    <div class="side-group">
      <div class="side-sec">通信機能</div>
      <ul class="side-list">
        <li><a href="chat.html">チャット（LINE）</a></li>
        <li><a href="sos.html">SOSアラート</a></li>
      </ul>
    </div>

    <div class="side-group">
      <div class="side-sec">設定機能</div>
      <ul class="side-list">
        <li><a href="request.html">申請・承認</a></li>
        <li><a href="setting.html">設定</a></li>
      </ul>
    </div>
  </aside>

  <!-- ===== Global SOS Notifier（全ページ共通バナー） ===== -->
  <div id="sosBanner" class="sos-banner flash shake" role="alert" aria-live="assertive">
    <div class="inner">
      <span style="font-size:20px;">🚨 SOS</span>
      <span class="msg" id="sosBannerMsg">キャストからSOSを受信！至急確認してください！</span>
      <button class="btn" id="sosOpenBtn">開く</button>
      <button class="btn" id="sosMuteBtn">停止</button>
    </div>
  </div>

  <!-- Main -->
  <div class="main">
    <header>
      <div class="wrap">
        <div class="head-top">
          <h1 class="title">スケジュール</h1>
          <div></div>
          <div class="head-right">
            <span class="badge"><span class="label">ロール</span> <span class="role" id="roleBadge">管理者</span></span>
            <div class="login">
              <label for="loginSelect" class="label">ログイン:</label>
              <select id="loginSelect">
                <option value="ADMIN:admin">管理者（admin）</option>
                <option value="STAFF:tanaka">担当者（田中）</option>
                <option value="STAFF:sato">担当者（佐藤）</option>
                <option value="STAFF:suzuki">担当者（鈴木）</option>
              </select>
            </div>
            <button class="logout-btn" onclick="location.href='index.html'">ログアウト</button>
            <button class="print-btn" onclick="window.print()">印刷</button>
          </div>
        </div>

        <div class="toolbar">
          <div class="counters">
            <div class="counter">本日：<span class="n" id="cntToday">0</span> 件</div>
            <div class="counter">明日：<span class="n" id="cntTomorrow">0</span> 件</div>
            <div class="counter">明日以降：<span class="n" id="cntFuture">0</span> 件</div>
          </div>
          <div class="spacer"></div>
          <button class="btn" id="todayBtn">今日へ</button>
        </div>
      </div>
    </header>

    <div class="content">
      <div class="panel">
        <div class="cal-head">
          <button class="btn" id="prevBtn">‹ 前月</button>
          <div class="month" id="monthLabel">0000年 00月</div>
          <button class="btn" id="nextBtn">次月 ›</button>
          <div class="spacer"></div>
        </div>
        <div class="cal-grid" id="calGrid"></div>
      </div>
    </div>
  </div>

  <!-- ====== 選択日のスケジュール ====== -->
  <div id="dayModal" class="modal" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="dayTitle">
      <div class="modal-header">
        <div class="modal-title" id="dayTitle">スケジュール（yyyy-mm-dd）</div>
        <div class="modal-actions">
          <button class="btn" onclick="closeDayModal()">閉じる</button>
          <button class="btn primary" onclick="openPicker()">店舗をセット</button>
        </div>
      </div>
      <div class="m-body">
        <div class="box">
          <div class="ilabel" style="font-weight:700">登録済みリクエスト</div>
          <ul id="reqList" class="mini-list" style="margin:8px 0 0 0; padding:0; list-style:disc inside;"></ul>
          <div id="noReq" class="note">この日に登録はありません。「店舗をセット」から登録してください。</div>
        </div>
        <div class="box">
          <div class="note">※ このページはデモです。保存はブラウザメモリのみです。</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ====== 店舗ピッカー ====== -->
  <div id="pickerModal" class="modal" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="pickerTitle">
      <div class="modal-header">
        <div class="modal-title" id="pickerTitle">店舗を選択</div>
        <div class="modal-actions">
          <button class="btn" onclick="closePicker()">キャンセル</button>
        </div>
      </div>
      <div class="m-body" style="background:#fff;">
        <div class="picker-toolbar">
          <input id="shopQuery" type="text" placeholder="店名・ID（shop-001）・番号（001）で検索" style="min-width:260px">
          <label class="ilabel">カテゴリ:</label>
          <select id="shopCat">
            <option value="">（すべて）</option>
            <option>ラウンジ</option><option>クラブ</option><option>ガールズバー</option>
          </select>
          <label class="ilabel">ランク:</label>
          <select id="shopRank">
            <option value="">（すべて）</option>
            <option>S</option><option>A</option><option>B</option><option>C</option>
          </select>
          <div class="spacer"></div>
          <div class="note">クリックで選択 → リクエスト登録へ</div>
        </div>
        <div id="shopGrid" class="grid-shops"></div>
      </div>
    </div>
  </div>

  <!-- ====== リクエスト登録 ====== -->
  <div id="requestModal" class="modal" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="requestTitle">
      <div class="modal-header">
        <div class="modal-title" id="requestTitle">派遣リクエスト登録</div>
        <div class="modal-actions">
          <button class="btn" onclick="closeRequest()">キャンセル</button>
          <button class="btn primary" onclick="saveRequest()">登録</button>
        </div>
      </div>
      <div class="m-body">
        <div class="box">
          <div class="ilabel" style="font-weight:700">店舗</div>
          <div id="reqShopInfo" class="note">-</div>
        </div>
        <div class="box">
          <div class="form-grid">
            <div class="ilabel">人数</div>
            <div class="ivalue"><input id="fCount" type="number" min="1" step="1" placeholder="例）3"></div>

            <div class="ilabel">年齢層</div>
            <div class="ivalue">
              <select id="fAge">
                <option value="">指定なし</option>
                <option>18-20</option><option>20代前半</option><option>20代後半</option>
                <option>30代中心</option><option>幅広く可</option>
              </select>
            </div>

            <div class="ilabel">飲酒</div>
            <div class="ivalue">
              <select id="fDrink">
                <option>問わず</option><option>飲酒必須</option><option>飲酒不可含む</option>
              </select>
            </div>

            <div class="ilabel">時給上限</div>
            <div class="ivalue"><input id="fWageMax" type="number" step="100" placeholder="例）4500"></div>

            <div class="ilabel">タトゥー</div>
            <div class="ivalue">
              <select id="fTattoo">
                <option>問わず</option><option>NG</option><option>隠せれば可</option>
              </select>
            </div>

            <div class="ilabel">その他メモ</div>
            <div class="ivalue" style="grid-column: span 3;">
              <textarea id="fNote" placeholder="例）黒服指名可、私服OK、終電考慮など"></textarea>
            </div>
          </div>
        </div>
        <div class="box note">
          入力例：人数 3、年齢層 20代前半、飲酒 必須、時給上限 4500、タトゥー NG。
        </div>
      </div>
    </div>
  </div>

<script>
/* ========= 定数・ユーティリティ ========= */
const CATS = ["ラウンジ","クラブ","ガールズバー"];
const RANKS = ["S","A","B","C"];
function pad2(n){return String(n).padStart(2,'0')}
function pad3(n){return String(n).padStart(3,'0')}
function kanaKey(s){ return (s||"").toLowerCase().normalize("NFKC"); }
function fmtYMD(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}` }

/* ========= ダミー店舗 ========= */
const SHOPS = Array.from({length:500}, (_,i)=>{
  const idx = i+1, code = pad3(idx), id = "shop-" + code;
  const cat = CATS[i % CATS.length], rank = RANKS[i % RANKS.length];
  const name = `${cat} デモ店舗 ${pad3(idx)}`, yomi = `でもてんぽ ${pad3(idx)}`;
  const building = ["アルカディアビル","第2青山ビル","クロスサイドBLD","虎ノ門タワー","松島会館"][i%5];
  return {id, code, name, yomi, cat, rank, building};
});

/* ========= 状態 ========= */
let state = {
  login:{role:"ADMIN", user:"admin"},
  cal:{year:(new Date()).getFullYear(), month:(new Date()).getMonth()},
  selectedYMD: fmtYMD(new Date()),
  picker:{ q:"", cat:"", rank:"" },
  currentShopId: null,
  requests: {},              // {'YYYY-MM-DD':[ {shopId,...} ]}
  editingIndex: null         // 日別配列の編集対象インデックス（新規時は null）
};

/* ========= ログインUI ========= */
const loginSelect = document.getElementById('loginSelect');
loginSelect.addEventListener('change', ()=>{
  const [role,user]=loginSelect.value.split(':');
  state.login={role,user};
  document.getElementById('roleBadge').textContent=(role==="ADMIN"?"管理者":"担当者");
  updateToolbarStats();
});

/* ========= カレンダー描画 ========= */
const calGrid = document.getElementById('calGrid');
const monthLabel = document.getElementById('monthLabel');

function buildCalendar(year, month){
  calGrid.innerHTML = "";
  const dows = ["日","月","火","水","木","金","土"];
  for(const w of dows){
    const el = document.createElement('div');
    el.className = 'dow';
    el.textContent = w;
    calGrid.appendChild(el);
  }

  const first = new Date(year, month, 1);
  const startDow = first.getDay();
  const startDate = new Date(year, month, 1-startDow);
  const todayStr = fmtYMD(new Date());
  monthLabel.textContent = `${year}年 ${pad2(month+1)}月`;

  for(let i=0;i<42;i++){
    const d = new Date(startDate); d.setDate(startDate.getDate()+i);
    const ymd = fmtYMD(d);
    const cell = document.createElement('div');
    cell.className = 'cell' + (d.getMonth()!==month?' other':'') + (ymd===todayStr?' today':'');
    cell.dataset.ymd = ymd;

    const date = document.createElement('div');
    date.className = 'date';
    date.textContent = d.getDate();
    cell.appendChild(date);

    const cnt = (state.requests[ymd]?.length)||0;
    if(cnt>0){
      const b=document.createElement('div'); b.className='badge-req'; b.textContent = `${cnt}件`; cell.appendChild(b);
      const list=document.createElement('div'); list.className='list-mini';
      list.textContent = state.requests[ymd].slice(0,3).map(x=>{
        const s=SHOPS.find(a=>a.id===x.shopId); return s?s.name:'?';
      }).join(" / ");
      cell.appendChild(list);
    }

    const add = document.createElement('div'); add.className='add'; add.textContent='＋ 追加'; cell.appendChild(add);
    calGrid.appendChild(cell);
  }

  updateToolbarStats();
}

// クリック（イベント委譲）
calGrid.addEventListener('click', (e)=>{
  const cell = e.target.closest('.cell'); if(!cell) return;
  state.selectedYMD = cell.dataset.ymd;
  openDayModal();
});

document.getElementById('prevBtn').onclick = ()=>{
  const m = new Date(state.cal.year, state.cal.month-1, 1);
  state.cal.year = m.getFullYear(); state.cal.month = m.getMonth();
  buildCalendar(state.cal.year, state.cal.month);
}
document.getElementById('nextBtn').onclick = ()=>{
  const m = new Date(state.cal.year, state.cal.month+1, 1);
  state.cal.year = m.getFullYear(); state.cal.month = m.getMonth();
  buildCalendar(state.cal.year, state.cal.month);
}
document.getElementById('todayBtn').onclick = ()=>{
  const t=new Date();
  state.cal.year=t.getFullYear(); state.cal.month=t.getMonth(); state.selectedYMD=fmtYMD(t);
  buildCalendar(state.cal.year, state.cal.month);
}

/* ========= 日別モーダル ========= */
function openDayModal(){
  document.getElementById('dayTitle').textContent = `スケジュール（${state.selectedYMD}）`;
  const listEl = document.getElementById('reqList');
  const noEl = document.getElementById('noReq');
  const arr = state.requests[state.selectedYMD]||[];
  if(arr.length===0){
    listEl.innerHTML="";
    noEl.style.display='block';
  }else{
    noEl.style.display='none';
    listEl.innerHTML = arr.map((r,i)=>{
      const s=SHOPS.find(x=>x.id===r.shopId);
      const name=s?`${s.name}（${s.id}/${s.code}）`:'?';
      const summary = `人数:${r.count??'-'} / 年齢:${r.age||'-'} / 飲酒:${r.drink||'-'} / 上限:${r.wageMax??'-'} / タトゥー:${r.tattoo||'-'}`;
      return `<li>
        ${name} - ${summary}
        <span class="mini-actions">
          <button class="mini-btn" onclick="editRequest(${i})">編集</button>
          <button class="mini-btn danger" onclick="deleteRequest(${i})">削除</button>
        </span>
      </li>`;
    }).join('');
  }
  document.getElementById('dayModal').style.display='flex';
}
function closeDayModal(){ document.getElementById('dayModal').style.display='none'; }

/* ========= 店舗ピッカー ========= */
function existsForSelectedDay(shopId){
  const arr = state.requests[state.selectedYMD]||[];
  return arr.findIndex(r=>r.shopId===shopId);
}
function openPicker(){
  document.getElementById('shopQuery').value = state.picker.q || "";
  document.getElementById('shopCat').value = state.picker.cat || "";
  document.getElementById('shopRank').value = state.picker.rank || "";
  renderShopGrid();
  document.getElementById('pickerModal').style.display='flex';
}
function closePicker(){ document.getElementById('pickerModal').style.display='none'; }

document.getElementById('shopQuery').addEventListener('input', ()=>{ state.picker.q = document.getElementById('shopQuery').value.trim(); renderShopGrid(); });
document.getElementById('shopCat').addEventListener('change', ()=>{ state.picker.cat = document.getElementById('shopCat').value; renderShopGrid(); });
document.getElementById('shopRank').addEventListener('change', ()=>{ state.picker.rank = document.getElementById('shopRank').value; renderShopGrid(); });

function filteredShops(){
  const q = kanaKey(state.picker.q||"");
  let list = SHOPS.filter(s=>{
    if(state.picker.cat && s.cat!==state.picker.cat) return false;
    if(state.picker.rank && s.rank!==state.picker.rank) return false;
    if(!q) return true;
    const key = kanaKey(`${s.name} ${s.id} ${s.code}`);
    return key.includes(q);
  });
  list.sort((a,b)=> (a.yomi||a.name).localeCompare(b.yomi||b.name,'ja') || a.code.localeCompare(b.code));
  return list;
}
function renderShopGrid(){
  const list = filteredShops();
  const grid = document.getElementById('shopGrid');
  grid.innerHTML = list.map(s=>{
    const idx = existsForSelectedDay(s.id);
    return `
    <div class="s-card ${idx>=0?'disabled':''}" data-id="${s.id}">
      ${idx>=0?'<span class="tag">登録済</span>':''}
      <div class="s-name">${s.name}</div>
      <div class="s-meta">
        <span class="pill">ID ${s.id}</span>
        <span class="pill">#${s.code}</span>
        <span class="pill">${s.cat}</span>
        <span class="pill rank ${s.rank}">${s.rank}</span>
        <span class="pill">${s.building}</span>
      </div>
    </div>`;
  }).join('') || `<div class="note">該当する店舗がありません</div>`;
}
document.getElementById('shopGrid').addEventListener('click', (e)=>{
  const card = e.target.closest('.s-card'); if(!card) return;
  const id = card.getAttribute('data-id');
  // 重複チェック
  if (existsForSelectedDay(id) >= 0){
    alert("この店舗は選択日にすでに登録されています。日別一覧の「編集」から内容を修正してください。");
    return;
  }
  const shop = SHOPS.find(x=>x.id===id); if(!shop) return;
  state.currentShopId = id;
  state.editingIndex = null; // 新規
  document.getElementById('reqShopInfo').textContent = `${shop.name}（${shop.id} / ${shop.code} / ${shop.cat} / ${shop.rank}）`;
  closePicker();
  openRequest({preset:null});
});

/* ========= リクエスト登録（新規/編集） ========= */
function openRequest({preset}={}){
  // preset があればセット、無ければ初期化
  document.getElementById('fCount').value   = preset?.count ?? "";
  document.getElementById('fAge').value     = preset?.age   ?? "";
  document.getElementById('fDrink').value   = preset?.drink ?? "問わず";
  document.getElementById('fWageMax').value = preset?.wageMax ?? "";
  document.getElementById('fTattoo').value  = preset?.tattoo ?? "問わず";
  document.getElementById('fNote').value    = preset?.note  ?? "";

  // ボタン表示文言（編集時は「更新」）
  document.querySelector('#requestModal .modal-actions .primary').textContent = (state.editingIndex!=null) ? "更新" : "登録";

  document.getElementById('requestModal').style.display='flex';
}
function closeRequest(){ document.getElementById('requestModal').style.display='none'; }

function saveRequest(){
  const rec = {
    shopId: state.currentShopId,
    count: Number(document.getElementById('fCount').value)||null,
    age: document.getElementById('fAge').value,
    drink: document.getElementById('fDrink').value,
    wageMax: Number(document.getElementById('fWageMax').value)||null,
    tattoo: document.getElementById('fTattoo').value,
    note: document.getElementById('fNote').value.trim()
  };
  if(!rec.shopId){ alert("店舗を選択してください"); return; }

  state.requests[state.selectedYMD] = state.requests[state.selectedYMD] || [];

  if(state.editingIndex!=null){
    // 上書き更新
    state.requests[state.selectedYMD][state.editingIndex] = rec;
  }else{
    // 新規: 同一店舗が既にあるか再チェック
    if(existsForSelectedDay(rec.shopId) >= 0){
      alert("同一店舗は同日に重複登録できません。日別一覧の「編集」から修正してください。");
      return;
    }
    state.requests[state.selectedYMD].push(rec);
  }

  closeRequest();
  buildCalendar(state.cal.year, state.cal.month);
  openDayModal(); // 再描画
}

/* ===== 編集／削除アクション ===== */
function editRequest(index){
  const arr = state.requests[state.selectedYMD]||[];
  const rec = arr[index]; if(!rec) return;
  const shop = SHOPS.find(x=>x.id===rec.shopId);
  state.currentShopId = rec.shopId;
  state.editingIndex = index;
  document.getElementById('reqShopInfo').textContent = shop ? `${shop.name}（${shop.id} / ${shop.code} / ${shop.cat} / ${shop.rank}）` : rec.shopId;
  openRequest({preset:rec});
}
function deleteRequest(index){
  if(!confirm("この登録を削除しますか？")) return;
  const arr = state.requests[state.selectedYMD]||[];
  if(index>=0 && index<arr.length){
    arr.splice(index,1);
    if(arr.length===0) delete state.requests[state.selectedYMD];
  }
  buildCalendar(state.cal.year, state.cal.month);
  openDayModal();
}

/* ========= ツールバー統計 ========= */
function updateToolbarStats(){
  const today = new Date();
  const tomorrow = new Date(today); tomorrow.setDate(today.getDate()+1);
  const todayStr = fmtYMD(today);
  const tomorrowStr = fmtYMD(tomorrow);

  const todayCnt = (state.requests[todayStr]?.length) || 0;
  const tomorrowCnt = (state.requests[tomorrowStr]?.length) || 0;

  let futureCnt = 0;
  for(const ymd in state.requests){
    if(ymd > tomorrowStr){
      futureCnt += state.requests[ymd].length;
    }
  }
  document.getElementById('cntToday').textContent = todayCnt;
  document.getElementById('cntTomorrow').textContent = tomorrowCnt;
  document.getElementById('cntFuture').textContent = futureCnt;
}

/* ========= 初期化 ========= */
(function init(){
  const [role,user]=loginSelect.value.split(':');
  state.login={role,user};
  document.getElementById('roleBadge').textContent=(role==="ADMIN"?"管理者":"担当者");

  const t=new Date();
  state.cal.year=t.getFullYear(); state.cal.month=t.getMonth(); state.selectedYMD=fmtYMD(t);
  buildCalendar(state.cal.year, state.cal.month);
})();

/* ===== Global SOS Notifier（全ページ共通） ===== */
(() => {
  const sosBanner    = document.getElementById('sosBanner');
  const sosBannerMsg = document.getElementById('sosBannerMsg');
  const sosOpenBtn   = document.getElementById('sosOpenBtn');
  const sosMuteBtn   = document.getElementById('sosMuteBtn');

  // --- 追加: ミュートの恒久化キー＆制御キー
  const MUTE_KEY = 'sos_muted_v1';
  const CTRL_KEY = 'sos_ctrl_v1';       // {t, cmd:'mute'|'unmute'}
  const CAST_KEY = 'sos_broadcast';     // 既存: SOS内容のブロードキャスト

  let sosOsc=null, sosCtx=null;

  const isMuted = () => localStorage.getItem(MUTE_KEY) === '1';

  function playSosTone(){
    if (isMuted()) return; // ミュート時は鳴らさない
    try{
      sosCtx = sosCtx || new (window.AudioContext||window.webkitAudioContext)();
      const osc = sosCtx.createOscillator();
      const gain = sosCtx.createGain();
      osc.frequency.value = 880;
      osc.type = "square";
      gain.gain.value = 0.05;
      osc.connect(gain).connect(sosCtx.destination);
      osc.start();
      sosOsc = osc;
    }catch(e){}
  }
  function stopSosTone(){
    try{ if(sosOsc){ sosOsc.stop(); sosOsc.disconnect(); sosOsc=null; } }catch(e){}
  }

  function showSosBanner(payload){
    if (isMuted()) return; // ミュート中は出さない
    const ownerName = payload?.ownerName || payload?.owner || '';
    const castName  = payload?.cast || 'キャスト';
    sosBannerMsg.textContent = `🚨 ${castName} さんがSOS発報（担当: ${ownerName}）`;
    sosBanner.style.display='flex';
    playSosTone();
  }
  function hideSosBanner(){
    sosBanner.style.display='none';
    stopSosTone();
  }

  // ---- ミュート／アンミュート（全ページ即時同期）
  function muteSOS(){
    localStorage.setItem(MUTE_KEY, '1');   // 永続ミュート
    hideSosBanner();
    // 他タブ・他ページへ制御ブロードキャスト
    localStorage.setItem(CTRL_KEY, JSON.stringify({ t: Date.now(), cmd:'mute' }));
  }
  function unmuteSOS(){
    localStorage.removeItem(MUTE_KEY);
    localStorage.setItem(CTRL_KEY, JSON.stringify({ t: Date.now(), cmd:'unmute' }));
  }

  // ボタン
  sosOpenBtn?.addEventListener('click', () => {
    hideSosBanner();
    try{ window.location.href = 'sos.html'; }catch(e){}
  });
  sosMuteBtn?.addEventListener('click', muteSOS);

  // 他タブからの通知＆制御を受信
  window.addEventListener('storage', (e)=>{
    if (e.key === CAST_KEY && e.newValue){
      // SOS受信（ただしミュート中は無視）
      if (isMuted()) return;
      try{ showSosBanner(JSON.parse(e.newValue)); }catch(_) {}
    }
    if (e.key === CTRL_KEY && e.newValue){
      // ミュート制御同期
      try{
        const msg = JSON.parse(e.newValue);
        if (msg.cmd === 'mute'){ hideSosBanner(); }
        // 'unmute' はバナーを即表示しない（次の SOS を待つ想定）
      }catch(_){}
    }
  });

  // 公開API
  /** 全タブへSOS配信（同タブも即時表示） */
  window.broadcastSOS = function(payload){
    localStorage.setItem(CAST_KEY, JSON.stringify(payload || {}));
    if (!isMuted()) showSosBanner(payload || {});
  };
  /** 明示的に表示（ミュート中は出ない） */
  window.showSosBanner = showSosBanner;
  /** ミュート/解除API（任意ページで利用可） */
  window.muteSOS = muteSOS;
  window.unmuteSOS = unmuteSOS;

  // 初期状態：ミュートなら確実に非表示化
  if (isMuted()) hideSosBanner();
})();
</script>
</body>
</html>
