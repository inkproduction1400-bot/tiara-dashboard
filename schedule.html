<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ« | æœˆé–“ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼‹æ´¾é£ãƒªã‚¯ã‚¨ã‚¹ãƒˆç™»éŒ²</title>
<style>
  :root{
    --gap:6px; --radius:10px; --bg:#f7f7f8; --panel:#ffffff; --text:#222;
    --muted:#667085; --line:#e5e7eb; --accent:#2563eb; --accent-2:#0ea5e9;
    --sidebar:#0f172a; --sidebarText:#e2e8f0;
    --sidebarW:160px; --wrapW:1160px; --shadow:0 8px 24px rgba(16,24,40,.08);
    --cat-lounge:#f0f7ff; --cat-club:#f7f0ff; --cat-gbar:#f0fff7;
    --rankS:#1e40af; --rankS-bg:#dbeafe; --rankA:#065f46; --rankA-bg:#d1fae5; --rankB:#92400e; --rankB-bg:#ffedd5; --rankC:#7c2d12; --rankC-bg:#fee2e2;
    --cellH:110px; --dowH:calc(var(--cellH) / 2);
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:13px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue","Noto Sans JP","Yu Gothic UI",Meiryo,sans-serif;overflow:hidden;}

  /* Sidebar */
  .sidebar{position:fixed; inset:0 auto 0 0; width:var(--sidebarW); background:var(--sidebar); color:var(--sidebarText); display:flex; flex-direction:column; padding:14px 10px; gap:12px;}
  .side-logo{display:flex; align-items:center; justify-content:center; padding:8px 6px;}
  .side-logo img{width:86%; height:auto; object-fit:contain}
  .side-group{margin-bottom:8px;}
  .side-sec{padding:4px 6px 0; font-weight:700; font-size:12px; opacity:.9;}
  .side-list{list-style:none;margin:0;padding:4px}
  .side-list a{display:flex; align-items:center; gap:6px; padding:6px 8px; border-radius:8px; cursor:pointer; font-size:12px; color:var(--sidebarText); text-decoration:none}
  .side-list a:hover{background:rgba(255,255,255,.06)}
  .side-list a.active{background:rgba(255,255,255,.12)}

  /* Main */
  .main{margin-left:var(--sidebarW); height:100vh; display:flex; flex-direction:column;}
  header{flex:0 0 auto; background:rgba(247,247,248,0.9); backdrop-filter:saturate(1.2) blur(6px); border-bottom:1px solid var(--line);}
  .wrap{max-width:var(--wrapW); margin:0 auto; padding:6px 10px;}
  .head-top{display:grid; grid-template-columns: 1fr auto auto; align-items:center; column-gap:12px; row-gap:6px;}
  .title{font-size:16px; font-weight:700; margin:0;}
  .head-right{display:flex; align-items:center; gap:8px; flex-wrap:wrap; justify-self:end;}
  .badge{display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; background:#fff; border:1px solid var(--line); font-size:12px}
  .role{font-weight:700}
  .login{display:flex; align-items:center; gap:6px;}
  .login select{border:1px solid var(--line); border-radius:8px; padding:6px 8px; background:#fff; font-size:12px}
  .print-btn{background:var(--accent); color:#fff; border:1px solid var(--accent); border-radius:8px; padding:6px 10px; font-size:12px}
  .logout-btn{background:#fff; color:#111; border:1px solid var(--line); border-radius:8px; padding:6px 10px; font-size:12px; cursor:pointer}
  .logout-btn:hover{background:#f8fafc}

  .toolbar{display:flex; gap:8px; align-items:center; flex-wrap:wrap; padding:6px 0 2px 0; font-size:12px}
  .toolbar .spacer{flex:1 1 auto}
  .counters{display:flex; gap:8px; flex-wrap:wrap;}
  .counter{background:#fff; border:1px solid var(--line); border-radius:999px; padding:6px 10px; font-size:12px; white-space:nowrap;}
  .counter .n{font-weight:800;}

  /* Calendar */
  .panel{flex:1 1 auto; background:#fff; border:1px solid var(--line); border-radius:0; padding:10px; margin:0; width:100%; max-width:none; display:flex; flex-direction:column;}
  .cal-head{display:flex; align-items:center; gap:8px; margin-bottom:8px;}
  .cal-head .month{font-weight:800; font-size:15px; margin-right:8px;}
  .cal-grid{display:grid; grid-template-columns:repeat(7,1fr); grid-template-rows: var(--dowH) repeat(6, var(--cellH)); gap:6px; padding:4px 0 6px;}
  .dow{
    font-size:12px; color:#475569; text-align:center;
    display:flex; align-items:center; justify-content:center;
    border:1px solid var(--line); border-radius:10px; background:#fff; font-weight:700;
  }
  .cal-grid .dow:nth-child(1){ color:#b91c1c; background:#fee2e2; border-color:#fecaca; }
  .cal-grid .dow:nth-child(7){ color:#1d4ed8; background:#dbeafe; border-color:#bfdbfe; }

  .cell{border:1px solid var(--line); border-radius:10px; padding:6px; background:#fff; position:relative; cursor:pointer; display:flex; flex-direction:column;}
  .cell.other{background:#fafafa; color:#94a3b8;}
  .date{font-weight:800; font-size:12px; line-height:1;}
  .today .date{color:#0ea5e9;}
  .add{margin-top:auto; align-self:flex-start; border:1px dashed #cbd5e1; background:#f8fafc; padding:4px 8px; border-radius:6px; font-size:12px;}
  .badge-req{position:absolute; top:6px; right:6px; background:var(--accent-2); color:#fff; border-radius:999px; padding:2px 6px; font-size:11px;}
  .list-mini{margin-top:4px; font-size:11.5px; color:#334155; display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical; overflow:hidden;}

  /* Modal (å…±é€š) */
  .modal{position:fixed; inset:0; background:rgba(15,23,42,.45); display:none; align-items:center; justify-content:center; z-index:9999}
  .modal-content{background:#fff; border:1px solid #eef2f7; box-shadow:var(--shadow); width:96%; max-width:1080px; max-height:92vh; border-radius:16px; display:flex; flex-direction:column; overflow:hidden;}
  .modal-header{display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid var(--line);}
  .modal-title{font-weight:800; font-size:16px; letter-spacing:.02em}
  .modal-actions{display:flex; gap:8px; align-items:center;}
  .btn{border:1px solid var(--line); background:#fff; border-radius:8px; padding:8px 12px; font-size:12px; cursor:pointer}
  .btn.primary{background:var(--accent); color:#fff; border-color:var(--accent)}
  .m-body{flex:1 1 auto; overflow:auto; padding:12px; background:#fafafa;}
  .box{border:1px solid var(--line); border-radius:12px; background:#fff; padding:12px; margin-bottom:10px;}

  /* Shop picker */
  .picker-toolbar{display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:10px;}
  .picker-toolbar input,.picker-toolbar select{border:1px solid var(--line); border-radius:8px; padding:6px 8px; font-size:12px; background:#fff;}
  .grid-shops{display:grid; grid-template-columns:repeat(4,1fr); gap:8px; max-height:60vh; overflow:auto;}
  @media (max-width: 900px){ .grid-shops{grid-template-columns:repeat(2,1fr);} }
  .s-card{border:1px solid var(--line); border-radius:10px; padding:10px; background:#fff; cursor:pointer; transition:box-shadow .15s ease; position:relative;}
  .s-card:hover{box-shadow:var(--shadow)}
  .s-card.disabled{opacity:.45; pointer-events:none;}
  .tag{position:absolute; top:6px; right:6px; font-size:11px; background:#e2e8f0; color:#0f172a; border-radius:999px; padding:2px 6px;}
  .s-name{font-weight:800; font-size:13px; margin-bottom:4px;}
  .s-meta{font-size:12px; color:#475569; display:flex; align-items:center; gap:6px; flex-wrap:wrap;}
  .pill{border-radius:999px; border:1px solid var(--line); padding:2px 6px; font-size:11px; background:#fff;}
  .rank.S{ color:#1e40af; background:#dbeafe; border-color:#bfdbfe; }
  .rank.A{ color:#065f46; background:#d1fae5; border-color:#a7f3d0; }
  .rank.B{ color:#92400e; background:#ffedd5; border-color:#fed7aa; }
  .rank.C{ color:#7c2d12; background:#fee2e2; border-color:#fecaca; }

  /* Request form */
  .form-grid{display:grid; grid-template-columns:160px 1fr 160px 1fr; gap:10px 12px; align-items:center;}
  .ilabel{color:#475569; font-size:12px;}
  .ivalue input,.ivalue select,.ivalue textarea{width:100%; padding:8px; border:1px solid #e5e7eb; border-radius:8px; font-size:12px; background:#fff;}
  .ivalue textarea{height:100px; resize:none}
  .note{font-size:12px; color:#64748b;}
  .mini-list li{margin:0 0 8px 14px; font-size:12.5px;}
  .mini-actions{display:inline-flex; gap:6px; margin-left:8px;}
  .mini-btn{border:1px solid var(--line); background:#fff; border-radius:6px; padding:2px 6px; font-size:11px; cursor:pointer}
  .mini-btn.danger{border-color:#fecaca; background:#fee2e2; color:#7f1d1d;}
/* ===== Global SOS Notifier ===== */
.sos-banner{
  position:fixed; inset:0 0 auto 0; height:64px;
  display:flex; align-items:center; justify-content:center;
  background:linear-gradient(90deg,#7f1d1d,#dc2626,#b91c1c);
  color:#fff; z-index:999999; box-shadow:0 4px 20px rgba(0,0,0,.35);
}
.sos-banner .inner{display:flex; align-items:center; gap:12px; font-weight:900; letter-spacing:.05em;}
.sos-banner .msg{font-size:16px;}
/* æ—¢å­˜ã® .btn ãŒç„¡ã„ãƒšãƒ¼ã‚¸å‘ã‘ã®è»½ã„ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ */
.sos-banner .btn{padding:6px 10px; border-radius:8px; border:1px solid rgba(255,255,255,.6); background:rgba(255,255,255,.12); color:#fff; cursor:pointer;}
.flash{animation:flash 1s infinite alternate ease-in-out;}
@keyframes flash { from {opacity:1; transform:scale(1);} to {opacity:.6; transform:scale(1.02);} }
.shake{animation:shake .5s infinite;}
@keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-3px)} 75%{transform:translateX(3px)} }
</style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="side-logo"><a href="dashboard.html" aria-label="Dashboard Top"><img src="img/logo4.png" alt="LOGO"/></a></div>

    <div class="side-group">
      <div class="side-sec">é‹ç”¨æ©Ÿèƒ½</div>
      <ul class="side-list">
        <li><a href="dashboard.html">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a></li>
        <li><a class="active" href="schedule.html">ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</a></li>
      </ul>
    </div>

    <div class="side-group">
      <div class="side-sec">ç®¡ç†æ©Ÿèƒ½</div>
      <ul class="side-list">
        <li><a href="cast.html">ã‚­ãƒ£ã‚¹ãƒˆç®¡ç†</a></li>
        <li><a href="shops.html">åº—èˆ—ç®¡ç†</a></li>
      </ul>
    </div>

    <div class="side-group">
      <div class="side-sec">é€šä¿¡æ©Ÿèƒ½</div>
      <ul class="side-list">
        <li><a href="chat.html">ãƒãƒ£ãƒƒãƒˆï¼ˆLINEï¼‰</a></li>
        <li><a href="sos.html">SOSã‚¢ãƒ©ãƒ¼ãƒˆ</a></li>
      </ul>
    </div>

    <div class="side-group">
      <div class="side-sec">è¨­å®šæ©Ÿèƒ½</div>
      <ul class="side-list">
        <li><a href="request.html">ç”³è«‹ãƒ»æ‰¿èª</a></li>
        <li><a href="setting.html">è¨­å®š</a></li>
      </ul>
    </div>
  </aside>

  <!-- ===== Global SOS Notifierï¼ˆå…¨ãƒšãƒ¼ã‚¸å…±é€šãƒãƒŠãƒ¼ï¼‰ ===== -->
  <div id="sosBanner" class="sos-banner flash shake" role="alert" aria-live="assertive">
    <div class="inner">
      <span style="font-size:20px;">ğŸš¨ SOS</span>
      <span class="msg" id="sosBannerMsg">ã‚­ãƒ£ã‚¹ãƒˆã‹ã‚‰SOSã‚’å—ä¿¡ï¼è‡³æ€¥ç¢ºèªã—ã¦ãã ã•ã„ï¼</span>
      <button class="btn" id="sosOpenBtn">é–‹ã</button>
      <button class="btn" id="sosMuteBtn">åœæ­¢</button>
    </div>
  </div>

  <!-- Main -->
  <div class="main">
    <header>
      <div class="wrap">
        <div class="head-top">
          <h1 class="title">ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</h1>
          <div></div>
          <div class="head-right">
            <span class="badge"><span class="label">ãƒ­ãƒ¼ãƒ«</span> <span class="role" id="roleBadge">ç®¡ç†è€…</span></span>
            <div class="login">
              <label for="loginSelect" class="label">ãƒ­ã‚°ã‚¤ãƒ³:</label>
              <select id="loginSelect">
                <option value="ADMIN:admin">ç®¡ç†è€…ï¼ˆadminï¼‰</option>
                <option value="STAFF:tanaka">æ‹…å½“è€…ï¼ˆç”°ä¸­ï¼‰</option>
                <option value="STAFF:sato">æ‹…å½“è€…ï¼ˆä½è—¤ï¼‰</option>
                <option value="STAFF:suzuki">æ‹…å½“è€…ï¼ˆéˆ´æœ¨ï¼‰</option>
              </select>
            </div>
            <button class="logout-btn" onclick="location.href='index.html'">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            <button class="print-btn" onclick="window.print()">å°åˆ·</button>
          </div>
        </div>

        <div class="toolbar">
          <div class="counters">
            <div class="counter">æœ¬æ—¥ï¼š<span class="n" id="cntToday">0</span> ä»¶</div>
            <div class="counter">æ˜æ—¥ï¼š<span class="n" id="cntTomorrow">0</span> ä»¶</div>
            <div class="counter">æ˜æ—¥ä»¥é™ï¼š<span class="n" id="cntFuture">0</span> ä»¶</div>
          </div>
          <div class="spacer"></div>
          <button class="btn" id="todayBtn">ä»Šæ—¥ã¸</button>
        </div>
      </div>
    </header>

    <div class="content">
      <div class="panel">
        <div class="cal-head">
          <button class="btn" id="prevBtn">â€¹ å‰æœˆ</button>
          <div class="month" id="monthLabel">0000å¹´ 00æœˆ</div>
          <button class="btn" id="nextBtn">æ¬¡æœˆ â€º</button>
          <div class="spacer"></div>
        </div>
        <div class="cal-grid" id="calGrid"></div>
      </div>
    </div>
  </div>

  <!-- ====== é¸æŠæ—¥ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ« ====== -->
  <div id="dayModal" class="modal" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="dayTitle">
      <div class="modal-header">
        <div class="modal-title" id="dayTitle">ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆyyyy-mm-ddï¼‰</div>
        <div class="modal-actions">
          <button class="btn" onclick="closeDayModal()">é–‰ã˜ã‚‹</button>
          <button class="btn primary" onclick="openPicker()">åº—èˆ—ã‚’ã‚»ãƒƒãƒˆ</button>
        </div>
      </div>
      <div class="m-body">
        <div class="box">
          <div class="ilabel" style="font-weight:700">ç™»éŒ²æ¸ˆã¿ãƒªã‚¯ã‚¨ã‚¹ãƒˆ</div>
          <ul id="reqList" class="mini-list" style="margin:8px 0 0 0; padding:0; list-style:disc inside;"></ul>
          <div id="noReq" class="note">ã“ã®æ—¥ã«ç™»éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã€Œåº—èˆ—ã‚’ã‚»ãƒƒãƒˆã€ã‹ã‚‰ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚</div>
        </div>
        <div class="box">
          <div class="note">â€» ã“ã®ãƒšãƒ¼ã‚¸ã¯ãƒ‡ãƒ¢ã§ã™ã€‚ä¿å­˜ã¯ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¡ãƒ¢ãƒªã®ã¿ã§ã™ã€‚</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ====== åº—èˆ—ãƒ”ãƒƒã‚«ãƒ¼ ====== -->
  <div id="pickerModal" class="modal" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="pickerTitle">
      <div class="modal-header">
        <div class="modal-title" id="pickerTitle">åº—èˆ—ã‚’é¸æŠ</div>
        <div class="modal-actions">
          <button class="btn" onclick="closePicker()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
      </div>
      <div class="m-body" style="background:#fff;">
        <div class="picker-toolbar">
          <input id="shopQuery" type="text" placeholder="åº—åãƒ»IDï¼ˆshop-001ï¼‰ãƒ»ç•ªå·ï¼ˆ001ï¼‰ã§æ¤œç´¢" style="min-width:260px">
          <label class="ilabel">ã‚«ãƒ†ã‚´ãƒª:</label>
          <select id="shopCat">
            <option value="">ï¼ˆã™ã¹ã¦ï¼‰</option>
            <option>ãƒ©ã‚¦ãƒ³ã‚¸</option><option>ã‚¯ãƒ©ãƒ–</option><option>ã‚¬ãƒ¼ãƒ«ã‚ºãƒãƒ¼</option>
          </select>
          <label class="ilabel">ãƒ©ãƒ³ã‚¯:</label>
          <select id="shopRank">
            <option value="">ï¼ˆã™ã¹ã¦ï¼‰</option>
            <option>S</option><option>A</option><option>B</option><option>C</option>
          </select>
          <div class="spacer"></div>
          <div class="note">ã‚¯ãƒªãƒƒã‚¯ã§é¸æŠ â†’ ãƒªã‚¯ã‚¨ã‚¹ãƒˆç™»éŒ²ã¸</div>
        </div>
        <div id="shopGrid" class="grid-shops"></div>
      </div>
    </div>
  </div>

  <!-- ====== ãƒªã‚¯ã‚¨ã‚¹ãƒˆç™»éŒ² ====== -->
  <div id="requestModal" class="modal" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="requestTitle">
      <div class="modal-header">
        <div class="modal-title" id="requestTitle">æ´¾é£ãƒªã‚¯ã‚¨ã‚¹ãƒˆç™»éŒ²</div>
        <div class="modal-actions">
          <button class="btn" onclick="closeRequest()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button class="btn primary" onclick="saveRequest()">ç™»éŒ²</button>
        </div>
      </div>
      <div class="m-body">
        <div class="box">
          <div class="ilabel" style="font-weight:700">åº—èˆ—</div>
          <div id="reqShopInfo" class="note">-</div>
        </div>
        <div class="box">
          <div class="form-grid">
            <div class="ilabel">äººæ•°</div>
            <div class="ivalue"><input id="fCount" type="number" min="1" step="1" placeholder="ä¾‹ï¼‰3"></div>

            <div class="ilabel">å¹´é½¢å±¤</div>
            <div class="ivalue">
              <select id="fAge">
                <option value="">æŒ‡å®šãªã—</option>
                <option>18-20</option><option>20ä»£å‰åŠ</option><option>20ä»£å¾ŒåŠ</option>
                <option>30ä»£ä¸­å¿ƒ</option><option>å¹…åºƒãå¯</option>
              </select>
            </div>

            <div class="ilabel">é£²é…’</div>
            <div class="ivalue">
              <select id="fDrink">
                <option>å•ã‚ãš</option><option>é£²é…’å¿…é ˆ</option><option>é£²é…’ä¸å¯å«ã‚€</option>
              </select>
            </div>

            <div class="ilabel">æ™‚çµ¦ä¸Šé™</div>
            <div class="ivalue"><input id="fWageMax" type="number" step="100" placeholder="ä¾‹ï¼‰4500"></div>

            <div class="ilabel">ã‚¿ãƒˆã‚¥ãƒ¼</div>
            <div class="ivalue">
              <select id="fTattoo">
                <option>å•ã‚ãš</option><option>NG</option><option>éš ã›ã‚Œã°å¯</option>
              </select>
            </div>

            <div class="ilabel">ãã®ä»–ãƒ¡ãƒ¢</div>
            <div class="ivalue" style="grid-column: span 3;">
              <textarea id="fNote" placeholder="ä¾‹ï¼‰é»’æœæŒ‡åå¯ã€ç§æœOKã€çµ‚é›»è€ƒæ…®ãªã©"></textarea>
            </div>
          </div>
        </div>
        <div class="box note">
          å…¥åŠ›ä¾‹ï¼šäººæ•° 3ã€å¹´é½¢å±¤ 20ä»£å‰åŠã€é£²é…’ å¿…é ˆã€æ™‚çµ¦ä¸Šé™ 4500ã€ã‚¿ãƒˆã‚¥ãƒ¼ NGã€‚
        </div>
      </div>
    </div>
  </div>

<script>
/* ========= å®šæ•°ãƒ»ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ========= */
const CATS = ["ãƒ©ã‚¦ãƒ³ã‚¸","ã‚¯ãƒ©ãƒ–","ã‚¬ãƒ¼ãƒ«ã‚ºãƒãƒ¼"];
const RANKS = ["S","A","B","C"];
function pad2(n){return String(n).padStart(2,'0')}
function pad3(n){return String(n).padStart(3,'0')}
function kanaKey(s){ return (s||"").toLowerCase().normalize("NFKC"); }
function fmtYMD(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}` }

/* ========= ãƒ€ãƒŸãƒ¼åº—èˆ— ========= */
const SHOPS = Array.from({length:500}, (_,i)=>{
  const idx = i+1, code = pad3(idx), id = "shop-" + code;
  const cat = CATS[i % CATS.length], rank = RANKS[i % RANKS.length];
  const name = `${cat} ãƒ‡ãƒ¢åº—èˆ— ${pad3(idx)}`, yomi = `ã§ã‚‚ã¦ã‚“ã½ ${pad3(idx)}`;
  const building = ["ã‚¢ãƒ«ã‚«ãƒ‡ã‚£ã‚¢ãƒ“ãƒ«","ç¬¬2é’å±±ãƒ“ãƒ«","ã‚¯ãƒ­ã‚¹ã‚µã‚¤ãƒ‰BLD","è™ãƒé–€ã‚¿ãƒ¯ãƒ¼","æ¾å³¶ä¼šé¤¨"][i%5];
  return {id, code, name, yomi, cat, rank, building};
});

/* ========= çŠ¶æ…‹ ========= */
let state = {
  login:{role:"ADMIN", user:"admin"},
  cal:{year:(new Date()).getFullYear(), month:(new Date()).getMonth()},
  selectedYMD: fmtYMD(new Date()),
  picker:{ q:"", cat:"", rank:"" },
  currentShopId: null,
  requests: {},              // {'YYYY-MM-DD':[ {shopId,...} ]}
  editingIndex: null         // æ—¥åˆ¥é…åˆ—ã®ç·¨é›†å¯¾è±¡ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆæ–°è¦æ™‚ã¯ nullï¼‰
};

/* ========= ãƒ­ã‚°ã‚¤ãƒ³UI ========= */
const loginSelect = document.getElementById('loginSelect');
loginSelect.addEventListener('change', ()=>{
  const [role,user]=loginSelect.value.split(':');
  state.login={role,user};
  document.getElementById('roleBadge').textContent=(role==="ADMIN"?"ç®¡ç†è€…":"æ‹…å½“è€…");
  updateToolbarStats();
});

/* ========= ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”» ========= */
const calGrid = document.getElementById('calGrid');
const monthLabel = document.getElementById('monthLabel');

function buildCalendar(year, month){
  calGrid.innerHTML = "";
  const dows = ["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"];
  for(const w of dows){
    const el = document.createElement('div');
    el.className = 'dow';
    el.textContent = w;
    calGrid.appendChild(el);
  }

  const first = new Date(year, month, 1);
  const startDow = first.getDay();
  const startDate = new Date(year, month, 1-startDow);
  const todayStr = fmtYMD(new Date());
  monthLabel.textContent = `${year}å¹´ ${pad2(month+1)}æœˆ`;

  for(let i=0;i<42;i++){
    const d = new Date(startDate); d.setDate(startDate.getDate()+i);
    const ymd = fmtYMD(d);
    const cell = document.createElement('div');
    cell.className = 'cell' + (d.getMonth()!==month?' other':'') + (ymd===todayStr?' today':'');
    cell.dataset.ymd = ymd;

    const date = document.createElement('div');
    date.className = 'date';
    date.textContent = d.getDate();
    cell.appendChild(date);

    const cnt = (state.requests[ymd]?.length)||0;
    if(cnt>0){
      const b=document.createElement('div'); b.className='badge-req'; b.textContent = `${cnt}ä»¶`; cell.appendChild(b);
      const list=document.createElement('div'); list.className='list-mini';
      list.textContent = state.requests[ymd].slice(0,3).map(x=>{
        const s=SHOPS.find(a=>a.id===x.shopId); return s?s.name:'?';
      }).join(" / ");
      cell.appendChild(list);
    }

    const add = document.createElement('div'); add.className='add'; add.textContent='ï¼‹ è¿½åŠ '; cell.appendChild(add);
    calGrid.appendChild(cell);
  }

  updateToolbarStats();
}

// ã‚¯ãƒªãƒƒã‚¯ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆå§”è­²ï¼‰
calGrid.addEventListener('click', (e)=>{
  const cell = e.target.closest('.cell'); if(!cell) return;
  state.selectedYMD = cell.dataset.ymd;
  openDayModal();
});

document.getElementById('prevBtn').onclick = ()=>{
  const m = new Date(state.cal.year, state.cal.month-1, 1);
  state.cal.year = m.getFullYear(); state.cal.month = m.getMonth();
  buildCalendar(state.cal.year, state.cal.month);
}
document.getElementById('nextBtn').onclick = ()=>{
  const m = new Date(state.cal.year, state.cal.month+1, 1);
  state.cal.year = m.getFullYear(); state.cal.month = m.getMonth();
  buildCalendar(state.cal.year, state.cal.month);
}
document.getElementById('todayBtn').onclick = ()=>{
  const t=new Date();
  state.cal.year=t.getFullYear(); state.cal.month=t.getMonth(); state.selectedYMD=fmtYMD(t);
  buildCalendar(state.cal.year, state.cal.month);
}

/* ========= æ—¥åˆ¥ãƒ¢ãƒ¼ãƒ€ãƒ« ========= */
function openDayModal(){
  document.getElementById('dayTitle').textContent = `ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆ${state.selectedYMD}ï¼‰`;
  const listEl = document.getElementById('reqList');
  const noEl = document.getElementById('noReq');
  const arr = state.requests[state.selectedYMD]||[];
  if(arr.length===0){
    listEl.innerHTML="";
    noEl.style.display='block';
  }else{
    noEl.style.display='none';
    listEl.innerHTML = arr.map((r,i)=>{
      const s=SHOPS.find(x=>x.id===r.shopId);
      const name=s?`${s.name}ï¼ˆ${s.id}/${s.code}ï¼‰`:'?';
      const summary = `äººæ•°:${r.count??'-'} / å¹´é½¢:${r.age||'-'} / é£²é…’:${r.drink||'-'} / ä¸Šé™:${r.wageMax??'-'} / ã‚¿ãƒˆã‚¥ãƒ¼:${r.tattoo||'-'}`;
      return `<li>
        ${name} - ${summary}
        <span class="mini-actions">
          <button class="mini-btn" onclick="editRequest(${i})">ç·¨é›†</button>
          <button class="mini-btn danger" onclick="deleteRequest(${i})">å‰Šé™¤</button>
        </span>
      </li>`;
    }).join('');
  }
  document.getElementById('dayModal').style.display='flex';
}
function closeDayModal(){ document.getElementById('dayModal').style.display='none'; }

/* ========= åº—èˆ—ãƒ”ãƒƒã‚«ãƒ¼ ========= */
function existsForSelectedDay(shopId){
  const arr = state.requests[state.selectedYMD]||[];
  return arr.findIndex(r=>r.shopId===shopId);
}
function openPicker(){
  document.getElementById('shopQuery').value = state.picker.q || "";
  document.getElementById('shopCat').value = state.picker.cat || "";
  document.getElementById('shopRank').value = state.picker.rank || "";
  renderShopGrid();
  document.getElementById('pickerModal').style.display='flex';
}
function closePicker(){ document.getElementById('pickerModal').style.display='none'; }

document.getElementById('shopQuery').addEventListener('input', ()=>{ state.picker.q = document.getElementById('shopQuery').value.trim(); renderShopGrid(); });
document.getElementById('shopCat').addEventListener('change', ()=>{ state.picker.cat = document.getElementById('shopCat').value; renderShopGrid(); });
document.getElementById('shopRank').addEventListener('change', ()=>{ state.picker.rank = document.getElementById('shopRank').value; renderShopGrid(); });

function filteredShops(){
  const q = kanaKey(state.picker.q||"");
  let list = SHOPS.filter(s=>{
    if(state.picker.cat && s.cat!==state.picker.cat) return false;
    if(state.picker.rank && s.rank!==state.picker.rank) return false;
    if(!q) return true;
    const key = kanaKey(`${s.name} ${s.id} ${s.code}`);
    return key.includes(q);
  });
  list.sort((a,b)=> (a.yomi||a.name).localeCompare(b.yomi||b.name,'ja') || a.code.localeCompare(b.code));
  return list;
}
function renderShopGrid(){
  const list = filteredShops();
  const grid = document.getElementById('shopGrid');
  grid.innerHTML = list.map(s=>{
    const idx = existsForSelectedDay(s.id);
    return `
    <div class="s-card ${idx>=0?'disabled':''}" data-id="${s.id}">
      ${idx>=0?'<span class="tag">ç™»éŒ²æ¸ˆ</span>':''}
      <div class="s-name">${s.name}</div>
      <div class="s-meta">
        <span class="pill">ID ${s.id}</span>
        <span class="pill">#${s.code}</span>
        <span class="pill">${s.cat}</span>
        <span class="pill rank ${s.rank}">${s.rank}</span>
        <span class="pill">${s.building}</span>
      </div>
    </div>`;
  }).join('') || `<div class="note">è©²å½“ã™ã‚‹åº—èˆ—ãŒã‚ã‚Šã¾ã›ã‚“</div>`;
}
document.getElementById('shopGrid').addEventListener('click', (e)=>{
  const card = e.target.closest('.s-card'); if(!card) return;
  const id = card.getAttribute('data-id');
  // é‡è¤‡ãƒã‚§ãƒƒã‚¯
  if (existsForSelectedDay(id) >= 0){
    alert("ã“ã®åº—èˆ—ã¯é¸æŠæ—¥ã«ã™ã§ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚æ—¥åˆ¥ä¸€è¦§ã®ã€Œç·¨é›†ã€ã‹ã‚‰å†…å®¹ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚");
    return;
  }
  const shop = SHOPS.find(x=>x.id===id); if(!shop) return;
  state.currentShopId = id;
  state.editingIndex = null; // æ–°è¦
  document.getElementById('reqShopInfo').textContent = `${shop.name}ï¼ˆ${shop.id} / ${shop.code} / ${shop.cat} / ${shop.rank}ï¼‰`;
  closePicker();
  openRequest({preset:null});
});

/* ========= ãƒªã‚¯ã‚¨ã‚¹ãƒˆç™»éŒ²ï¼ˆæ–°è¦/ç·¨é›†ï¼‰ ========= */
function openRequest({preset}={}){
  // preset ãŒã‚ã‚Œã°ã‚»ãƒƒãƒˆã€ç„¡ã‘ã‚Œã°åˆæœŸåŒ–
  document.getElementById('fCount').value   = preset?.count ?? "";
  document.getElementById('fAge').value     = preset?.age   ?? "";
  document.getElementById('fDrink').value   = preset?.drink ?? "å•ã‚ãš";
  document.getElementById('fWageMax').value = preset?.wageMax ?? "";
  document.getElementById('fTattoo').value  = preset?.tattoo ?? "å•ã‚ãš";
  document.getElementById('fNote').value    = preset?.note  ?? "";

  // ãƒœã‚¿ãƒ³è¡¨ç¤ºæ–‡è¨€ï¼ˆç·¨é›†æ™‚ã¯ã€Œæ›´æ–°ã€ï¼‰
  document.querySelector('#requestModal .modal-actions .primary').textContent = (state.editingIndex!=null) ? "æ›´æ–°" : "ç™»éŒ²";

  document.getElementById('requestModal').style.display='flex';
}
function closeRequest(){ document.getElementById('requestModal').style.display='none'; }

function saveRequest(){
  const rec = {
    shopId: state.currentShopId,
    count: Number(document.getElementById('fCount').value)||null,
    age: document.getElementById('fAge').value,
    drink: document.getElementById('fDrink').value,
    wageMax: Number(document.getElementById('fWageMax').value)||null,
    tattoo: document.getElementById('fTattoo').value,
    note: document.getElementById('fNote').value.trim()
  };
  if(!rec.shopId){ alert("åº—èˆ—ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }

  state.requests[state.selectedYMD] = state.requests[state.selectedYMD] || [];

  if(state.editingIndex!=null){
    // ä¸Šæ›¸ãæ›´æ–°
    state.requests[state.selectedYMD][state.editingIndex] = rec;
  }else{
    // æ–°è¦: åŒä¸€åº—èˆ—ãŒæ—¢ã«ã‚ã‚‹ã‹å†ãƒã‚§ãƒƒã‚¯
    if(existsForSelectedDay(rec.shopId) >= 0){
      alert("åŒä¸€åº—èˆ—ã¯åŒæ—¥ã«é‡è¤‡ç™»éŒ²ã§ãã¾ã›ã‚“ã€‚æ—¥åˆ¥ä¸€è¦§ã®ã€Œç·¨é›†ã€ã‹ã‚‰ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚");
      return;
    }
    state.requests[state.selectedYMD].push(rec);
  }

  closeRequest();
  buildCalendar(state.cal.year, state.cal.month);
  openDayModal(); // å†æç”»
}

/* ===== ç·¨é›†ï¼å‰Šé™¤ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ ===== */
function editRequest(index){
  const arr = state.requests[state.selectedYMD]||[];
  const rec = arr[index]; if(!rec) return;
  const shop = SHOPS.find(x=>x.id===rec.shopId);
  state.currentShopId = rec.shopId;
  state.editingIndex = index;
  document.getElementById('reqShopInfo').textContent = shop ? `${shop.name}ï¼ˆ${shop.id} / ${shop.code} / ${shop.cat} / ${shop.rank}ï¼‰` : rec.shopId;
  openRequest({preset:rec});
}
function deleteRequest(index){
  if(!confirm("ã“ã®ç™»éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
  const arr = state.requests[state.selectedYMD]||[];
  if(index>=0 && index<arr.length){
    arr.splice(index,1);
    if(arr.length===0) delete state.requests[state.selectedYMD];
  }
  buildCalendar(state.cal.year, state.cal.month);
  openDayModal();
}

/* ========= ãƒ„ãƒ¼ãƒ«ãƒãƒ¼çµ±è¨ˆ ========= */
function updateToolbarStats(){
  const today = new Date();
  const tomorrow = new Date(today); tomorrow.setDate(today.getDate()+1);
  const todayStr = fmtYMD(today);
  const tomorrowStr = fmtYMD(tomorrow);

  const todayCnt = (state.requests[todayStr]?.length) || 0;
  const tomorrowCnt = (state.requests[tomorrowStr]?.length) || 0;

  let futureCnt = 0;
  for(const ymd in state.requests){
    if(ymd > tomorrowStr){
      futureCnt += state.requests[ymd].length;
    }
  }
  document.getElementById('cntToday').textContent = todayCnt;
  document.getElementById('cntTomorrow').textContent = tomorrowCnt;
  document.getElementById('cntFuture').textContent = futureCnt;
}

/* ========= åˆæœŸåŒ– ========= */
(function init(){
  const [role,user]=loginSelect.value.split(':');
  state.login={role,user};
  document.getElementById('roleBadge').textContent=(role==="ADMIN"?"ç®¡ç†è€…":"æ‹…å½“è€…");

  const t=new Date();
  state.cal.year=t.getFullYear(); state.cal.month=t.getMonth(); state.selectedYMD=fmtYMD(t);
  buildCalendar(state.cal.year, state.cal.month);
})();

/* ===== Global SOS Notifierï¼ˆå…¨ãƒšãƒ¼ã‚¸å…±é€šï¼‰ ===== */
(() => {
  const sosBanner    = document.getElementById('sosBanner');
  const sosBannerMsg = document.getElementById('sosBannerMsg');
  const sosOpenBtn   = document.getElementById('sosOpenBtn');
  const sosMuteBtn   = document.getElementById('sosMuteBtn');

  // --- è¿½åŠ : ãƒŸãƒ¥ãƒ¼ãƒˆã®æ’ä¹…åŒ–ã‚­ãƒ¼ï¼†åˆ¶å¾¡ã‚­ãƒ¼
  const MUTE_KEY = 'sos_muted_v1';
  const CTRL_KEY = 'sos_ctrl_v1';       // {t, cmd:'mute'|'unmute'}
  const CAST_KEY = 'sos_broadcast';     // æ—¢å­˜: SOSå†…å®¹ã®ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆ

  let sosOsc=null, sosCtx=null;

  const isMuted = () => localStorage.getItem(MUTE_KEY) === '1';

  function playSosTone(){
    if (isMuted()) return; // ãƒŸãƒ¥ãƒ¼ãƒˆæ™‚ã¯é³´ã‚‰ã•ãªã„
    try{
      sosCtx = sosCtx || new (window.AudioContext||window.webkitAudioContext)();
      const osc = sosCtx.createOscillator();
      const gain = sosCtx.createGain();
      osc.frequency.value = 880;
      osc.type = "square";
      gain.gain.value = 0.05;
      osc.connect(gain).connect(sosCtx.destination);
      osc.start();
      sosOsc = osc;
    }catch(e){}
  }
  function stopSosTone(){
    try{ if(sosOsc){ sosOsc.stop(); sosOsc.disconnect(); sosOsc=null; } }catch(e){}
  }

  function showSosBanner(payload){
    if (isMuted()) return; // ãƒŸãƒ¥ãƒ¼ãƒˆä¸­ã¯å‡ºã•ãªã„
    const ownerName = payload?.ownerName || payload?.owner || '';
    const castName  = payload?.cast || 'ã‚­ãƒ£ã‚¹ãƒˆ';
    sosBannerMsg.textContent = `ğŸš¨ ${castName} ã•ã‚“ãŒSOSç™ºå ±ï¼ˆæ‹…å½“: ${ownerName}ï¼‰`;
    sosBanner.style.display='flex';
    playSosTone();
  }
  function hideSosBanner(){
    sosBanner.style.display='none';
    stopSosTone();
  }

  // ---- ãƒŸãƒ¥ãƒ¼ãƒˆï¼ã‚¢ãƒ³ãƒŸãƒ¥ãƒ¼ãƒˆï¼ˆå…¨ãƒšãƒ¼ã‚¸å³æ™‚åŒæœŸï¼‰
  function muteSOS(){
    localStorage.setItem(MUTE_KEY, '1');   // æ°¸ç¶šãƒŸãƒ¥ãƒ¼ãƒˆ
    hideSosBanner();
    // ä»–ã‚¿ãƒ–ãƒ»ä»–ãƒšãƒ¼ã‚¸ã¸åˆ¶å¾¡ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆ
    localStorage.setItem(CTRL_KEY, JSON.stringify({ t: Date.now(), cmd:'mute' }));
  }
  function unmuteSOS(){
    localStorage.removeItem(MUTE_KEY);
    localStorage.setItem(CTRL_KEY, JSON.stringify({ t: Date.now(), cmd:'unmute' }));
  }

  // ãƒœã‚¿ãƒ³
  sosOpenBtn?.addEventListener('click', () => {
    hideSosBanner();
    try{ window.location.href = 'sos.html'; }catch(e){}
  });
  sosMuteBtn?.addEventListener('click', muteSOS);

  // ä»–ã‚¿ãƒ–ã‹ã‚‰ã®é€šçŸ¥ï¼†åˆ¶å¾¡ã‚’å—ä¿¡
  window.addEventListener('storage', (e)=>{
    if (e.key === CAST_KEY && e.newValue){
      // SOSå—ä¿¡ï¼ˆãŸã ã—ãƒŸãƒ¥ãƒ¼ãƒˆä¸­ã¯ç„¡è¦–ï¼‰
      if (isMuted()) return;
      try{ showSosBanner(JSON.parse(e.newValue)); }catch(_) {}
    }
    if (e.key === CTRL_KEY && e.newValue){
      // ãƒŸãƒ¥ãƒ¼ãƒˆåˆ¶å¾¡åŒæœŸ
      try{
        const msg = JSON.parse(e.newValue);
        if (msg.cmd === 'mute'){ hideSosBanner(); }
        // 'unmute' ã¯ãƒãƒŠãƒ¼ã‚’å³è¡¨ç¤ºã—ãªã„ï¼ˆæ¬¡ã® SOS ã‚’å¾…ã¤æƒ³å®šï¼‰
      }catch(_){}
    }
  });

  // å…¬é–‹API
  /** å…¨ã‚¿ãƒ–ã¸SOSé…ä¿¡ï¼ˆåŒã‚¿ãƒ–ã‚‚å³æ™‚è¡¨ç¤ºï¼‰ */
  window.broadcastSOS = function(payload){
    localStorage.setItem(CAST_KEY, JSON.stringify(payload || {}));
    if (!isMuted()) showSosBanner(payload || {});
  };
  /** æ˜ç¤ºçš„ã«è¡¨ç¤ºï¼ˆãƒŸãƒ¥ãƒ¼ãƒˆä¸­ã¯å‡ºãªã„ï¼‰ */
  window.showSosBanner = showSosBanner;
  /** ãƒŸãƒ¥ãƒ¼ãƒˆ/è§£é™¤APIï¼ˆä»»æ„ãƒšãƒ¼ã‚¸ã§åˆ©ç”¨å¯ï¼‰ */
  window.muteSOS = muteSOS;
  window.unmuteSOS = unmuteSOS;

  // åˆæœŸçŠ¶æ…‹ï¼šãƒŸãƒ¥ãƒ¼ãƒˆãªã‚‰ç¢ºå®Ÿã«éè¡¨ç¤ºåŒ–
  if (isMuted()) hideSosBanner();
})();
</script>
</body>
</html>
